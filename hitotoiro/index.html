<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒ’ãƒˆãƒˆã‚¤ãƒ­ Online Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap');
        body { font-family: 'Zen Maru Gothic', sans-serif; touch-action: manipulation; background-color: #f8fafc; }
        .color-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="p-4 text-slate-800">

    <div id="app" class="max-w-md mx-auto text-center pb-28">
        <header class="mb-6 pt-2">
            <h1 class="text-4xl font-black text-slate-800 italic tracking-tighter leading-none">ãƒ’ãƒˆãƒˆã‚¤ãƒ­</h1>
            <div id="room-status-display" class="text-[10px] font-bold text-blue-500 mt-2 tracking-widest bg-blue-50 inline-block px-3 py-1 rounded-full uppercase">Waiting...</div>
        </header>
        
        <div id="game-content" class="min-h-[400px]"></div>

        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-xs px-4">
            <button onclick="forceResetRoom()" class="w-full bg-white/90 backdrop-blur border border-red-200 text-red-500 py-3 rounded-2xl text-[11px] font-black uppercase tracking-widest shadow-md active:scale-95 transition-all">
                éƒ¨å±‹ã‚’ãƒªã‚»ãƒƒãƒˆ (æœ€åˆã‹ã‚‰)
            </button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBmzPmehSaV--mn0Hd0S-fd97nf5RX4Dvg",
            authDomain: "membertoiro.firebaseapp.com",
            databaseURL: "https://membertoiro-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "membertoiro",
            storageBucket: "membertoiro.firebasestorage.app",
            messagingSenderId: "858132874746",
            appId: "1:858132874746:web:9d6e1156a350dd396b9043"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const COLORS = [
            { id: 'red', name: 'ã‚ã‹', code: '#ef4444', text: 'white' },
            { id: 'pink', name: 'ã‚‚ã‚‚ã„ã‚', code: '#f472b6', text: 'white' },
            { id: 'orange', name: 'ã ã„ã ã„', code: '#fb923c', text: 'white' },
            { id: 'yellow', name: 'ãã„ã‚', code: '#facc15', text: 'black' },
            { id: 'lime', name: 'ãã¿ã©ã‚Š', code: '#a3e635', text: 'black' },
            { id: 'green', name: 'ã¿ã©ã‚Š', code: '#22c55e', text: 'white' },
            { id: 'cyan', name: 'ã¿ãšã„ã‚', code: '#22d3ee', text: 'black' },
            { id: 'blue', name: 'ã‚ãŠ', code: '#3b82f6', text: 'white' },
            { id: 'purple', name: 'ã‚€ã‚‰ã•ã', code: '#a855f7', text: 'white' },
            { id: 'brown', name: 'ã¡ã‚ƒã„ã‚', code: '#78350f', text: 'white' },
            { id: 'white', name: 'ã—ã‚', code: '#ffffff', text: 'black' },
            { id: 'black', name: 'ãã‚', code: '#000000', text: 'white' },
            { id: 'gray', name: 'ã¯ã„ã„ã‚', code: '#64748b', text: 'white' },
            { id: 'gold', name: 'ãã‚“', code: '#d4af37', text: 'white' },
            { id: 'silver', name: 'ãã‚“', code: '#c0c0c0', text: 'black' }
        ];

        const MASTER_THEMES = {
            'easy': ["ãŸã¹ã‚‚ã®", "ãã ã‚‚ã®", "ã©ã†ã¶ã¤", "ã®ã¿ã‚‚ã®", "ãŠã‚‚ã¡ã‚ƒ", "ã‹ã‚‰ã ã®ä¸€éƒ¨", "ã—ãœã‚“", "ã¶ã‚“ã¼ã†ã", "é‡èœ", "å¤©æ°—", "ä¹—ã‚Šç‰©", "ãŠã‹ã—", "ã‚€ã—", "ãŠèŠ±", "ã†ã¿ã®ç”Ÿãç‰©", "ãƒ‘ãƒ³", "ãƒ‡ã‚¶ãƒ¼ãƒˆ", "ã™ã†ã˜", "ã‚­ãƒƒãƒãƒ³ç”¨å“", "ãŠãµã‚ã«ã‚ã‚‹ã‚‚ã®", "å­¦æ ¡ã«ã‚ã‚‹ã‚‚ã®", "å…¬åœ’ã«ã‚ã‚‹ã‚‚ã®", "éººé¡", "ã™ã—ãƒã‚¿", "ã‚³ãƒ³ãƒ“ãƒ‹", "å›½", "å­£ç¯€", "ä¸¸ã„ã‚‚ã®", "å®¶ã«ã‚ã‚‹ã‚‚ã®", "ãƒã‚±ãƒ¢ãƒ³"],
            'normal': ["ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼", "å®¶é›»", "ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼", "éŸ³æ¥½", "ã‚¹ãƒãƒ¼ãƒ„", "æœ", "å ´æ‰€", "å»ºç‰©", "æ¥½å™¨", "å®¶å…·", "ã‚¢ãƒ‹ãƒ¡", "ãƒãƒ³ã‚¬", "æ˜ ç”»", "è·æ¥­", "å†¬ã¨ã„ãˆã°", "å¤ã¨ã„ãˆã°", "æ˜¥ã¨ã„ãˆã°", "ç§‹ã¨ã„ãˆã°", "éŠåœ’åœ°", "æ—¥æœ¬ã®éƒ½é“åºœçœŒ", "æœ‰åãªå±±", "ã‚«ãƒãƒ³ã®ä¸­èº«", "é´", "å¸½å­", "ã‚¹ã‚¤ãƒ¼ãƒ„", "é§…ã«ã‚ã‚‹ã‚‚ã®", "æœ‰åäºº", "ä¸­è¯æ–™ç†", "è¥¿æ´‹æ–™ç†", "æ˜Ÿåº§", "èª¿å‘³æ–™", "ãƒ–ãƒ©ãƒ³ãƒ‰å", "ã‚²ãƒ¼ãƒ ã‚­ãƒ£ãƒ©"],
            'hard': ["æ„Ÿæƒ…", "éŸ³", "æŠ½è±¡ç”»", "æ›œæ—¥", "æ™‚ä»£", "å››å­—ç†Ÿèª", "ã“ã¨ã‚ã–", "ã«ãŠã„", "å‘³", "æ„Ÿè§¦", "é­”æ³•", "å®‡å®™", "æœªæ¥", "éå»", "å¤¢", "å¹¸ã›ãªã“ã¨", "æ‚²ã—ã„ã“ã¨", "æ¼¢å­—", "ãƒ‰ã‚­ãƒ‰ã‚­ã™ã‚‹ã‚‚ã®", "é™ã‹ãªå ´æ‰€", "ã†ã‚‹ã•ã„éŸ³", "å®ç‰©", "ç§˜å¯†", "ä¼èª¬", "ãƒ©ã‚¤ãƒãƒ«", "æ—¥æœ¬æ–™ç†", "æ–¹è§’", "æœˆ", "ã‚ªãƒªãƒ³ãƒ”ãƒƒã‚¯ç¨®ç›®", "ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒª", "ã‚¹ãƒãƒ¼ãƒ„ãƒãƒ¼ãƒ ", "æ˜”è©±"]
        };

        let currentRoomId = localStorage.getItem("toiro-room-id") || "";
        let myName = localStorage.getItem("toiro-name") || "";
        let myRole = localStorage.getItem("toiro-role") || ""; 
        let gameState = null;
        let selectedColor = null;

        if (currentRoomId) connectToRoom(currentRoomId);
        else render();

        function connectToRoom(id) {
            currentRoomId = id;
            localStorage.setItem("toiro-room-id", id);
            db.ref("rooms/" + id).on("value", (snapshot) => {
                const data = snapshot.val();
                if (!data) { gameState = null; render(); return; }
                gameState = data;
                document.getElementById('room-status-display').innerText = "ROOM: " + id;
                render();
            });
        }

        function handleJoin(role) {
            const r = document.getElementById('room-input')?.value.trim();
            const n = document.getElementById('name-input')?.value.trim();
            if (!r || !n) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
            myName = n; myRole = role;
            localStorage.setItem("toiro-name", n);
            localStorage.setItem("toiro-role", role);
            connectToRoom(r);
            db.ref("rooms/" + r).transaction((curr) => {
                if (!curr) return { phase: 'setup', members: [n], host: (role === 'host' ? n : "") };
                if (!curr.members) curr.members = [];
                if (!curr.members.includes(n)) curr.members.push(n);
                return curr;
            });
        }

        function getRandomTheme(levels) {
            const pool = levels.flatMap(lvl => MASTER_THEMES[lvl]);
            return pool[Math.floor(Math.random() * pool.length)];
        }

        function startGame() {
            const dealCount = parseInt(document.getElementById('card-count-select')?.value) || 10;
            const mode = document.getElementById('mode-select')?.value || 'ã»ã‚“ã°ã‚“';
            
            let themes = [];
            for(let i=0; i<5; i++) {
                let lv = ['easy', 'normal', 'hard'];
                if (mode === 'ã‚Œã‚“ã—ã‚…ã†') lv = ['easy'];
                else if (mode === 'ã»ã‚“ã°ã‚“') {
                    if (i === 0) lv = ['easy'];
                    else if (i === 1) lv = ['easy', 'normal'];
                    else if (i === 2) lv = ['normal'];
                    else if (i === 3) lv = ['normal', 'hard'];
                    else lv = ['hard'];
                }
                themes.push({ text: getRandomTheme(lv), level: lv });
            }

            const commonHand = [...COLORS].sort(() => 0.5 - Math.random()).slice(0, dealCount).map(c => c.id);

            db.ref("rooms/" + currentRoomId).update({
                phase: 'playing', themes: themes, currentRound: 0, answers: {}, revealIdx: -1,
                commonHand: commonHand, gameMode: mode
            });
        }

        function confirmAnswer() {
            if (!selectedColor) return;
            const round = gameState.currentRound;
            db.ref(`rooms/${currentRoomId}/answers/${round}/${myName}`).set(selectedColor).then(() => {
                selectedColor = null;
                db.ref(`rooms/${currentRoomId}`).transaction((curr) => {
                    if (!curr) return curr;
                    const ans = (curr.answers && curr.answers[round]) || {};
                    if (Object.keys(ans).length === curr.members.length) {
                        if (round < 4) curr.currentRound = round + 1;
                        else curr.phase = 'revealing';
                    }
                    return curr;
                });
            });
        }

        function forceResetRoom() {
            if (!currentRoomId) return;
            if (confirm("éƒ¨å±‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
                db.ref("rooms/" + currentRoomId).remove().then(() => {
                    localStorage.removeItem("toiro-room-id");
                    location.reload();
                });
            }
        }

        function animateCountUp(target) {
            const el = document.getElementById('count-up-score');
            if (!el) return;
            let current = 0;
            const duration = 1500;
            const start = performance.now();
            const step = (timestamp) => {
                const progress = Math.min((timestamp - start) / duration, 1);
                current = Math.floor(progress * target);
                el.innerText = current;
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function render() {
            const container = document.getElementById('game-content');
            if (!currentRoomId || !myName || !gameState) {
                container.innerHTML = `<div class="bg-white p-8 rounded-[2.5rem] shadow-xl fade-in text-left border border-slate-100"><div class="mb-4"><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-2 uppercase">Room ID</label><input id="room-input" type="text" value="toiro-party" class="w-full border-2 p-4 rounded-2xl font-bold"></div><div class="mb-8"><label class="block text-[10px] font-bold text-slate-400 mb-1 ml-2 uppercase">Name</label><input id="name-input" type="text" value="${myName}" class="w-full border-2 p-4 rounded-2xl font-bold"></div><button onclick="handleJoin('host')" class="w-full bg-slate-800 text-white h-16 rounded-2xl font-bold mb-3">ãƒ›ã‚¹ãƒˆã¨ã—ã¦é–‹å§‹</button><button onclick="handleJoin('guest')" class="w-full bg-white border-2 border-slate-800 text-slate-800 h-16 rounded-2xl font-bold">å‚åŠ ã™ã‚‹</button></div>`;
                return;
            }

            if (gameState.phase === 'setup') {
                container.innerHTML = `
                <div class="bg-white p-8 rounded-[2.5rem] shadow-xl fade-in border border-slate-100">
                    <p class="text-xs font-bold text-slate-400 mb-6 uppercase tracking-widest">å¾…æ©Ÿä¸­ (${(gameState.members || []).length}äºº)</p>
                    <div class="grid grid-cols-2 gap-2 mb-8">${gameState.members.map(m => `<div class="bg-slate-50 p-2 rounded-xl font-bold text-slate-600 text-[10px] border border-slate-100 truncate italic">ğŸ‘¤ ${m}</div>`).join('')}</div>
                    ${myRole === 'host' ? `
                        <div class="bg-blue-50/50 p-5 rounded-3xl mb-6 text-left border border-blue-100">
                            <label class="block text-[10px] font-black text-blue-400 mb-3 uppercase tracking-tighter">Game Settings</label>
                            <div class="space-y-4 mb-6">
                                <div>
                                    <span class="text-[10px] font-bold text-slate-400 ml-1">ã‚«ãƒ¼ãƒ‰æšæ•°</span>
                                    <select id="card-count-select" class="w-full p-3 rounded-xl font-bold text-sm bg-white border-none shadow-sm">
                                        <option value="5">5æš</option><option value="8">8æš</option><option value="10" selected>10æš</option><option value="12">12æš</option><option value="15">15æš</option>
                                    </select>
                                </div>
                                <div>
                                    <span class="text-[10px] font-bold text-slate-400 ml-1">é›£æ˜“åº¦ãƒ¢ãƒ¼ãƒ‰</span>
                                    <select id="mode-select" class="w-full p-3 rounded-xl font-bold text-sm bg-white border-none shadow-sm">
                                        <option value="ã‚Œã‚“ã—ã‚…ã†">ã‚Œã‚“ã—ã‚…ã† (Easyã®ã¿)</option>
                                        <option value="ã»ã‚“ã°ã‚“" selected>ã»ã‚“ã°ã‚“ (å¾ã€…ã«é›£åŒ–)</option>
                                        <option value="ãƒ©ãƒ³ãƒ€ãƒ ">ãƒ©ãƒ³ãƒ€ãƒ  (å…¨é›£æ˜“åº¦æ··åœ¨)</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="startGame()" class="w-full bg-blue-500 text-white h-16 rounded-2xl text-xl font-black shadow-lg">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
                        </div>` : `<p class="animate-pulse text-slate-400 font-bold">ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…æ©Ÿä¸­...</p>`}
                </div>`;
                return;
            }

            if (gameState.phase === 'playing') {
                const round = gameState.currentRound;
                const theme = gameState.themes[round].text;
                const alreadyAnswered = gameState.answers?.[round]?.[myName];
                if (alreadyAnswered) {
                    container.innerHTML = `<div class="bg-white p-12 rounded-[2.5rem] shadow-xl border border-slate-100 fade-in"><div class="w-16 h-16 mx-auto rounded-2xl shadow-inner mb-4" style="background-color: ${COLORS.find(c => c.id === alreadyAnswered).code}"></div><p class="text-slate-400 font-bold text-sm">å›ç­”å®Œäº†ï¼å¾…æ©Ÿä¸­...<br><span class="text-blue-500 text-2xl font-black">${Object.keys(gameState.answers[round]).length} / ${gameState.members.length}</span></p></div>`;
                } else {
                    const myUsed = [];
                    for(let i=0; i<round; i++) { if(gameState.answers?.[i]?.[myName]) myUsed.push(gameState.answers[i][myName]); }
                    const currentHand = gameState.commonHand.filter(cid => !myUsed.includes(cid));
                    const selObj = selectedColor ? COLORS.find(c => c.id === selectedColor) : null;
                    container.innerHTML = `<div class="fade-in"><div class="mb-4 text-[10px] font-black text-slate-300 tracking-[0.3em] uppercase">${gameState.gameMode} ROUND ${round + 1} / 5</div><h2 class="text-4xl font-black text-slate-800 mb-8 italic tracking-tight">ã€Œ${theme}ã€</h2><div class="color-grid mb-8">${currentHand.map(cid => { const c = COLORS.find(x => x.id === cid); return `<button onclick="selectedColor='${c.id}';render();" style="background-color: ${c.code}; color: ${c.text}" class="h-20 rounded-2xl font-bold shadow-md ring-4 ${selectedColor === cid ? 'ring-blue-500 scale-105 shadow-blue-100' : 'ring-transparent'} border-b-4 border-black/10 transition-all text-xs">${c.name}</button>`; }).join('')}</div><div class="h-24">${selObj ? `<button onclick="confirmAnswer()" style="background-color: ${selObj.code}; color: ${selObj.text}" class="w-full h-20 rounded-3xl text-xl font-black shadow-xl animate-bounce border-4 border-black/10">ã€ ${selObj.name} ã€‘ã§æ±ºå®šï¼</button>` : `<p class="text-slate-400 font-bold text-sm italic">è‰²ã‚’é¸ã‚“ã§ãã ã•ã„</p>`}</div></div>`;
                }
            }

            else if (gameState.phase === 'revealing') {
                const idx = gameState.revealIdx;
                const memberCount = gameState.members.length;
                let resultsHtml = "";
                for(let r=0; r < 5; r++) {
                    const isRevealed = r <= idx;
                    const ans = (gameState.answers && gameState.answers[r]) || {};
                    const colorValues = Object.values(ans);
                    const isMatch = colorValues.length > 0 && colorValues.length === gameState.members.length && colorValues.every(v => v === colorValues[0]);
                    const chipSize = memberCount <= 6 ? 'w-12 h-12' : 'w-9 h-9';
                    resultsHtml += `
                    <div class="bg-white p-5 rounded-[2.5rem] mb-4 shadow-sm border transition-all duration-500 ${isRevealed ? (isMatch ? 'border-green-400 ring-4 ring-green-50' : 'border-slate-100') : 'opacity-40 grayscale'}">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm font-black text-slate-600 uppercase italic">RD ${r+1}: ${gameState.themes[r].text}</span>
                            ${isRevealed && isMatch ? '<span class="text-xs font-black text-green-500 animate-pulse">MATCH!</span>' : ''}
                        </div>
                        ${isRevealed ? `<div class="flex flex-wrap gap-2 justify-center fade-in">${Object.entries(ans).map(([name, cid]) => `<div class="flex flex-col items-center"><div class="${chipSize} rounded-xl shadow-inner ring-1 ring-slate-200" style="background-color:${COLORS.find(x=>x.id===cid).code}"></div><div class="text-[8px] font-bold text-slate-500 truncate w-12 mt-1 text-center">${name}</div></div>`).join('')}</div>` : `<div class="h-10 flex items-center justify-center text-xs text-slate-400 font-black tracking-[0.5em] uppercase">ï¼Ÿï¼Ÿï¼Ÿ</div>`}
                    </div>`;
                }
                container.innerHTML = `<div class="fade-in no-scrollbar"><h2 class="text-[10px] font-black mb-4 text-slate-400 uppercase tracking-widest italic">Result Reveal</h2><div class="max-h-[60vh] overflow-y-auto no-scrollbar pb-4">${resultsHtml}</div><div class="mt-4">${myRole === 'host' ? (idx < 4 ? `<button onclick="db.ref('rooms/'+currentRoomId).update({revealIdx:${idx+1}})" class="w-full bg-slate-800 text-white h-16 rounded-2xl font-bold shadow-xl">æ¬¡ã®çµæœã‚’å…¬é–‹ (${idx+2}/5)</button>` : `<button onclick="db.ref('rooms/'+currentRoomId).update({phase:'result'})" class="w-full bg-green-500 text-white h-16 rounded-2xl font-bold shadow-xl">æœ€çµ‚ã‚¹ã‚³ã‚¢ç™ºè¡¨ï¼</button>`) : `<p class="p-4 text-xs font-bold text-slate-400 animate-pulse italic">ãƒ›ã‚¹ãƒˆãŒå…¬é–‹ä¸­...</p>`}</div></div>`;
            }

            else if (gameState.phase === 'result') {
                let matchCount = 0;
                for(let r=0; r<5; r++){
                    const ans = Object.values((gameState.answers && gameState.answers[r]) || {});
                    if(ans.length > 0 && ans.length === gameState.members.length && ans.every(v => v === ans[0])) matchCount++;
                }
                const score = (matchCount / 5) * 100;
                container.innerHTML = `<div class="fade-in text-center"><p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em] mb-2">Group Sync Rate</p><h2 class="text-8xl font-black text-slate-800 mb-6 italic tracking-tighter"><span id="count-up-score">0</span><small class="text-3xl">%</small></h2><div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 mb-8 overflow-hidden relative"><div class="relative z-10"><div class="text-[10px] font-bold text-blue-500 mb-2 uppercase italic tracking-widest">Final Rank</div><div class="text-2xl font-black text-slate-800 mb-4">${score === 100 ? "å¥‡è·¡ã®ã‚·ãƒ³ã‚¯ãƒ­ï¼" : score >= 60 ? "æœ€å¼·ã®çµ†ï¼" : "ä¼¸ã³ã—ã‚ãŸã£ã·ã‚Šï¼"}</div><p class="text-xs text-slate-400 font-bold tracking-tight">${matchCount} / 5 ãƒ©ã‚¦ãƒ³ãƒ‰ä¸€è‡´ï¼</p></div><div class="absolute bottom-0 left-0 h-1 bg-blue-500 transition-all duration-1000 shadow-[0_0_10px_rgba(59,130,246,0.4)]" style="width:${score}%"></div></div>${myRole === 'host' ? `<button onclick="startGame()" class="w-full bg-slate-800 text-white h-16 rounded-2xl font-bold shadow-xl">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>` : ``}</div>`;
                setTimeout(() => animateCountUp(score), 100);
            }
        }
    </script>
</body>
</html>
