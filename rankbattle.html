<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANK BATTLE</title>
    <style>
        * {
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            font-size: clamp(2rem, 6vw, 4rem);
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            background: linear-gradient(45deg, #f39c12, #e67e22, #d35400);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            letter-spacing: 3px;
        }

        .subtitle {
            font-size: clamp(0.9rem, 2vw, 1.2rem);
            color: #bdc3c7;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .screen {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: clamp(15px, 3vw, 30px);
            backdrop-filter: blur(10px);
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .game-info {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            font-weight: bold;
            font-size: clamp(14px, 3vw, 18px);
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.4);
        }

        .player-indicator {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-weight: bold;
            font-size: clamp(16px, 3vw, 20px);
            padding: 12px 25px;
            border-radius: 20px;
            margin: 10px 0;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.4);
        }

        .score-display {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-weight: bold;
            font-size: clamp(18px, 4vw, 24px);
            padding: 15px;
            border-radius: 20px;
            margin: 15px 0;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.4);
        }

        .win-tracker {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
        }

        .win-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }

        .win-dot.win {
            background: #2ecc71;
            border-color: #2ecc71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.6);
        }

        .win-dot.loss {
            background: #e74c3c;
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.6);
        }

        .win-dot.draw {
            background: #f39c12;
            border-color: #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.6);
        }

        .status-indicator {
            padding: 8px 16px;
            border-radius: 15px;
            font-weight: bold;
            margin: 10px;
            display: inline-block;
        }

        .status-waiting {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .status-ready {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .round-counter {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            font-weight: bold;
            font-size: clamp(16px, 3vw, 20px);
            padding: 10px 20px;
            border-radius: 25px;
            margin: 10px 0;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.4);
        }

        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 400px;
        }

        .player-area {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: clamp(10px, 2vw, 20px);
            backdrop-filter: blur(10px);
            transition: all 0.5s ease;
            position: relative;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .player-area.current-player {
            border: 3px solid #f39c12;
            box-shadow: 0 0 25px rgba(243, 156, 18, 0.4);
        }

        .player-area.waiting {
            opacity: 0.7;
            transform: scale(0.98);
        }

        .player-area.ready {
            border: 3px solid #2ecc71;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.4);
        }

        .crystal-status {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            transition: all 0.3s ease;
        }

        .crystal-status.available {
            animation: sparkle 2s infinite;
            filter: drop-shadow(0 0 10px #3498db);
        }

        .crystal-status.used {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.15) rotate(180deg); }
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .cards {
            display: flex;
            justify-content: center;
            gap: clamp(5px, 1.5vw, 10px);
            flex-wrap: wrap;
            min-height: clamp(80px, 15vw, 120px);
        }

        .card {
            width: clamp(70px, 14vw, 90px);
            height: clamp(90px, 18vw, 120px);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid rgba(255,255,255,0.2);
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: relative;
            touch-action: manipulation;
            user-select: none;
            font-weight: bold;
        }

        .card:hover, .card:active {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }

        .card.selected {
            border-color: #f39c12;
            transform: translateY(-10px) scale(1.1);
            box-shadow: 0 15px 30px rgba(243, 156, 18, 0.6);
        }

        .card.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .card-icon {
            font-size: clamp(28px, 8vw, 42px);
            margin-bottom: 5px;
        }

        .card-name {
            font-size: clamp(10px, 2vw, 12px);
            text-align: center;
            line-height: 1.2;
        }

        .card-rank {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* å½¹è·åˆ¥ã‚«ãƒ¼ãƒ‰è‰² */
        .card.slave { 
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            border-color: rgba(127, 140, 141, 0.7);
        }
        .card.citizen { 
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-color: rgba(52, 152, 219, 0.7);
        }
        .card.soldier { 
            background: linear-gradient(135deg, #e67e22, #d35400);
            border-color: rgba(230, 126, 34, 0.7);
        }
        .card.general { 
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-color: rgba(155, 89, 182, 0.7);
        }
        .card.emperor { 
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border-color: rgba(241, 196, 15, 0.7);
        }

        .battle-area {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: clamp(15px, 3vw, 30px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: relative;
            flex-wrap: wrap;
            gap: 10px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .selected-card {
            width: clamp(90px, 18vw, 130px);
            height: clamp(120px, 24vw, 170px);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            border: 4px solid #f39c12;
            font-weight: bold;
            position: relative;
        }

        .selected-card.hidden-card {
            background: linear-gradient(135deg, #34495e, #2c3e50) !important;
            border: 4px solid #7f8c8d;
        }

        .selected-card.hidden-card::after {
            content: '?';
            font-size: clamp(40px, 10vw, 60px);
            color: #bdc3c7;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .selected-card-icon {
            font-size: clamp(35px, 10vw, 50px);
            margin-bottom: 8px;
        }

        .selected-card-name {
            font-size: clamp(12px, 3vw, 16px);
            text-align: center;
        }

        .vs {
            font-size: clamp(28px, 8vw, 40px);
            font-weight: bold;
            color: #f39c12;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            text-transform: uppercase;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: clamp(10px, 2vw, 15px) clamp(20px, 4vw, 30px);
            font-size: clamp(14px, 3vw, 18px);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
            user-select: none;
            min-height: 48px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-crystal {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            position: relative;
        }

        .btn-crystal::before {
            content: 'ğŸ’';
            margin-right: 8px;
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result {
            margin: 20px 0;
            font-size: clamp(18px, 5vw, 28px);
            font-weight: bold;
            min-height: 60px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 15px;
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result.win {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            animation: celebrateWin 0.6s ease-out;
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6);
        }

        .result.loss {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            animation: showLoss 0.6s ease-out;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.6);
        }

        .result.draw {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            animation: showDraw 0.6s ease-out;
            box-shadow: 0 0 30px rgba(243, 156, 18, 0.6);
        }

        @keyframes celebrateWin {
            0% { transform: scale(0.8) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes showLoss {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes showDraw {
            0% { transform: translateY(-10px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .url-display {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .url-input {
            width: 100%;
            max-width: 500px;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 14px;
            margin: 10px 0;
            text-align: center;
        }

        .url-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .mobile-warning {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: clamp(12px, 3vw, 14px);
            border: 2px solid rgba(255, 107, 107, 0.3);
        }

        .mobile-warning h4 {
            margin: 0 0 8px 0;
            color: #ffd700;
        }

        .reconnect-status {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
            animation: pulse 2s infinite;
        }

        .rules-display {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            font-size: clamp(12px, 2.5vw, 14px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .rules-display h4 {
            color: #f39c12;
            margin-top: 0;
            text-align: center;
        }

        .hidden { display: none; }

        @media (max-width: 768px) {
            body { padding: 5px; }
            .cards { gap: 5px; }
            .battle-area { flex-direction: column; gap: 15px; }
            h1 { letter-spacing: 1px; }
        }

        @media (max-width: 480px) {
            .player-info { flex-direction: column; gap: 8px; }
            .controls { gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>RANK BATTLE</h1>
        <div class="subtitle">éšç´šã¨é©å‘½ã®ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ </div>
        
        <!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
        <div class="screen" id="setup-screen">
            <h2>âš”ï¸ æˆ¦å ´ã¸ã‚ˆã†ã“ã</h2>
            
            <div class="rules-display">
                <h4>ğŸ“‹ ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«</h4>
                <p><strong>ğŸ¯ ç›®æ¨™:</strong> å…ˆã«4å‹ã—ãŸæ–¹ã®å‹åˆ©ï¼</p>
                <p><strong>ğŸ´ æ‰‹æœ­:</strong> å¥´éš·(0)Ã—1, å¸‚æ°‘(1)Ã—2, å…µå£«(2)Ã—2, å°†è»(3)Ã—1, çš‡å¸(4)Ã—1</p>
                <p><strong>âš¡ ç‰¹æ®Š:</strong> å¥´éš·ã¯çš‡å¸ã«ã€Œåé€†ã€ã§å‹åˆ©ï¼</p>
                <p><strong>ğŸ’ ã‚¯ãƒªã‚¹ã‚¿ãƒ«:</strong> 1å›ã ã‘ã‚«ãƒ¼ãƒ‰ã‚’1ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—ï¼</p>
                <p><strong>ğŸ† å‹æ•—:</strong> å½¹è·ãŒé«˜ã„æ–¹ï¼ˆæ•°å­—ãŒå¤§ãã„æ–¹ï¼‰ãŒå‹åˆ©ã€4å‹ã§å³åº§ã«ã‚²ãƒ¼ãƒ çµ‚äº†</p>
            </div>
            
            <div class="url-display">
                <h3>ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®š</h3>
                <input type="text" class="url-input" id="player-name-input" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" maxlength="10">
                <br><br>
                <h3>ğŸ”— æ—¢å­˜ã‚²ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹å ´åˆ</h3>
                <input type="text" class="url-input" id="game-id-input" placeholder="ã‚²ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                <br>
                <button class="btn btn-primary" onclick="joinGameWithName()">ã‚²ãƒ¼ãƒ ã«å‚åŠ </button>
            </div>
            
            <div class="controls">
                <button class="btn btn-success" onclick="createGameWithName()">ğŸš€ æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’ä½œæˆ</button>
            </div>
            
            <div class="mobile-warning" id="mobile-warning" style="display: none;">
                <h4>ğŸ“± LINEã‚¢ãƒ—ãƒªã”åˆ©ç”¨ã®æ–¹ã¸</h4>
                <p>â€¢ ã‚²ãƒ¼ãƒ IDã‚’ã‚³ãƒ”ãƒ¼ã—ãŸå¾Œã€LINEã‚¢ãƒ—ãƒªã«æˆ»ã£ã¦ã‚‚ã‚²ãƒ¼ãƒ ã¯ç¶™ç¶šã•ã‚Œã¾ã™</p>
                <p>â€¢ ç›¸æ‰‹ãŒå‚åŠ ã—ãŸã‚‰ã€ã“ã®ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ãã¦ãã ã•ã„</p>
                <p>â€¢ é€šä¿¡ãŒåˆ‡ã‚Œã¦ã‚‚è‡ªå‹•ã§å†æ¥ç¶šã•ã‚Œã¾ã™</p>
            </div>
            
            <div class="connection-status" id="connection-status">
                Firebaseæ¥ç¶šä¸­...
            </div>
            
            <div class="reconnect-status hidden" id="reconnect-status">
                ğŸ”„ å†æ¥ç¶šä¸­...
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div class="hidden" id="game-screen">
            <div class="game-info" id="game-info">ã‚²ãƒ¼ãƒ æº–å‚™ä¸­...</div>
            <div class="player-indicator" id="player-indicator">ã‚ãªãŸ: è¦³æˆ¦è€…</div>
            
            <div class="score-display">
                <div>ğŸ† ã‚¹ã‚³ã‚¢</div>
                <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                    <div>
                        <div id="p1-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</div>
                        <div id="p1-score">0å‹</div>
                        <div class="win-tracker" id="p1-tracker"></div>
                    </div>
                    <div>
                        <div id="p2-name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</div>
                        <div id="p2-score">0å‹</div>
                        <div class="win-tracker" id="p2-tracker"></div>
                    </div>
                </div>
            </div>
            
            <div class="round-counter" id="round-counter">ãƒ©ã‚¦ãƒ³ãƒ‰ 1</div>
            
            <div class="game-area">
                <div class="player-area" id="player1-area">
                    <div class="crystal-status available" id="p1-crystal">ğŸ’</div>
                    <div class="player-info">
                        <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 <span class="status-indicator status-waiting" id="p1-status">å¾…æ©Ÿä¸­</span></h3>
                    </div>
                    <div class="cards" id="player1-cards"></div>
                </div>

                <div class="battle-area">
                    <div class="selected-card citizen hidden hidden-card" id="p1-selected">
                        <div class="selected-card-icon" id="p1-card-icon">ğŸ‘¤</div>
                        <div class="selected-card-name" id="p1-card-name">å¸‚æ°‘</div>
                    </div>
                    <div class="vs">VS</div>
                    <div class="selected-card soldier hidden hidden-card" id="p2-selected">
                        <div class="selected-card-icon" id="p2-card-icon">âš”ï¸</div>
                        <div class="selected-card-name" id="p2-card-name">å…µå£«</div>
                    </div>
                </div>

                <div class="player-area" id="player2-area">
                    <div class="crystal-status available" id="p2-crystal">ğŸ’</div>
                    <div class="player-info">
                        <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 <span class="status-indicator status-waiting" id="p2-status">å¾…æ©Ÿä¸­</span></h3>
                    </div>
                    <div class="cards" id="player2-cards"></div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-crystal" id="crystal-btn" onclick="useCrystal()" disabled>ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—</button>
                <button class="btn btn-success" id="ready-btn" onclick="setReady()" disabled>æº–å‚™å®Œäº†</button>
                <button class="btn btn-primary" onclick="resetGame()">ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="btn btn-danger" onclick="leaveGame()">ã‚²ãƒ¼ãƒ ã‚’å‡ºã‚‹</button>
            </div>
            
            <div class="result" id="result"></div>
            
            <!-- ã‚²ãƒ¼ãƒ IDè¡¨ç¤ºã‚’ä¸€ç•ªä¸‹ã«ç§»å‹• -->
            <div class="url-display">
                <h4>ğŸ”— å‹é”ã‚’æ‹›å¾…</h4>
                <input type="text" class="url-input" id="share-game-id" readonly onclick="this.select()">
                <br>
                <button class="btn btn-primary" onclick="copyGameId()">ã‚²ãƒ¼ãƒ IDã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>

        <!-- ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ -->
        <div class="hidden" id="game-over-screen">
            <div class="screen">
                <h2 id="winner-text">ğŸ‰ ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
                <div id="game-stats"></div>
                <button class="btn btn-primary" onclick="showSetup()">æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyAof5t2SxKA86cgAOdAX_GZTktduqpnCl4",
            authDomain: "my-card-game-2024.firebaseapp.com",
            databaseURL: "https://my-card-game-2024-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-card-game-2024",
            storageBucket: "my-card-game-2024.firebasestorage.app",
            messagingSenderId: "943669833378",
            appId: "1:943669833378:web:c97589236cc42b195e31fb"
        };

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let currentGameId = null;
        let myPlayerId = null;
        let gameState = null;
        let selectedCard = null;
        let crystalUsed = false;
        let reconnectAttempts = 0;
        let gameStateBackup = null;
        let isReconnecting = false;

        // ç”»é¢è¦ç´ 
        const screens = {
            setup: document.getElementById('setup-screen'),
            game: document.getElementById('game-screen'),
            gameOver: document.getElementById('game-over-screen')
        };

        // å½¹è·ã‚«ãƒ¼ãƒ‰å®šç¾©
        const rankCards = {
            slave: { rank: 0, icon: 'â›“ï¸', name: 'å¥´éš·', class: 'slave' },
            citizen: { rank: 1, icon: 'ğŸ‘¤', name: 'å¸‚æ°‘', class: 'citizen' },
            soldier: { rank: 2, icon: 'âš”ï¸', name: 'å…µå£«', class: 'soldier' },
            general: { rank: 3, icon: 'ğŸ–ï¸', name: 'å°†è»', class: 'general' },
            emperor: { rank: 4, icon: 'ğŸ‘‘', name: 'çš‡å¸', class: 'emperor' }
        };

        // åˆæœŸåŒ–
        window.onload = function() {
            document.getElementById('connection-status').textContent = 'Firebaseæ¥ç¶šå®Œäº†ï¼';
            
            // ãƒ¢ãƒã‚¤ãƒ«/LINEãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º
            detectMobileBrowser();
            
            // ãƒšãƒ¼ã‚¸å¾©å¸°æ™‚ã®å‡¦ç†
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('focus', handleWindowFocus);
            
            // LocalStorageã‹ã‚‰çŠ¶æ…‹å¾©å¸°ã‚’è©¦è¡Œ
            tryRestoreGameState();
            
            // URL ã‹ã‚‰ã‚²ãƒ¼ãƒ IDã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            if (gameId) {
                document.getElementById('game-id-input').value = gameId;
                // è‡ªå‹•å‚åŠ ã¯ã—ãªã„ï¼ˆåå‰å…¥åŠ›ã‚’ä¿ƒã™ï¼‰
            }
        };

        // ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º
        function detectMobileBrowser() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isLineApp = userAgent.includes('line');
            const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/.test(userAgent);
            
            if (isLineApp || isMobile) {
                document.getElementById('mobile-warning').style.display = 'block';
            }
        }

        // ãƒšãƒ¼ã‚¸å¾©å¸°æ™‚ã®å‡¦ç†
        function handleVisibilityChange() {
            if (!document.hidden && currentGameId && myPlayerId) {
                // ãƒšãƒ¼ã‚¸ãŒå†è¡¨ç¤ºã•ã‚ŒãŸæ™‚ã«å†æ¥ç¶šã‚’è©¦è¡Œ
                setTimeout(attemptReconnect, 1000);
            }
        }

        function handleWindowFocus() {
            if (currentGameId && myPlayerId) {
                setTimeout(attemptReconnect, 500);
            }
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ä¿å­˜
        function saveGameStateToLocal() {
            if (currentGameId && myPlayerId) {
                const backup = {
                    gameId: currentGameId,
                    playerId: myPlayerId,
                    crystalUsed: crystalUsed,
                    selectedCard: selectedCard,
                    timestamp: Date.now()
                };
                localStorage.setItem('rankBattleBackup', JSON.stringify(backup));
            }
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®å¾©å¸°ã‚’è©¦è¡Œ
        function tryRestoreGameState() {
            try {
                const backup = localStorage.getItem('rankBattleBackup');
                if (backup) {
                    const data = JSON.parse(backup);
                    // 30åˆ†ä»¥å†…ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å¾©å¸°
                    if (Date.now() - data.timestamp < 30 * 60 * 1000) {
                        currentGameId = data.gameId;
                        myPlayerId = data.playerId;
                        crystalUsed = data.crystalUsed || false;
                        selectedCard = data.selectedCard;
                        
                        // è‡ªå‹•å†æ¥ç¶šã‚’è©¦è¡Œ
                        setTimeout(attemptReconnect, 2000);
                    } else {
                        localStorage.removeItem('rankBattleBackup');
                    }
                }
            } catch (e) {
                console.error('çŠ¶æ…‹å¾©å¸°ã‚¨ãƒ©ãƒ¼:', e);
                localStorage.removeItem('rankBattleBackup');
            }
        }

        // å†æ¥ç¶šå‡¦ç†
        function attemptReconnect() {
            if (isReconnecting) return;
            isReconnecting = true;
            reconnectAttempts++;
            
            document.getElementById('reconnect-status').classList.remove('hidden');
            
            if (currentGameId && myPlayerId) {
                const gameRef = ref(database, `games/${currentGameId}`);
                onValue(gameRef, (snapshot) => {
                    const game = snapshot.val();
                    if (game && game.players && game.players[myPlayerId]) {
                        // å†æ¥ç¶šæˆåŠŸ
                        gameState = game;
                        showScreen('game');
                        updateGameUI();
                        updatePlayerIndicator();
                        document.getElementById('reconnect-status').classList.add('hidden');
                        isReconnecting = false;
                        console.log('å†æ¥ç¶šæˆåŠŸ');
                    } else if (reconnectAttempts < 3) {
                        // ãƒªãƒˆãƒ©ã‚¤
                        setTimeout(() => {
                            isReconnecting = false;
                            attemptReconnect();
                        }, 2000);
                    } else {
                        // è«¦ã‚ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«æˆ»ã‚‹
                        document.getElementById('reconnect-status').classList.add('hidden');
                        isReconnecting = false;
                        showSetup();
                        alert('ã‚²ãƒ¼ãƒ ã¸ã®å†æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
                    }
                }, { onlyOnce: true });
            } else {
                document.getElementById('reconnect-status').classList.add('hidden');
                isReconnecting = false;
            }
        }

        // ã‚²ãƒ¼ãƒ ä½œæˆï¼ˆåå‰ä»˜ãï¼‰
        window.createGameWithName = function() {
            const playerName = document.getElementById('player-name-input').value.trim() || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
            
            const gameRef = push(ref(database, 'games'));
            currentGameId = gameRef.key;
            myPlayerId = generatePlayerId();
            
            const initialState = {
                id: currentGameId,
                status: 'waiting',
                round: 1,
                players: {
                    [myPlayerId]: {
                        id: myPlayerId,
                        name: playerName,
                        position: 1,
                        cards: generateDeck(),
                        selectedCard: null,
                        ready: false,
                        crystalUsed: false,
                        wins: 0,
                        results: []
                    }
                },
                created: Date.now()
            };

            set(gameRef, initialState).then(() => {
                crystalUsed = false;
                saveGameStateToLocal();
                updateShareUrl();
                showScreen('game');
                startGameListener();
                updatePlayerIndicator();
            }).catch((error) => {
                console.error('ã‚²ãƒ¼ãƒ ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚²ãƒ¼ãƒ ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            });
        };

        // ã‚²ãƒ¼ãƒ å‚åŠ ï¼ˆåå‰ä»˜ãï¼‰
        window.joinGameWithName = function() {
            const gameId = document.getElementById('game-id-input').value.trim();
            if (!gameId) {
                alert('ã‚²ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const playerName = document.getElementById('player-name-input').value.trim() || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';

            currentGameId = gameId;
            myPlayerId = generatePlayerId();

            const gameRef = ref(database, `games/${gameId}`);
            onValue(gameRef, (snapshot) => {
                const game = snapshot.val();
                if (!game) {
                    alert('ã‚²ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                const playerCount = Object.keys(game.players || {}).length;
                
                if (playerCount < 2) {
                    const updateData = {};
                    updateData[`games/${gameId}/players/${myPlayerId}`] = {
                        id: myPlayerId,
                        name: playerName,
                        position: 2,
                        cards: generateDeck(),
                        selectedCard: null,
                        ready: false,
                        crystalUsed: false,
                        wins: 0,
                        results: []
                    };
                    
                    update(ref(database), updateData).then(() => {
                        crystalUsed = false;
                        saveGameStateToLocal();
                        updateShareUrl();
                        showScreen('game');
                        startGameListener();
                        updatePlayerIndicator();
                    }).catch((error) => {
                        console.error('ã‚²ãƒ¼ãƒ å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                        alert('ã‚²ãƒ¼ãƒ å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                    });
                } else {
                    alert('ã‚²ãƒ¼ãƒ ã¯æº€å“¡ã§ã™');
                }
            }, { onlyOnce: true });
        };

        // ãƒ‡ãƒƒã‚­ç”Ÿæˆ
        function generateDeck() {
            return {
                slave: 1,
                citizen: 2,
                soldier: 2,
                general: 1,
                emperor: 1
            };
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDç”Ÿæˆ
        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substr(2, 9);
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç›£è¦–ï¼ˆonDisconnectå‰Šé™¤ï¼‰
        function startGameListener() {
            const gameRef = ref(database, `games/${currentGameId}`);
            onValue(gameRef, (snapshot) => {
                gameState = snapshot.val();
                if (gameState) {
                    gameStateBackup = { ...gameState };
                    saveGameStateToLocal();
                    updateGameUI();
                }
            });

            // onDisconnectã¯å‰Šé™¤ï¼ˆLINEã‚¢ãƒ—ãƒªå¯¾å¿œï¼‰
            // ãƒ¢ãƒã‚¤ãƒ«ã§ã®ä¸€æ™‚çš„ãªåˆ‡æ–­ã‚’è¨±å®¹
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
        }

        // å…±æœ‰URLæ›´æ–°
        function updateShareUrl() {
            const gameUrl = `${window.location.origin}${window.location.pathname}?game=${currentGameId}`;
            document.getElementById('share-game-id').value = currentGameId;
            
            // URLã‚’æ›´æ–°ï¼ˆå±¥æ­´ã«æ®‹ã•ãªã„ï¼‰
            window.history.replaceState({}, '', gameUrl);
        }

        // ã‚²ãƒ¼ãƒ IDã‚³ãƒ”ãƒ¼
        window.copyGameId = function() {
            const gameIdInput = document.getElementById('share-game-id');
            gameIdInput.select();
            document.execCommand('copy');
            alert('ã‚²ãƒ¼ãƒ IDãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼å‹é”ã«é€ã£ã¦ãã ã•ã„ã€‚');
        };

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºæ›´æ–°
        function updatePlayerIndicator() {
            const indicator = document.getElementById('player-indicator');
            if (!gameState || !myPlayerId) return;

            const myPlayer = gameState.players[myPlayerId];
            if (myPlayer) {
                indicator.textContent = `ã‚ãªãŸ: ${myPlayer.name}`;
                indicator.className = 'player-indicator';
            } else {
                indicator.textContent = 'ã‚ãªãŸ: è¦³æˆ¦è€…';
                indicator.className = 'player-indicator';
            }
        }

        // ã‚²ãƒ¼ãƒ UIæ›´æ–°
        function updateGameUI() {
            if (!gameState) return;

            updateGameInfo();
            updateScoreDisplay();
            updatePlayerAreas();
            updateBattleArea();
            updateControls();
            updateCrystalStatus();
            checkGameEnd();
        }

        // ã‚²ãƒ¼ãƒ æƒ…å ±æ›´æ–°
        function updateGameInfo() {
            const playerCount = Object.keys(gameState.players || {}).length;
            let infoText = `ã‚²ãƒ¼ãƒ ID: ${currentGameId} | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${playerCount}/2`;
            
            if (gameState.status === 'playing') {
                infoText += ` | ãƒ©ã‚¦ãƒ³ãƒ‰é€²è¡Œä¸­`;
            } else if (gameState.status === 'waiting') {
                infoText += ' | ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…æ©Ÿä¸­...';
            }

            document.getElementById('game-info').textContent = infoText;
            document.getElementById('round-counter').textContent = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${gameState.round}`;
        }

        // ã‚¹ã‚³ã‚¢è¡¨ç¤ºæ›´æ–°ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚‚è¡¨ç¤ºï¼‰
        function updateScoreDisplay() {
            const players = Object.values(gameState.players || {}).sort((a, b) => a.position - b.position);
            
            players.forEach((player, index) => {
                const nameEl = document.getElementById(`p${index + 1}-name`);
                const scoreEl = document.getElementById(`p${index + 1}-score`);
                const trackerEl = document.getElementById(`p${index + 1}-tracker`);
                
                if (nameEl) {
                    nameEl.textContent = player.name || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${index + 1}`;
                }
                
                if (scoreEl) {
                    scoreEl.textContent = `${player.wins}å‹`;
                }
                
                if (trackerEl) {
                    trackerEl.innerHTML = '';
                    const results = player.results || [];
                    for (let i = 0; i < 7; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'win-dot';
                        if (results[i] === 'win') dot.classList.add('win');
                        else if (results[i] === 'loss') dot.classList.add('loss');
                        else if (results[i] === 'draw') dot.classList.add('draw');
                        trackerEl.appendChild(dot);
                    }
                }
            });
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢æ›´æ–°
        function updatePlayerAreas() {
            const players = Object.values(gameState.players || {});
            
            players.forEach(player => {
                updatePlayerArea(player);
                updatePlayerCards(player);
            });
        }

        function updatePlayerArea(player) {
            const areaId = `player${player.position}-area`;
            const statusId = `p${player.position}-status`;

            const area = document.getElementById(areaId);
            const status = document.getElementById(statusId);

            if (!area || !status) return;

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            if (player.ready) {
                status.textContent = 'æº–å‚™å®Œäº†';
                status.className = 'status-indicator status-ready';
                area.classList.add('ready');
                area.classList.remove('waiting');
            } else {
                status.textContent = 'é¸æŠä¸­';
                status.className = 'status-indicator status-waiting';
                area.classList.add('waiting');
                area.classList.remove('ready');
            }

            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if (player.id === myPlayerId) {
                area.classList.add('current-player');
            } else {
                area.classList.remove('current-player');
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°ï¼ˆå½¹è·é †ã«ä¸¦ã¹ã‚‹ï¼‰
        function updatePlayerCards(player) {
            const cardsContainer = document.getElementById(`player${player.position}-cards`);
            if (!cardsContainer) return;

            cardsContainer.innerHTML = '';

            // è‡ªåˆ†ã®ã‚«ãƒ¼ãƒ‰ã®ã¿è¡¨ç¤º
            if (player.id === myPlayerId && player.cards) {
                // å½¹è·é †ã«ä¸¦ã¹ã‚‹ï¼ˆå¥´éš·â†’çš‡å¸ï¼‰
                const cardOrder = ['slave', 'citizen', 'soldier', 'general', 'emperor'];
                
                cardOrder.forEach(cardType => {
                    const count = player.cards[cardType] || 0;
                    for (let i = 0; i < count; i++) {
                        const card = createCardElement(cardType);
                        cardsContainer.appendChild(card);
                    }
                });
            }
        }

        // ã‚«ãƒ¼ãƒ‰è¦ç´ ä½œæˆ
        function createCardElement(cardType) {
            const cardData = rankCards[cardType];
            const card = document.createElement('div');
            card.className = `card ${cardData.class}`;
            card.dataset.type = cardType;
            card.innerHTML = `
                <div class="card-rank">${cardData.rank}</div>
                <div class="card-icon">${cardData.icon}</div>
                <div class="card-name">${cardData.name}</div>
            `;
            card.onclick = () => selectCard(cardType, card);
            return card;
        }

        // ã‚«ãƒ¼ãƒ‰é¸æŠ
        function selectCard(cardType, cardElement) {
            if (!gameState || gameState.status !== 'playing') return;
            
            const myPlayer = gameState.players[myPlayerId];
            if (!myPlayer || myPlayer.ready) return;

            selectedCard = cardType;
            
            // ã‚«ãƒ¼ãƒ‰é¸æŠUIæ›´æ–°
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');
            
            document.getElementById('ready-btn').disabled = false;
            document.getElementById('crystal-btn').disabled = crystalUsed;
        }

        // ã‚¯ãƒªã‚¹ã‚¿ãƒ«ä½¿ç”¨
        window.useCrystal = function() {
            if (!selectedCard || crystalUsed) return;

            const cardData = rankCards[selectedCard];
            const nextRanks = ['citizen', 'soldier', 'general', 'emperor'];
            
            if (cardData.rank < 4) {
                crystalUsed = true;
                document.getElementById('crystal-btn').disabled = true;
                
                // UIä¸Šã§ãƒ©ãƒ³ã‚¯ã‚¢ãƒƒãƒ—è¡¨ç¤º
                const selectedCardEl = document.querySelector('.card.selected');
                if (selectedCardEl) {
                    const newRank = nextRanks[cardData.rank];
                    const newCardData = rankCards[newRank];
                    
                    selectedCardEl.className = `card ${newCardData.class} selected`;
                    selectedCardEl.innerHTML = `
                        <div class="card-rank">${newCardData.rank}</div>
                        <div class="card-icon">${newCardData.icon}</div>
                        <div class="card-name">${newCardData.name}</div>
                    `;
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                    selectedCard = newRank;
                }
            }
        };

        // æº–å‚™å®Œäº†
        window.setReady = function() {
            if (!selectedCard || !myPlayerId) return;

            const updateData = {};
            updateData[`games/${currentGameId}/players/${myPlayerId}/selectedCard`] = selectedCard;
            updateData[`games/${currentGameId}/players/${myPlayerId}/ready`] = true;
            updateData[`games/${currentGameId}/players/${myPlayerId}/crystalUsed`] = crystalUsed;

            update(ref(database), updateData);
            
            document.getElementById('ready-btn').disabled = true;
            document.getElementById('crystal-btn').disabled = true;
            
            // çŠ¶æ…‹ã‚’ä¿å­˜
            saveGameStateToLocal();
        };

        // ã‚¯ãƒªã‚¹ã‚¿ãƒ«çŠ¶æ…‹æ›´æ–°
        function updateCrystalStatus() {
            const players = Object.values(gameState.players || {});
            
            players.forEach(player => {
                const crystalEl = document.getElementById(`p${player.position}-crystal`);
                if (crystalEl) {
                    if (player.crystalUsed) {
                        crystalEl.className = 'crystal-status used';
                    } else {
                        crystalEl.className = 'crystal-status available';
                    }
                }
            });
        }

        // ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢æ›´æ–°
        function updateBattleArea() {
            const players = Object.values(gameState.players || {}).sort((a, b) => a.position - b.position);
            
            players.forEach((player, index) => {
                const selectedCardEl = document.getElementById(`p${index + 1}-selected`);
                const cardIconEl = document.getElementById(`p${index + 1}-card-icon`);
                const cardNameEl = document.getElementById(`p${index + 1}-card-name`);
                
                if (!selectedCardEl || !cardIconEl || !cardNameEl) return;

                if (player.selectedCard) {
                    selectedCardEl.classList.remove('hidden');
                    
                    // ä¸¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæº–å‚™å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                    const allReady = players.every(p => p.ready);
                    if (allReady) {
                        const cardData = rankCards[player.selectedCard];
                        selectedCardEl.className = `selected-card ${cardData.class}`;
                        cardIconEl.textContent = cardData.icon;
                        cardNameEl.textContent = cardData.name;
                        selectedCardEl.classList.remove('hidden-card');
                    } else {
                        selectedCardEl.classList.add('hidden-card');
                        cardIconEl.textContent = '';
                        cardNameEl.textContent = '';
                    }
                } else {
                    selectedCardEl.classList.add('hidden');
                }
            });

            // ä¸¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæº–å‚™å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯æˆ¦é—˜é–‹å§‹
            if (players.length === 2 && players.every(p => p.ready)) {
                setTimeout(processBattle, 1500);
            }
        }

        // æˆ¦é—˜å‡¦ç†
        function processBattle() {
            const players = Object.values(gameState.players || {}).sort((a, b) => a.position - b.position);
            if (players.length !== 2 || !players.every(p => p.ready)) return;

            const p1 = players[0];
            const p2 = players[1];

            const result = determineBattleResult(p1.selectedCard, p2.selectedCard);
            
            // çµæœè¡¨ç¤º
            showBattleResult(p1.selectedCard, p2.selectedCard, result);

            // ã‚«ãƒ¼ãƒ‰æ¶ˆè²»ã¨ã‚¹ã‚³ã‚¢æ›´æ–°
            setTimeout(() => {
                const newP1Cards = { ...p1.cards };
                const newP2Cards = { ...p2.cards };
                
                newP1Cards[p1.selectedCard]--;
                newP2Cards[p2.selectedCard]--;

                const newP1Results = [...(p1.results || [])];
                const newP2Results = [...(p2.results || [])];

                let newP1Wins = p1.wins;
                let newP2Wins = p2.wins;

                if (result === 'p1_win') {
                    newP1Wins++;
                    newP1Results.push('win');
                    newP2Results.push('loss');
                } else if (result === 'p2_win') {
                    newP2Wins++;
                    newP1Results.push('loss');
                    newP2Results.push('win');
                } else {
                    newP1Results.push('draw');
                    newP2Results.push('draw');
                }

                const updateData = {};
                updateData[`games/${currentGameId}/players/${p1.id}/cards`] = newP1Cards;
                updateData[`games/${currentGameId}/players/${p2.id}/cards`] = newP2Cards;
                updateData[`games/${currentGameId}/players/${p1.id}/selectedCard`] = null;
                updateData[`games/${currentGameId}/players/${p2.id}/selectedCard`] = null;
                updateData[`games/${currentGameId}/players/${p1.id}/ready`] = false;
                updateData[`games/${currentGameId}/players/${p2.id}/ready`] = false;
                updateData[`games/${currentGameId}/players/${p1.id}/wins`] = newP1Wins;
                updateData[`games/${currentGameId}/players/${p2.id}/wins`] = newP2Wins;
                updateData[`games/${currentGameId}/players/${p1.id}/results`] = newP1Results;
                updateData[`games/${currentGameId}/players/${p2.id}/results`] = newP2Results;

                // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
                if (newP1Wins >= 4 || newP2Wins >= 4) {
                    updateData[`games/${currentGameId}/status`] = 'finished';
                    updateData[`games/${currentGameId}/winner`] = newP1Wins >= 4 ? p1.id : p2.id;
                } else {
                    updateData[`games/${currentGameId}/round`] = gameState.round + 1;
                }

                update(ref(database), updateData);
                selectedCard = null;
                crystalUsed = false;
                
                // çŠ¶æ…‹ã‚’ä¿å­˜
                saveGameStateToLocal();
            }, 2000);
        }

        // æˆ¦é—˜çµæœåˆ¤å®š
        function determineBattleResult(card1, card2) {
            const rank1 = rankCards[card1].rank;
            const rank2 = rankCards[card2].rank;
            
            // å¥´éš·ã®åé€†ï¼šå¥´éš· vs çš‡å¸ = å¥´éš·ã®å‹åˆ©
            if (card1 === 'slave' && card2 === 'emperor') return 'p1_win';
            if (card2 === 'slave' && card1 === 'emperor') return 'p2_win';
            
            // é€šå¸¸ã®æ¯”è¼ƒ
            if (rank1 > rank2) return 'p1_win';
            if (rank2 > rank1) return 'p2_win';
            return 'draw';
        }

        // æˆ¦é—˜çµæœè¡¨ç¤ºï¼ˆæ¼”å‡ºã‚’å¼·åŒ–ï¼‰
        function showBattleResult(card1, card2, result) {
            const card1Data = rankCards[card1];
            const card2Data = rankCards[card2];
            const resultDiv = document.getElementById('result');
            
            let message = `${card1Data.name}(${card1Data.rank}) VS ${card2Data.name}(${card2Data.rank}) - `;
            let resultClass = '';
            
            // åé€†ã®ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (card1 === 'slave' && card2 === 'emperor') {
                message = `ğŸ”¥ ${card1Data.name} VS ${card2Data.name} - åé€†æˆåŠŸï¼ `;
            } else if (card2 === 'slave' && card1 === 'emperor') {
                message = `ğŸ”¥ ${card1Data.name} VS ${card2Data.name} - åé€†æˆåŠŸï¼ `;
            }
            
            // çµæœã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
            const myPlayer = gameState.players[myPlayerId];
            const isMyWin = (result === 'p1_win' && myPlayer.position === 1) || 
                           (result === 'p2_win' && myPlayer.position === 2);
            
            switch (result) {
                case 'p1_win':
                    message += `ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®å‹åˆ©ï¼`;
                    resultClass = isMyWin ? 'win' : 'loss';
                    break;
                case 'p2_win':
                    message += `ğŸ‰ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®å‹åˆ©ï¼`;
                    resultClass = isMyWin ? 'win' : 'loss';
                    break;
                default:
                    message += `ğŸ¤ å¼•ãåˆ†ã‘ï¼`;
                    resultClass = 'draw';
                    break;
            }
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§çµæœè¡¨ç¤º
            resultDiv.textContent = message;
            resultDiv.className = `result ${resultClass}`;
            
            setTimeout(() => {
                resultDiv.textContent = '';
                resultDiv.className = 'result';
            }, 4000);
        }

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ›´æ–°
        function updateControls() {
            const myPlayer = gameState.players[myPlayerId];
            const readyBtn = document.getElementById('ready-btn');
            const crystalBtn = document.getElementById('crystal-btn');
            
            if (myPlayer && gameState.status === 'playing' && !myPlayer.ready) {
                readyBtn.disabled = !selectedCard;
                crystalBtn.disabled = !selectedCard || crystalUsed;
            } else {
                readyBtn.disabled = true;
                crystalBtn.disabled = true;
            }

            // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒã‚§ãƒƒã‚¯
            const playerCount = Object.keys(gameState.players || {}).length;
            if (playerCount === 2 && gameState.status === 'waiting') {
                const updateData = {};
                updateData[`games/${currentGameId}/status`] = 'playing';
                update(ref(database), updateData);
            }
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
        function checkGameEnd() {
            if (gameState.status === 'finished') {
                showGameOver();
            }
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢
        function showGameOver() {
            const winner = gameState.players[gameState.winner];
            const players = Object.values(gameState.players || {});
            
            document.getElementById('winner-text').textContent = 
                winner ? `ğŸ‰ ${winner.name}ã®å‹åˆ©ï¼` : 'ğŸ® ã‚²ãƒ¼ãƒ çµ‚äº†';
            
            const statsHtml = players.map(player => 
                `<p>${player.name}: ${player.wins}å‹</p>`
            ).join('');
            
            document.getElementById('game-stats').innerHTML = `
                <p>æœ€çµ‚çµæœ:</p>
                ${statsHtml}
                <p>ç·ãƒ©ã‚¦ãƒ³ãƒ‰æ•°: ${gameState.round - 1}</p>
            `;
            
            showScreen('gameOver');
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆï¼ˆä¿®æ­£ç‰ˆï¼‰
        window.resetGame = function() {
            if (confirm('ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ã„ã‚²ãƒ¼ãƒ IDã§å†é–‹ã—ã¾ã™ã‹ï¼Ÿ')) {
                // LocalStorage ã‚’ã‚¯ãƒªã‚¢
                localStorage.removeItem('rankBattleBackup');
                
                // ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ã‹ã‚‰å®Œå…¨ã«å‰Šé™¤
                if (currentGameId && myPlayerId) {
                    remove(ref(database, `games/${currentGameId}/players/${myPlayerId}`)).then(() => {
                        // å®Œå…¨ã«åˆæœŸåŒ–
                        currentGameId = null;
                        myPlayerId = null;
                        gameState = null;
                        selectedCard = null;
                        crystalUsed = false;
                        reconnectAttempts = 0;
                        
                        // URLã‚¯ãƒªã‚¢
                        window.history.replaceState({}, '', window.location.pathname);
                        
                        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ–°ã‚²ãƒ¼ãƒ ä½œæˆ
                        setTimeout(() => {
                            createGameWithName();
                        }, 1000);
                    }).catch((error) => {
                        console.error('ãƒªã‚»ãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', error);
                        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å¼·åˆ¶çš„ã«ãƒªã‚»ãƒƒãƒˆ
                        currentGameId = null;
                        myPlayerId = null;
                        gameState = null;
                        selectedCard = null;
                        crystalUsed = false;
                        reconnectAttempts = 0;
                        createGameWithName();
                    });
                } else {
                    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãŒãªã„å ´åˆã¯ãã®ã¾ã¾æ–°ã‚²ãƒ¼ãƒ 
                    createGameWithName();
                }
            }
        };

        // ã‚²ãƒ¼ãƒ é€€å‡ºï¼ˆä¿®æ­£ç‰ˆï¼‰
        window.leaveGame = function() {
            if (confirm('æœ¬å½“ã«ã‚²ãƒ¼ãƒ ã‚’é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
                // LocalStorage ã‚’ã‚¯ãƒªã‚¢
                localStorage.removeItem('rankBattleBackup');
                
                if (currentGameId && myPlayerId) {
                    remove(ref(database, `games/${currentGameId}/players/${myPlayerId}`)).then(() => {
                        // å®Œå…¨ã«åˆæœŸåŒ–
                        currentGameId = null;
                        myPlayerId = null;
                        gameState = null;
                        selectedCard = null;
                        crystalUsed = false;
                        reconnectAttempts = 0;
                        
                        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹
                        showSetup();
                    }).catch((error) => {
                        console.error('é€€å‡ºã‚¨ãƒ©ãƒ¼:', error);
                        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å¼·åˆ¶çš„ã«åˆæœŸåŒ–
                        currentGameId = null;
                        myPlayerId = null;
                        gameState = null;
                        selectedCard = null;
                        crystalUsed = false;
                        reconnectAttempts = 0;
                        showSetup();
                    });
                } else {
                    showSetup();
                }
            }
        };

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹ï¼ˆä¿®æ­£ç‰ˆï¼‰
        window.showSetup = function() {
            // LocalStorage ã‚’ã‚¯ãƒªã‚¢
            localStorage.removeItem('rankBattleBackup');
            
            // å®Œå…¨åˆæœŸåŒ–
            currentGameId = null;
            myPlayerId = null;
            gameState = null;
            selectedCard = null;
            crystalUsed = false;
            reconnectAttempts = 0;
            isReconnecting = false;
            
            // ç”»é¢ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«åˆ‡ã‚Šæ›¿ãˆ
            showScreen('setup');
            
            // URLã‚’ã‚¯ãƒªã‚¢
            window.history.replaceState({}, '', window.location.pathname);
            
            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            const gameIdInput = document.getElementById('game-id-input');
            if (gameIdInput) gameIdInput.value = '';
            
            // å†æ¥ç¶šè¡¨ç¤ºã‚’éš ã™
            document.getElementById('reconnect-status').classList.add('hidden');
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¯ä¿æŒï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰
            
            // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('p1-name').textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
            document.getElementById('p2-name').textContent = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
            document.getElementById('p1-score').textContent = '0å‹';
            document.getElementById('p2-score').textContent = '0å‹';
            document.getElementById('p1-tracker').innerHTML = '';
            document.getElementById('p2-tracker').innerHTML = '';
        };

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const readyBtn = document.getElementById('ready-btn');
                if (!readyBtn.disabled) {
                    setReady();
                }
            }
        });

    </script>
</body>
</html>