<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANK BATTLE</title>
    <style>
        * {
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 10px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .game-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            font-size: clamp(2rem, 6vw, 4rem);
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            background: linear-gradient(45deg, #f39c12, #e67e22, #d35400);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            letter-spacing: 3px;
        }

        .subtitle {
            font-size: clamp(0.9rem, 2vw, 1.2rem);
            color: #bdc3c7;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .screen {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: clamp(15px, 3vw, 30px);
            backdrop-filter: blur(10px);
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .game-info {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            font-weight: bold;
            font-size: clamp(14px, 3vw, 18px);
            padding: 15px;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.4);
        }

        .player-indicator {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            font-weight: bold;
            font-size: clamp(16px, 3vw, 20px);
            padding: 12px 25px;
            border-radius: 20px;
            margin: 10px 0;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.4);
        }

        .score-display {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            font-weight: bold;
            font-size: clamp(18px, 4vw, 24px);
            padding: 15px;
            border-radius: 20px;
            margin: 15px 0;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.4);
        }

        .win-tracker {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
        }

        .win-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
        }

        .win-dot.win {
            background: #2ecc71;
            border-color: #2ecc71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.6);
        }

        .win-dot.loss {
            background: #e74c3c;
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.6);
        }

        .win-dot.draw {
            background: #f39c12;
            border-color: #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.6);
        }

        .status-indicator {
            padding: 8px 16px;
            border-radius: 15px;
            font-weight: bold;
            margin: 10px;
            display: inline-block;
        }

        .status-waiting {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .status-ready {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .round-counter {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            font-weight: bold;
            font-size: clamp(16px, 3vw, 20px);
            padding: 10px 20px;
            border-radius: 25px;
            margin: 10px 0;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.4);
        }

        .game-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 400px;
        }

        .player-area {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: clamp(10px, 2vw, 20px);
            backdrop-filter: blur(10px);
            transition: all 0.5s ease;
            position: relative;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .player-area.current-player {
            border: 3px solid #f39c12;
            box-shadow: 0 0 25px rgba(243, 156, 18, 0.4);
        }

        .player-area.waiting {
            opacity: 0.7;
            transform: scale(0.98);
        }

        .player-area.ready {
            border: 3px solid #2ecc71;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.4);
        }

        .crystal-status {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 28px;
            transition: all 0.3s ease;
        }

        .crystal-status.available {
            animation: sparkle 2s infinite;
            filter: drop-shadow(0 0 10px #3498db);
        }

        .crystal-status.used {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        @keyframes sparkle {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.15) rotate(180deg); }
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .cards {
            display: flex;
            justify-content: center;
            gap: clamp(5px, 1.5vw, 10px);
            flex-wrap: wrap;
            min-height: clamp(80px, 15vw, 120px);
        }

        .card {
            width: clamp(70px, 14vw, 90px);
            height: clamp(90px, 18vw, 120px);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid rgba(255,255,255,0.2);
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            position: relative;
            touch-action: manipulation;
            user-select: none;
            font-weight: bold;
        }

        .card:hover, .card:active {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }

        .card.selected {
            border-color: #f39c12;
            transform: translateY(-10px) scale(1.1);
            box-shadow: 0 15px 30px rgba(243, 156, 18, 0.6);
        }

        .card.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .card-icon {
            font-size: clamp(28px, 8vw, 42px);
            margin-bottom: 5px;
        }

        .card-name {
            font-size: clamp(10px, 2vw, 12px);
            text-align: center;
            line-height: 1.2;
        }

        .card-rank {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: clamp(12px, 3vw, 16px);
            font-weight: bold;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ÂΩπËÅ∑Âà•„Ç´„Éº„ÉâËâ≤ */
        .card.slave { 
            background: linear-gradient(135deg, #7f8c8d, #95a5a6);
            border-color: rgba(127, 140, 141, 0.7);
        }
        .card.citizen { 
            background: linear-gradient(135deg, #3498db, #2980b9);
            border-color: rgba(52, 152, 219, 0.7);
        }
        .card.soldier { 
            background: linear-gradient(135deg, #e67e22, #d35400);
            border-color: rgba(230, 126, 34, 0.7);
        }
        .card.general { 
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-color: rgba(155, 89, 182, 0.7);
        }
        .card.emperor { 
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border-color: rgba(241, 196, 15, 0.7);
        }

        .battle-area {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: clamp(15px, 3vw, 30px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: relative;
            flex-wrap: wrap;
            gap: 10px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .selected-card {
            width: clamp(90px, 18vw, 130px);
            height: clamp(120px, 24vw, 170px);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            border: 4px solid #f39c12;
            font-weight: bold;
            position: relative;
        }

        .selected-card.hidden-card {
            background: linear-gradient(135deg, #34495e, #2c3e50) !important;
            border: 4px solid #7f8c8d;
        }

        .selected-card.hidden-card::after {
            content: '?';
            font-size: clamp(40px, 10vw, 60px);
            color: #bdc3c7;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .selected-card-icon {
            font-size: clamp(35px, 10vw, 50px);
            margin-bottom: 8px;
        }

        .selected-card-name {
            font-size: clamp(12px, 3vw, 16px);
            text-align: center;
        }

        .vs {
            font-size: clamp(28px, 8vw, 40px);
            font-weight: bold;
            color: #f39c12;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            text-transform: uppercase;
        }

        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: clamp(10px, 2vw, 15px) clamp(20px, 4vw, 30px);
            font-size: clamp(14px, 3vw, 18px);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation;
            user-select: none;
            min-height: 48px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-crystal {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            position: relative;
        }

        .btn-crystal::before {
            content: 'üíé';
            margin-right: 8px;
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result {
            margin: 20px 0;
            font-size: clamp(18px, 5vw, 28px);
            font-weight: bold;
            min-height: 60px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 15px;
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result.win {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            animation: celebrateWin 0.6s ease-out;
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6);
        }

        .result.loss {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            animation: showLoss 0.6s ease-out;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.6);
        }

        .result.draw {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            animation: showDraw 0.6s ease-out;
            box-shadow: 0 0 30px rgba(243, 156, 18, 0.6);
        }

        @keyframes celebrateWin {
            0% { transform: scale(0.8) rotate(-5deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(2deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes showLoss {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes showDraw {
            0% { transform: translateY(-10px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .url-display {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .url-input {
            width: 100%;
            max-width: 500px;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 14px;
            margin: 10px 0;
            text-align: center;
        }

        .url-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .connection-status {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .rules-display {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            font-size: clamp(12px, 2.5vw, 14px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .rules-display h4 {
            color: #f39c12;
            margin-top: 0;
            text-align: center;
        }

        .hidden { display: none; }

        @media (max-width: 768px) {
            body { padding: 5px; }
            .cards { gap: 5px; }
            .battle-area { flex-direction: column; gap: 15px; }
            h1 { letter-spacing: 1px; }
        }

        @media (max-width: 480px) {
            .player-info { flex-direction: column; gap: 8px; }
            .controls { gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>RANK BATTLE</h1>
        <div class="subtitle">ÈöéÁ¥ö„Å®Èù©ÂëΩ„ÅÆ„Ç´„Éº„Éâ„Ç≤„Éº„É†</div>
        
        <!-- „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢ -->
        <div class="screen" id="setup-screen">
            <h2>‚öîÔ∏è Êà¶Â†¥„Å∏„Çà„ÅÜ„Åì„Åù</h2>
            
            <div class="rules-display">
                <h4>üìã „Ç≤„Éº„É†„É´„Éº„É´</h4>
                <p><strong>üéØ ÁõÆÊ®ô:</strong> ÂÖà„Å´4Âãù„Åó„ÅüÊñπ„ÅÆÂãùÂà©ÔºÅ</p>
                <p><strong>üé¥ ÊâãÊú≠:</strong> Â•¥Èö∑(0)√ó1, Â∏ÇÊ∞ë(1)√ó2, ÂÖµÂ£´(2)√ó2, Â∞ÜËªç(3)√ó1, ÁöáÂ∏ù(4)√ó1</p>
                <p><strong>‚ö° ÁâπÊÆä:</strong> Â•¥Èö∑„ÅØÁöáÂ∏ù„Å´„ÄåÂèçÈÄÜ„Äç„ÅßÂãùÂà©ÔºÅ</p>
                <p><strong>üíé „ÇØ„É™„Çπ„Çø„É´:</strong> 1Âõû„Å†„Åë„Ç´„Éº„Éâ„Çí1„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÔºÅ</p>
                <p><strong>üèÜ ÂãùÊïó:</strong> ÂΩπËÅ∑„ÅåÈ´ò„ÅÑÊñπÔºàÊï∞Â≠ó„ÅåÂ§ß„Åç„ÅÑÊñπÔºâ„ÅåÂãùÂà©„ÄÅ4Âãù„ÅßÂç≥Â∫ß„Å´„Ç≤„Éº„É†ÁµÇ‰∫Ü</p>
            </div>
            
            <div class="url-display">
                <h3>üë§ „Éó„É¨„Ç§„É§„ÉºË®≠ÂÆö</h3>
                <input type="text" class="url-input" id="player-name-input" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" maxlength="10">
                <br><br>
                <h3>üîó Êó¢Â≠ò„Ç≤„Éº„É†„Å´ÂèÇÂä†„Åô„ÇãÂ†¥Âêà</h3>
                <input type="text" class="url-input" id="game-id-input" placeholder="„Ç≤„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                <br>
                <button class="btn btn-primary" onclick="joinGameWithName()">„Ç≤„Éº„É†„Å´ÂèÇÂä†</button>
            </div>
            
            <div class="controls">
                <button class="btn btn-success" onclick="createGameWithName()">üöÄ Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„Çí‰ΩúÊàê</button>
            </div>
            
            <div class="connection-status" id="connection-status">
                FirebaseÊé•Á∂ö‰∏≠...
            </div>
        </div>

        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div class="hidden" id="game-screen">
            <div class="game-info" id="game-info">„Ç≤„Éº„É†Ê∫ñÂÇô‰∏≠...</div>
            <div class="player-indicator" id="player-indicator">„ÅÇ„Å™„Åü: Ë¶≥Êà¶ËÄÖ</div>
            
            <div class="score-display">
                <div>üèÜ „Çπ„Ç≥„Ç¢</div>
                <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                    <div>
                        <div id="p1-name">„Éó„É¨„Ç§„É§„Éº1</div>
                        <div id="p1-score">0Âãù</div>
                        <div class="win-tracker" id="p1-tracker"></div>
                    </div>
                    <div>
                        <div id="p2-name">„Éó„É¨„Ç§„É§„Éº2</div>
                        <div id="p2-score">0Âãù</div>
                        <div class="win-tracker" id="p2-tracker"></div>
                    </div>
                </div>
            </div>
            
            <div class="round-counter" id="round-counter">„É©„Ç¶„É≥„Éâ 1</div>
            
            <div class="game-area">
                <div class="player-area" id="player1-area">
                    <div class="crystal-status available" id="p1-crystal">üíé</div>
                    <div class="player-info">
                        <h3>„Éó„É¨„Ç§„É§„Éº1 <span class="status-indicator status-waiting" id="p1-status">ÂæÖÊ©ü‰∏≠</span></h3>
                    </div>
                    <div class="cards" id="player1-cards"></div>
                </div>

                <div class="battle-area">
                    <div class="selected-card citizen hidden hidden-card" id="p1-selected">
                        <div class="selected-card-icon" id="p1-card-icon">üë§</div>
                        <div class="selected-card-name" id="p1-card-name">Â∏ÇÊ∞ë</div>
                    </div>
                    <div class="vs">VS</div>
                    <div class="selected-card soldier hidden hidden-card" id="p2-selected">
                        <div class="selected-card-icon" id="p2-card-icon">‚öîÔ∏è</div>
                        <div class="selected-card-name" id="p2-card-name">ÂÖµÂ£´</div>
                    </div>
                </div>

                <div class="player-area" id="player2-area">
                    <div class="crystal-status available" id="p2-crystal">üíé</div>
                    <div class="player-info">
                        <h3>„Éó„É¨„Ç§„É§„Éº2 <span class="status-indicator status-waiting" id="p2-status">ÂæÖÊ©ü‰∏≠</span></h3>
                    </div>
                    <div class="cards" id="player2-cards"></div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-crystal" id="crystal-btn" onclick="useCrystal()" disabled>„É©„É≥„ÇØ„Ç¢„ÉÉ„Éó</button>
                <button class="btn btn-success" id="ready-btn" onclick="setReady()" disabled>Ê∫ñÂÇôÂÆå‰∫Ü</button>
                <button class="btn btn-primary" onclick="resetGame()">„Ç≤„Éº„É†„É™„Çª„ÉÉ„Éà</button>
                <button class="btn btn-danger" onclick="leaveGame()">„Ç≤„Éº„É†„ÇíÂá∫„Çã</button>
            </div>
            
            <div class="result" id="result"></div>
            
            <!-- „Ç≤„Éº„É†IDË°®Á§∫„Çí‰∏ÄÁï™‰∏ã„Å´ÁßªÂãï -->
            <div class="url-display">
                <h4>üîó ÂèãÈÅî„ÇíÊãõÂæÖ</h4>
                <input type="text" class="url-input" id="share-game-id" readonly onclick="this.select()">
                <br>
                <button class="btn btn-primary" onclick="copyGameId()">„Ç≤„Éº„É†ID„Çí„Ç≥„Éî„Éº</button>
            </div>
        </div>

        <!-- „Ç≤„Éº„É†ÁµÇ‰∫ÜÁîªÈù¢ -->
        <div class="hidden" id="game-over-screen">
            <div class="screen">
                <h2 id="winner-text">üéâ „Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</h2>
                <div id="game-stats"></div>
                <button class="btn btn-primary" onclick="showSetup()">Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyAof5t2SxKA86cgAOdAX_GZTktduqpnCl4",
            authDomain: "my-card-game-2024.firebaseapp.com",
            databaseURL: "https://my-card-game-2024-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "my-card-game-2024",
            storageBucket: "my-card-game-2024.firebasestorage.app",
            messagingSenderId: "943669833378",
            appId: "1:943669833378:web:c97589236cc42b195e31fb"
        };

        // FirebaseÂàùÊúüÂåñ
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let currentGameId = null;
        let myPlayerId = null;
        let gameState = null;
        let selectedCard = null;
        let crystalUsed = false;

        // ÁîªÈù¢Ë¶ÅÁ¥†
        const screens = {
            setup: document.getElementById('setup-screen'),
            game: document.getElementById('game-screen'),
            gameOver: document.getElementById('game-over-screen')
        };

        // ÂΩπËÅ∑„Ç´„Éº„ÉâÂÆöÁæ©
        const rankCards = {
            slave: { rank: 0, icon: '‚õìÔ∏è', name: 'Â•¥Èö∑', class: 'slave' },
            citizen: { rank: 1, icon: 'üë§', name: 'Â∏ÇÊ∞ë', class: 'citizen' },
            soldier: { rank: 2, icon: '‚öîÔ∏è', name: 'ÂÖµÂ£´', class: 'soldier' },
            general: { rank: 3, icon: 'üéñÔ∏è', name: 'Â∞ÜËªç', class: 'general' },
            emperor: { rank: 4, icon: 'üëë', name: 'ÁöáÂ∏ù', class: 'emperor' }
        };

        // ÂàùÊúüÂåñ
        window.onload = function() {
            document.getElementById('connection-status').textContent = 'FirebaseÊé•Á∂öÂÆå‰∫ÜÔºÅ';
            
            // URL „Åã„Çâ„Ç≤„Éº„É†ID„ÇíÂèñÂæó
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');
            if (gameId) {
                document.getElementById('game-id-input').value = gameId;
                // Ëá™ÂãïÂèÇÂä†„ÅØ„Åó„Å™„ÅÑÔºàÂêçÂâçÂÖ•Âäõ„Çí‰øÉ„ÅôÔºâ
            }
        };

        // „Ç≤„Éº„É†‰ΩúÊàêÔºàÂêçÂâç‰ªò„ÅçÔºâ
        window.createGameWithName = function() {
            const playerName = document.getElementById('player-name-input').value.trim() || '„Éó„É¨„Ç§„É§„Éº1';
            
            const gameRef = push(ref(database, 'games'));
            currentGameId = gameRef.key;
            myPlayerId = generatePlayerId();
            
            const initialState = {
                id: currentGameId,
                status: 'waiting',
                round: 1,
                players: {
                    [myPlayerId]: {
                        id: myPlayerId,
                        name: playerName,
                        position: 1,
                        cards: generateDeck(),
                        selectedCard: null,
                        ready: false,
                        crystalUsed: false,
                        wins: 0,
                        results: []
                    }
                },
                created: Date.now()
            };

            set(gameRef, initialState).then(() => {
                crystalUsed = false;
                updateShareUrl();
                showScreen('game');
                startGameListener();
                updatePlayerIndicator();
            }).catch((error) => {
                console.error('„Ç≤„Éº„É†‰ΩúÊàê„Ç®„É©„Éº:', error);
                alert('„Ç≤„Éº„É†‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            });
        };

        // „Ç≤„Éº„É†ÂèÇÂä†ÔºàÂêçÂâç‰ªò„ÅçÔºâ
        window.joinGameWithName = function() {
            const gameId = document.getElementById('game-id-input').value.trim();
            if (!gameId) {
                alert('„Ç≤„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const playerName = document.getElementById('player-name-input').value.trim() || '„Éó„É¨„Ç§„É§„Éº2';

            currentGameId = gameId;
            myPlayerId = generatePlayerId();

            const gameRef = ref(database, `games/${gameId}`);
            onValue(gameRef, (snapshot) => {
                const game = snapshot.val();
                if (!game) {
                    alert('„Ç≤„Éº„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }

                const playerCount = Object.keys(game.players || {}).length;
                
                if (playerCount < 2) {
                    const updateData = {};
                    updateData[`games/${gameId}/players/${myPlayerId}`] = {
                        id: myPlayerId,
                        name: playerName,
                        position: 2,
                        cards: generateDeck(),
                        selectedCard: null,
                        ready: false,
                        crystalUsed: false,
                        wins: 0,
                        results: []
                    };
                    
                    update(ref(database), updateData).then(() => {
                        crystalUsed = false;
                        updateShareUrl();
                        showScreen('game');
                        startGameListener();
                        updatePlayerIndicator();
                    }).catch((error) => {
                        console.error('„Ç≤„Éº„É†ÂèÇÂä†„Ç®„É©„Éº:', error);
                        alert('„Ç≤„Éº„É†ÂèÇÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
                    });
                } else {
                    alert('„Ç≤„Éº„É†„ÅØÊ∫ÄÂì°„Åß„Åô');
                }
            }, { onlyOnce: true });
        };

        // „Éá„ÉÉ„Ç≠ÁîüÊàê
        function generateDeck() {
            return {
                slave: 1,
                citizen: 2,
                soldier: 2,
                general: 1,
                emperor: 1
            };
        }

        // „Éó„É¨„Ç§„É§„ÉºIDÁîüÊàê
        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substr(2, 9);
        }

        // „Ç≤„Éº„É†Áä∂ÊÖãÁõ£Ë¶ñ
        function startGameListener() {
            const gameRef = ref(database, `games/${currentGameId}`);
            onValue(gameRef, (snapshot) => {
                gameState = snapshot.val();
                if (gameState) {
                    updateGameUI();
                }
            });

            // ÂàáÊñ≠ÊôÇ„ÅÆÂá¶ÁêÜ
            const playerRef = ref(database, `games/${currentGameId}/players/${myPlayerId}`);
            onDisconnect(playerRef).remove();
        }

        // ÁîªÈù¢Âàá„ÇäÊõø„Åà
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
        }

        // ÂÖ±ÊúâURLÊõ¥Êñ∞
        function updateShareUrl() {
            const gameUrl = `${window.location.origin}${window.location.pathname}?game=${currentGameId}`;
            document.getElementById('share-game-id').value = currentGameId;
            
            // URL„ÇíÊõ¥Êñ∞ÔºàÂ±•Ê≠¥„Å´ÊÆã„Åï„Å™„ÅÑÔºâ
            window.history.replaceState({}, '', gameUrl);
        }

        // „Ç≤„Éº„É†ID„Ç≥„Éî„Éº
        window.copyGameId = function() {
            const gameIdInput = document.getElementById('share-game-id');
            gameIdInput.select();
            document.execCommand('copy');
            alert('„Ç≤„Éº„É†ID„Åå„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åó„ÅüÔºÅÂèãÈÅî„Å´ÈÄÅ„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        };

        // „Éó„É¨„Ç§„É§„ÉºË°®Á§∫Êõ¥Êñ∞
        function updatePlayerIndicator() {
            const indicator = document.getElementById('player-indicator');
            if (!gameState || !myPlayerId) return;

            const myPlayer = gameState.players[myPlayerId];
            if (myPlayer) {
                indicator.textContent = `„ÅÇ„Å™„Åü: ${myPlayer.name}`;
                indicator.className = 'player-indicator';
            } else {
                indicator.textContent = '„ÅÇ„Å™„Åü: Ë¶≥Êà¶ËÄÖ';
                indicator.className = 'player-indicator';
            }
        }

        // „Ç≤„Éº„É†UIÊõ¥Êñ∞
        function updateGameUI() {
            if (!gameState) return;

            updateGameInfo();
            updateScoreDisplay();
            updatePlayerAreas();
            updateBattleArea();
            updateControls();
            updateCrystalStatus();
            checkGameEnd();
        }

        // „Ç≤„Éº„É†ÊÉÖÂ†±Êõ¥Êñ∞
        function updateGameInfo() {
            const playerCount = Object.keys(gameState.players || {}).length;
            let infoText = `„Ç≤„Éº„É†ID: ${currentGameId} | „Éó„É¨„Ç§„É§„Éº: ${playerCount}/2`;
            
            if (gameState.status === 'playing') {
                infoText += ` | „É©„Ç¶„É≥„ÉâÈÄ≤Ë°å‰∏≠`;
            } else if (gameState.status === 'waiting') {
                infoText += ' | „Éó„É¨„Ç§„É§„Éº„ÇíÂæÖÊ©ü‰∏≠...';
            }

            document.getElementById('game-info').textContent = infoText;
            document.getElementById('round-counter').textContent = `„É©„Ç¶„É≥„Éâ ${gameState.round}`;
        }

        // „Çπ„Ç≥„Ç¢Ë°®Á§∫Êõ¥Êñ∞Ôºà„Éó„É¨„Ç§„É§„ÉºÂêç„ÇÇË°®Á§∫Ôºâ
        function updateScoreDisplay() {
            const players = Object.values(gameState.players || {}).sort((a, b) => a.position - b.position);
            
            players.forEach((player, index) => {
                const nameEl = document.getElementById(`p${index + 1}-name`);
                const scoreEl = document.getElementById(`p${index + 1}-score`);
                const trackerEl = document.getElementById(`p${index + 1}-tracker`);
                
                if (nameEl) {
                    nameEl.textContent = player.name || `„Éó„É¨„Ç§„É§„Éº${index + 1}`;
                }
                
                if (scoreEl) {
                    scoreEl.textContent = `${player.wins}Âãù`;
                }
                
                if (trackerEl) {
                    trackerEl.innerHTML = '';
                    const results = player.results || [];
                    for (let i = 0; i < 7; i++) {
                        const dot = document.createElement('div');
                        dot.className = 'win-dot';
                        if (results[i] === 'win') dot.classList.add('win');
                        else if (results[i] === 'loss') dot.classList.add('loss');
                        else if (results[i] === 'draw') dot.classList.add('draw');
                        trackerEl.appendChild(dot);
                    }
                }
            });
        }

        // „Éó„É¨„Ç§„É§„Éº„Ç®„É™„Ç¢Êõ¥Êñ∞
        function updatePlayerAreas() {
            const players = Object.values(gameState.players || {});
            
            players.forEach(player => {
                updatePlayerArea(player);
                updatePlayerCards(player);
            });
        }

        function updatePlayerArea(player) {
            const areaId = `player${player.position}-area`;
            const statusId = `p${player.position}-status`;

            const area = document.getElementById(areaId);
            const status = document.getElementById(statusId);

            if (!area || !status) return;

            // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
            if (player.ready) {
                status.textContent = 'Ê∫ñÂÇôÂÆå‰∫Ü';
                status.className = 'status-indicator status-ready';
                area.classList.add('ready');
                area.classList.remove('waiting');
            } else {
                status.textContent = 'ÈÅ∏Êäû‰∏≠';
                status.className = 'status-indicator status-waiting';
                area.classList.add('waiting');
                area.classList.remove('ready');
            }

            // ÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„Éº„Çí„Éè„Ç§„É©„Ç§„Éà
            if (player.id === myPlayerId) {
                area.classList.add('current-player');
            } else {
                area.classList.remove('current-player');
            }
        }

        // „Éó„É¨„Ç§„É§„Éº„Ç´„Éº„ÉâÊõ¥Êñ∞ÔºàÂΩπËÅ∑È†Ü„Å´‰∏¶„Åπ„ÇãÔºâ
        function updatePlayerCards(player) {
            const cardsContainer = document.getElementById(`player${player.position}-cards`);
            if (!cardsContainer) return;

            cardsContainer.innerHTML = '';

            // Ëá™ÂàÜ„ÅÆ„Ç´„Éº„Éâ„ÅÆ„ÅøË°®Á§∫
            if (player.id === myPlayerId && player.cards) {
                // ÂΩπËÅ∑È†Ü„Å´‰∏¶„Åπ„ÇãÔºàÂ•¥Èö∑‚ÜíÁöáÂ∏ùÔºâ
                const cardOrder = ['slave', 'citizen', 'soldier', 'general', 'emperor'];
                
                cardOrder.forEach(cardType => {
                    const count = player.cards[cardType] || 0;
                    for (let i = 0; i < count; i++) {
                        const card = createCardElement(cardType);
                        cardsContainer.appendChild(card);
                    }
                });
            }
        }

        // „Ç´„Éº„ÉâË¶ÅÁ¥†‰ΩúÊàê
        function createCardElement(cardType) {
            const cardData = rankCards[cardType];
            const card = document.createElement('div');
            card.className = `card ${cardData.class}`;
            card.dataset.type = cardType;
            card.innerHTML = `
                <div class="card-rank">${cardData.rank}</div>
                <div class="card-icon">${cardData.icon}</div>
                <div class="card-name">${cardData.name}</div>
            `;
            card.onclick = () => selectCard(cardType, card);
            return card;
        }

        // „Ç´„Éº„ÉâÈÅ∏Êäû
        function selectCard(cardType, cardElement) {
            if (!gameState || gameState.status !== 'playing') return;
            
            const myPlayer = gameState.players[myPlayerId];
            if (!myPlayer || myPlayer.ready) return;

            selectedCard = cardType;
            
            // „Ç´„Éº„ÉâÈÅ∏ÊäûUIÊõ¥Êñ∞
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            cardElement.classList.add('selected');
            
            document.getElementById('ready-btn').disabled = false;
            document.getElementById('crystal-btn').disabled = crystalUsed;
        }

        // „ÇØ„É™„Çπ„Çø„É´‰ΩøÁî®
        window.useCrystal = function() {
            if (!selectedCard || crystalUsed) return;

            const cardData = rankCards[selectedCard];
            const nextRanks = ['citizen', 'soldier', 'general', 'emperor'];
            
            if (cardData.rank < 4) {
                crystalUsed = true;
                document.getElementById('crystal-btn').disabled = true;
                
                // UI‰∏ä„Åß„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóË°®Á§∫
                const selectedCardEl = document.querySelector('.card.selected');
                if (selectedCardEl) {
                    const newRank = nextRanks[cardData.rank];
                    const newCardData = rankCards[newRank];
                    
                    selectedCardEl.className = `card ${newCardData.class} selected`;
                    selectedCardEl.innerHTML = `
                        <div class="card-rank">${newCardData.rank}</div>
                        <div class="card-icon">${newCardData.icon}</div>
                        <div class="card-name">${newCardData.name}</div>
                    `;
                    
                    // „Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                    selectedCard = newRank;
                }
            }
        };

        // Ê∫ñÂÇôÂÆå‰∫Ü
        window.setReady = function() {
            if (!selectedCard || !myPlayerId) return;

            const updateData = {};
            updateData[`games/${currentGameId}/players/${myPlayerId}/selectedCard`] = selectedCard;
            updateData[`games/${currentGameId}/players/${myPlayerId}/ready`] = true;
            updateData[`games/${currentGameId}/players/${myPlayerId}/crystalUsed`] = crystalUsed;

            update(ref(database), updateData);
            
            document.getElementById('ready-btn').disabled = true;
            document.getElementById('crystal-btn').disabled = true;
        };

        // „ÇØ„É™„Çπ„Çø„É´Áä∂ÊÖãÊõ¥Êñ∞
        function updateCrystalStatus() {
            const players = Object.values(gameState.players || {});
            
            players.forEach(player => {
                const crystalEl = document.getElementById(`p${player.position}-crystal`);
                if (crystalEl) {
                    if (player.crystalUsed) {
                        crystalEl.className = 'crystal-status used';
                    } else {
                        crystalEl.className = 'crystal-status available';
                    }
                }
            });
        }

        // „Éê„Éà„É´„Ç®„É™„Ç¢Êõ¥Êñ∞
        function updateBattleArea() {
            const players = Object.values(gameState.players || {}).sort((a, b) => a.position - b.position);
            
            players.forEach((player, index) => {
                const selectedCardEl = document.getElementById(`p${index + 1}-selected`);
                const cardIconEl = document.getElementById(`p${index + 1}-card-icon`);
                const cardNameEl = document.getElementById(`p${index + 1}-card-name`);
                
                if (!selectedCardEl || !cardIconEl || !cardNameEl) return;

                if (player.selectedCard) {
                    selectedCardEl.classList.remove('hidden');
                    
                    // ‰∏°„Éó„É¨„Ç§„É§„Éº„ÅåÊ∫ñÂÇôÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Åø„Ç´„Éº„Éâ„ÇíË°®Á§∫
                    const allReady = players.every(p => p.ready);
                    if (allReady) {
                        const cardData = rankCards[player.selectedCard];
                        selectedCardEl.className = `selected-card ${cardData.class}`;
                        cardIconEl.textContent = cardData.icon;
                        cardNameEl.textContent = cardData.name;
                        selectedCardEl.classList.remove('hidden-card');
                    } else {
                        selectedCardEl.classList.add('hidden-card');
                        cardIconEl.textContent = '';
                        cardNameEl.textContent = '';
                    }
                } else {
                    selectedCardEl.classList.add('hidden');
                }
            });

            // ‰∏°„Éó„É¨„Ç§„É§„Éº„ÅåÊ∫ñÂÇôÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊà¶ÈóòÈñãÂßã
            if (players.length === 2 && players.every(p => p.ready)) {
                setTimeout(processBattle, 1500);
            }
        }

        // Êà¶ÈóòÂá¶ÁêÜ
        function processBattle() {
            const players = Object.values(gameState.players || {}).sort((a, b) => a.position - b.position);
            if (players.length !== 2 || !players.every(p => p.ready)) return;

            const p1 = players[0];
            const p2 = players[1];

            const result = determineBattleResult(p1.selectedCard, p2.selectedCard);
            
            // ÁµêÊûúË°®Á§∫
            showBattleResult(p1.selectedCard, p2.selectedCard, result);

            // „Ç´„Éº„ÉâÊ∂àË≤ª„Å®„Çπ„Ç≥„Ç¢Êõ¥Êñ∞
            setTimeout(() => {
                const newP1Cards = { ...p1.cards };
                const newP2Cards = { ...p2.cards };
                
                newP1Cards[p1.selectedCard]--;
                newP2Cards[p2.selectedCard]--;

                const newP1Results = [...(p1.results || [])];
                const newP2Results = [...(p2.results || [])];

                let newP1Wins = p1.wins;
                let newP2Wins = p2.wins;

                if (result === 'p1_win') {
                    newP1Wins++;
                    newP1Results.push('win');
                    newP2Results.push('loss');
                } else if (result === 'p2_win') {
                    newP2Wins++;
                    newP1Results.push('loss');
                    newP2Results.push('win');
                } else {
                    newP1Results.push('draw');
                    newP2Results.push('draw');
                }

                const updateData = {};
                updateData[`games/${currentGameId}/players/${p1.id}/cards`] = newP1Cards;
                updateData[`games/${currentGameId}/players/${p2.id}/cards`] = newP2Cards;
                updateData[`games/${currentGameId}/players/${p1.id}/selectedCard`] = null;
                updateData[`games/${currentGameId}/players/${p2.id}/selectedCard`] = null;
                updateData[`games/${currentGameId}/players/${p1.id}/ready`] = false;
                updateData[`games/${currentGameId}/players/${p2.id}/ready`] = false;
                updateData[`games/${currentGameId}/players/${p1.id}/wins`] = newP1Wins;
                updateData[`games/${currentGameId}/players/${p2.id}/wins`] = newP2Wins;
                updateData[`games/${currentGameId}/players/${p1.id}/results`] = newP1Results;
                updateData[`games/${currentGameId}/players/${p2.id}/results`] = newP2Results;

                // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                if (newP1Wins >= 4 || newP2Wins >= 4) {
                    updateData[`games/${currentGameId}/status`] = 'finished';
                    updateData[`games/${currentGameId}/winner`] = newP1Wins >= 4 ? p1.id : p2.id;
                } else {
                    updateData[`games/${currentGameId}/round`] = gameState.round + 1;
                }

                update(ref(database), updateData);
                selectedCard = null;
                crystalUsed = false;
            }, 2000);
        }

        // Êà¶ÈóòÁµêÊûúÂà§ÂÆö
        function determineBattleResult(card1, card2) {
            const rank1 = rankCards[card1].rank;
            const rank2 = rankCards[card2].rank;
            
            // Â•¥Èö∑„ÅÆÂèçÈÄÜÔºöÂ•¥Èö∑ vs ÁöáÂ∏ù = Â•¥Èö∑„ÅÆÂãùÂà©
            if (card1 === 'slave' && card2 === 'emperor') return 'p1_win';
            if (card2 === 'slave' && card1 === 'emperor') return 'p2_win';
            
            // ÈÄöÂ∏∏„ÅÆÊØîËºÉ
            if (rank1 > rank2) return 'p1_win';
            if (rank2 > rank1) return 'p2_win';
            return 'draw';
        }

        // Êà¶ÈóòÁµêÊûúË°®Á§∫ÔºàÊºîÂá∫„ÇíÂº∑ÂåñÔºâ
        function showBattleResult(card1, card2, result) {
            const card1Data = rankCards[card1];
            const card2Data = rankCards[card2];
            const resultDiv = document.getElementById('result');
            
            let message = `${card1Data.name}(${card1Data.rank}) VS ${card2Data.name}(${card2Data.rank}) - `;
            let resultClass = '';
            
            // ÂèçÈÄÜ„ÅÆÁâπÂà•„É°„ÉÉ„Çª„Éº„Ç∏
            if (card1 === 'slave' && card2 === 'emperor') {
                message = `üî• ${card1Data.name} VS ${card2Data.name} - ÂèçÈÄÜÊàêÂäüÔºÅ `;
            } else if (card2 === 'slave' && card1 === 'emperor') {
                message = `üî• ${card1Data.name} VS ${card2Data.name} - ÂèçÈÄÜÊàêÂäüÔºÅ `;
            }
            
            // ÁµêÊûú„Å´Âøú„Åò„Å¶„É°„ÉÉ„Çª„Éº„Ç∏„Å®„Çπ„Çø„Ç§„É´„ÇíË®≠ÂÆö
            const myPlayer = gameState.players[myPlayerId];
            const isMyWin = (result === 'p1_win' && myPlayer.position === 1) || 
                           (result === 'p2_win' && myPlayer.position === 2);
            
            switch (result) {
                case 'p1_win':
                    message += `üéâ „Éó„É¨„Ç§„É§„Éº1„ÅÆÂãùÂà©ÔºÅ`;
                    resultClass = isMyWin ? 'win' : 'loss';
                    break;
                case 'p2_win':
                    message += `üéâ „Éó„É¨„Ç§„É§„Éº2„ÅÆÂãùÂà©ÔºÅ`;
                    resultClass = isMyWin ? 'win' : 'loss';
                    break;
                default:
                    message += `ü§ù Âºï„ÅçÂàÜ„ÅëÔºÅ`;
                    resultClass = 'draw';
                    break;
            }
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥‰ªò„Åç„ÅßÁµêÊûúË°®Á§∫
            resultDiv.textContent = message;
            resultDiv.className = `result ${resultClass}`;
            
            setTimeout(() => {
                resultDiv.textContent = '';
                resultDiv.className = 'result';
            }, 4000);
        }

        // „Ç≥„É≥„Éà„É≠„Éº„É´Êõ¥Êñ∞
        function updateControls() {
            const myPlayer = gameState.players[myPlayerId];
            const readyBtn = document.getElementById('ready-btn');
            const crystalBtn = document.getElementById('crystal-btn');
            
            if (myPlayer && gameState.status === 'playing' && !myPlayer.ready) {
                readyBtn.disabled = !selectedCard;
                crystalBtn.disabled = !selectedCard || crystalUsed;
            } else {
                readyBtn.disabled = true;
                crystalBtn.disabled = true;
            }

            // „Ç≤„Éº„É†ÈñãÂßã„ÉÅ„Çß„ÉÉ„ÇØ
            const playerCount = Object.keys(gameState.players || {}).length;
            if (playerCount === 2 && gameState.status === 'waiting') {
                const updateData = {};
                updateData[`games/${currentGameId}/status`] = 'playing';
                update(ref(database), updateData);
            }
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
        function checkGameEnd() {
            if (gameState.status === 'finished') {
                showGameOver();
            }
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫ÜÁîªÈù¢
        function showGameOver() {
            const winner = gameState.players[gameState.winner];
            const players = Object.values(gameState.players || {});
            
            document.getElementById('winner-text').textContent = 
                winner ? `üéâ ${winner.name}„ÅÆÂãùÂà©ÔºÅ` : 'üéÆ „Ç≤„Éº„É†ÁµÇ‰∫Ü';
            
            const statsHtml = players.map(player => 
                `<p>${player.name}: ${player.wins}Âãù</p>`
            ).join('');
            
            document.getElementById('game-stats').innerHTML = `
                <p>ÊúÄÁµÇÁµêÊûú:</p>
                ${statsHtml}
                <p>Á∑è„É©„Ç¶„É≥„ÉâÊï∞: ${gameState.round - 1}</p>
            `;
            
            showScreen('gameOver');
        }

        // „Ç≤„Éº„É†„É™„Çª„ÉÉ„ÉàÔºà‰øÆÊ≠£ÁâàÔºâ
        window.resetGame = function() {
            if (confirm('„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†ID„ÅßÂÜçÈñã„Åó„Åæ„Åô„ÅãÔºü')) {
                // ÁèæÂú®„ÅÆ„Ç≤„Éº„É†„Åã„ÇâÂÆåÂÖ®„Å´ÂâäÈô§
                if (currentGameId && myPlayerId) {
                    remove(ref(database, `games/${currentGameId}/players/${myPlayerId}`)).then(() => {
                        // ÂÆåÂÖ®„Å´ÂàùÊúüÂåñ
                        currentGameId = null;
                        myPlayerId = null;
                        gameState = null;
                        selectedCard = null;
                        crystalUsed = false;
                        
                        // URL„ÇØ„É™„Ç¢
                        window.history.replaceState({}, '', window.location.pathname);
                        
                        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÊñ∞„Ç≤„Éº„É†‰ΩúÊàê
                        setTimeout(() => {
                            createGameWithName();
                        }, 1000);
                    }).catch((error) => {
                        console.error('„É™„Çª„ÉÉ„Éà„Ç®„É©„Éº:', error);
                        // „Ç®„É©„Éº„Åß„ÇÇÂº∑Âà∂ÁöÑ„Å´„É™„Çª„ÉÉ„Éà
                        currentGameId = null;
                        myPlayerId = null;
                        gameState = null;
                        selectedCard = null;
                        crystalUsed = false;
                        createGameWithName();
                    });
                } else {
                    // „Ç≤„Éº„É†Áä∂ÊÖã„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæÊñ∞„Ç≤„Éº„É†
                    createGameWithName();
                }
            }
        };

        // „Ç≤„Éº„É†ÈÄÄÂá∫Ôºà‰øÆÊ≠£ÁâàÔºâ
        window.leaveGame = function() {
            if (confirm('Êú¨ÂΩì„Å´„Ç≤„Éº„É†„ÇíÈÄÄÂá∫„Åó„Åæ„Åô„ÅãÔºü')) {
                if (currentGameId && myPlayerId) {
                    remove(ref(database, `games/${currentGameId}/players/${myPlayerId}`)).then(() => {
                        // ÂÆåÂÖ®„Å´ÂàùÊúüÂåñ
                        currentGameId = null;
                        myPlayerId = null;
                        gameState = null;
                        selectedCard = null;
                        crystalUsed = false;
                        
                        // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„Å´Êàª„Çã
                        showSetup();
                    }).catch((error) => {
                        console.error('ÈÄÄÂá∫„Ç®„É©„Éº:', error);
                        // „Ç®„É©„Éº„Åß„ÇÇÂº∑Âà∂ÁöÑ„Å´ÂàùÊúüÂåñ
                        currentGameId = null;
                        myPlayerId = null;
                        gameState = null;
                        selectedCard = null;
                        crystalUsed = false;
                        showSetup();
                    });
                } else {
                    showSetup();
                }
            }
        };

        // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„Å´Êàª„ÇãÔºà‰øÆÊ≠£ÁâàÔºâ
        window.showSetup = function() {
            // ÂÆåÂÖ®ÂàùÊúüÂåñ
            currentGameId = null;
            myPlayerId = null;
            gameState = null;
            selectedCard = null;
            crystalUsed = false;
            
            // ÁîªÈù¢„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„Å´Âàá„ÇäÊõø„Åà
            showScreen('setup');
            
            // URL„Çí„ÇØ„É™„Ç¢
            window.history.replaceState({}, '', window.location.pathname);
            
            // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
            const gameIdInput = document.getElementById('game-id-input');
            if (gameIdInput) gameIdInput.value = '';
            
            // „Éó„É¨„Ç§„É§„ÉºÂêç„ÅØ‰øùÊåÅÔºà„É¶„Éº„Ç∂„Éì„É™„ÉÜ„Ç£„ÅÆ„Åü„ÇÅÔºâ
            
            // „Çπ„Ç≥„Ç¢Ë°®Á§∫„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('p1-name').textContent = '„Éó„É¨„Ç§„É§„Éº1';
            document.getElementById('p2-name').textContent = '„Éó„É¨„Ç§„É§„Éº2';
            document.getElementById('p1-score').textContent = '0Âãù';
            document.getElementById('p2-score').textContent = '0Âãù';
            document.getElementById('p1-tracker').innerHTML = '';
            document.getElementById('p2-tracker').innerHTML = '';
        };

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const readyBtn = document.getElementById('ready-btn');
                if (!readyBtn.disabled) {
                    setReady();
                }
            }
        });

    </script>
</body>
</html>