<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase „Éû„É´„ÉÅ„Éó„É¨„Ç§„É§„ÉºË§í„ÇÅ„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ff9a9e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .status-online {
            color: #10b981;
        }

        .status-offline {
            color: #ef4444;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .game-code-display {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .game-code {
            font-size: 3em;
            font-weight: bold;
            letter-spacing: 0.1em;
            font-family: 'Courier New', monospace;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2d3748;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .gender-buttons {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .gender-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .gender-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .player-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .player-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .player-card.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .player-card.parent {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            border-color: transparent;
        }

        .current-turn {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .keyword-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .keyword-btn {
            padding: 20px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }

        .keyword-btn:hover {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .keyword-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
        }

        .reveal-box {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin: 30px 0;
            border: 3px solid #ff9a9e;
        }

        .revealed-keyword {
            font-size: 3em;
            font-weight: bold;
            color: #8b4513;
            animation: bounce 0.8s ease;
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0,-30px,0);
            }
            70% {
                transform: translate3d(0,-15px,0);
            }
            90% {
                transform: translate3d(0,-4px,0);
            }
        }

        .winner-announcement {
            background: linear-gradient(135deg, #ffd89b, #19547b);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        .waiting-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .keyword-grid {
                grid-template-columns: 1fr;
            }

            .game-code {
                font-size: 2em;
            }

            .revealed-keyword {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ú® ÂèãÈÅîË§í„ÇÅ„Ç≤„Éº„É† ‚ú®</h1>
            <div class="connection-status" id="connectionStatus">
                <span id="statusIcon">üîå</span>
                <span id="statusText">Êé•Á∂öÁ¢∫Ë™ç‰∏≠...</span>
            </div>
            <p style="color: #666; font-size: 0.9em;">„Åø„Çì„Å™„ÅßËá™Â∑±ËÇØÂÆöÊÑüUPÔºÅ</p>
        </div>

        <!-- „É°„Éã„É•„ÉºÁîªÈù¢ -->
        <div id="menuScreen" class="screen active">
            <div style="text-align: center; margin: 40px 0;">
                <div style="font-size: 4em; margin-bottom: 20px;">üéÆ</div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="startHostGame()">
                        üè† „Ç≤„Éº„É†„Çí‰ΩúÊàê
                    </button>
                    <button class="btn btn-secondary" onclick="showJoinScreen()">
                        üö™ „Ç≤„Éº„É†„Å´ÂèÇÂä†
                    </button>
                </div>
            </div>
        </div>

        <!-- „Éõ„Çπ„ÉàÁîªÈù¢ -->
        <div id="hostScreen" class="screen">
            <div style="text-align: center;">
                <h2>„Ç≤„Éº„É†„Ç≥„Éº„Éâ</h2>
                <div class="game-code-display">
                    <div class="game-code" id="gameCodeDisplay"></div>
                    <button class="btn" onclick="copyGameCode()" style="margin-top: 15px;">
                        üìã „Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº
                    </button>
                </div>
                <p style="color: #666; margin-bottom: 30px;">ÂèãÈÅî„Å´„Åì„ÅÆ„Ç≥„Éº„Éâ„ÇíÊïô„Åà„Å¶ÂèÇÂä†„Åó„Å¶„ÇÇ„Çâ„ÅÑ„Åæ„Åó„Çá„ÅÜ</p>
                
                <div style="max-width: 400px; margin: 0 auto;">
                    <div class="form-group">
                        <label>„ÅÇ„Å™„Åü„ÅÆÂêçÂâç</label>
                        <input type="text" id="hostName" class="form-input" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                    </div>
                    <div class="form-group">
                        <label>ÊÄßÂà•</label>
                        <div class="gender-buttons">
                            <div class="gender-btn selected" onclick="selectGender('host', 'male')">üë® Áî∑ÊÄß</div>
                            <div class="gender-btn" onclick="selectGender('host', 'female')">üë© Â•≥ÊÄß</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="joinAsHost()">ÂèÇÂä†„Åô„Çã</button>
                </div>
            </div>
        </div>

        <!-- ÂèÇÂä†ÁîªÈù¢ -->
        <div id="joinScreen" class="screen">
            <div style="text-align: center;">
                <h2>„Ç≤„Éº„É†„Å´ÂèÇÂä†</h2>
                <div style="max-width: 400px; margin: 0 auto;">
                    <div class="form-group">
                        <label>„Ç≤„Éº„É†„Ç≥„Éº„Éâ</label>
                        <input type="text" id="joinGameCode" class="form-input" placeholder="6Ê°Å„ÅÆ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ" maxlength="6" style="text-align: center; text-transform: uppercase; font-family: monospace;">
                    </div>
                    <div class="form-group">
                        <label>„ÅÇ„Å™„Åü„ÅÆÂêçÂâç</label>
                        <input type="text" id="joinName" class="form-input" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">
                    </div>
                    <div class="form-group">
                        <label>ÊÄßÂà•</label>
                        <div class="gender-buttons">
                            <div class="gender-btn selected" onclick="selectGender('join', 'male')">üë® Áî∑ÊÄß</div>
                            <div class="gender-btn" onclick="selectGender('join', 'female')">üë© Â•≥ÊÄß</div>
                        </div>
                    </div>
                    <div class="controls">
                        <button class="btn btn-success" onclick="joinGame()">ÂèÇÂä†„Åô„Çã</button>
                        <button class="btn" onclick="showMenuScreen()">Êàª„Çã</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- „É≠„Éì„ÉºÁîªÈù¢ -->
        <div id="lobbyScreen" class="screen">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>ÂèÇÂä†ËÄÖ‰∏ÄË¶ß (<span id="playerCount">0</span>‰∫∫)</h2>
                <div style="color: #666; font-family: monospace;">„Ç≥„Éº„Éâ: <span id="lobbyGameCode"></span></div>
            </div>
            
            <div id="playersList" class="player-list"></div>
            
            <div id="parentSelection" style="display: none;">
                <h3 style="text-align: center; margin: 20px 0;">Ë¶™„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</h3>
                <div id="parentOptions" class="player-list"></div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="startGame()" id="startGameBtn" disabled>„Ç≤„Éº„É†ÈñãÂßã</button>
                </div>
            </div>

            <div id="waitingForHost" class="waiting-message" style="display: none;">
                „Éõ„Çπ„Éà„ÅåË¶™„ÇíÈÅ∏Êäû„Åó„Å¶„ÅÑ„Åæ„Åô...
            </div>
        </div>

        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="gameScreen" class="screen">
            <!-- ÊäïÁ•®„Éï„Çß„Éº„Ç∫ -->
            <div id="votingPhase" style="display: none;">
                <div id="votingTurn" class="current-turn"></div>
                <div id="keywordSelection" style="display: none;">
                    <h3 style="text-align: center; margin: 20px 0;">Ë¶™„ÇíË§í„ÇÅ„Çã„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</h3>
                    <div id="keywordOptions" class="keyword-grid"></div>
                    <div class="controls">
                        <button class="btn" onclick="resetKeywords()" id="resetKeywordsBtn">„Ç≠„Éº„ÉØ„Éº„ÉâÂ§âÊõ¥Ôºà1Âõû„Åæ„ÅßÔºâ</button>
                    </div>
                </div>
                <div id="waitingForVote" class="waiting-message" style="display: none;">
                    ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅåÊäïÁ•®‰∏≠„Åß„Åô...
                </div>
            </div>

            <!-- „É™„Éì„Éº„É´„Éï„Çß„Éº„Ç∫ -->
            <div id="revealPhase" style="display: none;">
                <div style="text-align: center;">
                    <h2 id="revealParentName"></h2>
                    <div id="revealBox" class="reveal-box">
                        <div id="revealedKeyword" class="revealed-keyword"></div>
                    </div>
                    <div id="revealControls" class="controls" style="display: none;">
                        <button class="btn btn-primary" onclick="nextReveal()">Ê¨°„Å∏</button>
                    </div>
                    <div id="waitingForReveal" class="waiting-message" style="display: none;">
                        „Éõ„Çπ„Éà„ÅåÈÄ≤Ë°å‰∏≠„Åß„Åô...
                    </div>
                </div>
            </div>

            <!-- ÁµêÊûú„Éï„Çß„Éº„Ç∫ -->
            <div id="resultPhase" style="display: none;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h2 id="resultParentName"></h2>
                    <p>‰∏ÄÁï™Â¨â„Åó„ÅÑ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
                </div>
                <div id="resultKeywords" class="keyword-grid"></div>
                <div id="waitingForResult" class="waiting-message" style="display: none;">
                    Ë¶™„ÅåÈÅ∏Êäû‰∏≠„Åß„Åô...
                </div>
            </div>

            <!-- ÂãùËÄÖÁô∫Ë°® -->
            <div id="winnerPhase" style="display: none;">
                <div id="winnerAnnouncement" class="winner-announcement"></div>
                <div style="text-align: center; margin: 20px 0;">
                    <h3>ÂÖ®„Å¶„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ</h3>
                    <div id="allKeywords" class="keyword-grid"></div>
                </div>
                <div id="hostControls" class="controls" style="display: none;">
                    <button class="btn btn-secondary" onclick="newRound()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å∂</button>
                    <button class="btn" onclick="endGame()">ÁµÇ‰∫Ü</button>
                </div>
                <div id="waitingForHost2" class="waiting-message" style="display: none;">
                    „Éõ„Çπ„Éà„ÅåÊ¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû‰∏≠...
                </div>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyAAIHomOgar3jFGm3aGhvODUovpptLCAkY",
            authDomain: "home-b8b3f.firebaseapp.com",
            databaseURL: "https://home-b8b3f-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "home-b8b3f",
            storageBucket: "home-b8b3f.firebasestorage.app",
            messagingSenderId: "974096301624",
            appId: "1:974096301624:web:b35f4ffc8b69db9007b0cd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // „Ç≠„Éº„ÉØ„Éº„Éâ„Éá„Éº„Çø
        const keywords = {
            male: [
                '„Åã„Å£„Åì„ÅÑ„ÅÑ', '„Ç§„Ç±„É°„É≥', 'È†º„ÇÇ„Åó„ÅÑ', 'ÂÑ™„Åó„ÅÑ', 'Èù¢ÁôΩ„ÅÑ', 'Ë≥¢„ÅÑ', '„Çª„É≥„Çπ„Åå„ÅÑ„ÅÑ',
                'Áî∑„Çâ„Åó„ÅÑ', '„ÉÄ„É≥„Éá„Ç£', '„Çπ„Çø„Ç§„É™„ÉÉ„Ç∑„É•', 'È≠ÖÂäõÁöÑ', 'Á¥†Êïµ', '„ÇØ„Éº„É´', '„ÉØ„Ç§„É´„Éâ',
                'Á¥≥Â£´ÁöÑ', 'Âô®„ÅåÂ§ß„Åç„ÅÑ', 'ÂåÖÂÆπÂäõ„Åå„ÅÇ„Çã', 'Ë≤¨‰ªªÊÑü„ÅåÂº∑„ÅÑ', 'Ê±∫Êñ≠Âäõ„Åå„ÅÇ„Çã', 'Ë°åÂãïÂäõ„Åå„ÅÇ„Çã',
                '„É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„Éó„Åå„ÅÇ„Çã', '‰ø°È†º„Åß„Åç„Çã', 'Ë™†ÂÆü', 'Ê≠£Áæ©ÊÑü„ÅåÂº∑„ÅÑ', 'Âä™ÂäõÂÆ∂', 'Âêë‰∏äÂøÉ„Åå„ÅÇ„Çã',
                '„Éù„Ç∏„ÉÜ„Ç£„Éñ', 'Êòé„Çã„ÅÑ', '„É¶„Éº„É¢„Ç¢„Åå„ÅÇ„Çã', 'Ê∞óÈÖç„Çä„Åå„Åß„Åç„Çã', 'ÊÄù„ÅÑ„ÇÑ„Çä„Åå„ÅÇ„Çã', 'Ê∏©Âíå'
            ],
            female: [
                'Áæé„Åó„ÅÑ', '„Åã„Çè„ÅÑ„ÅÑ', 'Á¥†Êïµ', '„Åç„Çå„ÅÑ', '‰∏äÂìÅ', '„Ç®„É¨„Ç¨„É≥„Éà', '„Åä„Åó„ÇÉ„Çå',
                'ÂÑ™„Åó„ÅÑ', 'ÊÄù„ÅÑ„ÇÑ„Çä„Åå„ÅÇ„Çã', 'Ê∏©„Åã„ÅÑ', 'ÂåÖÂÆπÂäõ„Åå„ÅÇ„Çã', 'ÊØçÊÄßÁöÑ', 'Áôí„ÅóÁ≥ª', 'Â§©‰Ωø„Åø„Åü„ÅÑ',
                'Á¨ëÈ°î„ÅåÁ¥†Êïµ', 'Êòé„Çã„ÅÑ', '„Éù„Ç∏„ÉÜ„Ç£„Éñ', 'ÂÖÉÊ∞ó', '„Éë„ÉØ„Éï„É´', '„Ç®„Éç„É´„ÇÆ„ÉÉ„Ç∑„É•', '„Éê„Ç§„Çø„É™„ÉÜ„Ç£„Åå„ÅÇ„Çã',
                'Ë≥¢„ÅÑ', 'Áü•ÁöÑ', 'ÊïôÈ§ä„Åå„ÅÇ„Çã', 'ÂçöÂ≠¶', 'Ê¥ûÂØüÂäõ„Åå„ÅÇ„Çã', 'Âà§Êñ≠Âäõ„Åå„ÅÇ„Çã', 'ÂÜ∑Èùô',
                'Ê∞óÈÖç„Çä„Åå„Åß„Åç„Çã', 'Á¥∞„ÇÑ„Åã„Å™ÂøÉÈÅ£„ÅÑ', '„Çµ„Éº„Éì„ÇπÁ≤æÁ•û', '„Éõ„Çπ„Éî„Çø„É™„ÉÜ„Ç£', 'Ë¶™Âàá', '‰∏ñË©±Â•Ω„Åç'
            ]
        };

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentGameCode = '';
        let myPlayerId = '';
        let isHost = false;
        let gameData = null;
        let unsubscribe = null;
        let selectedGender = { host: 'male', join: 'male' };
        let selectedKeywordIndex = -1;
        let hasReset = false;

        // Êé•Á∂öÁä∂ÊÖãÊõ¥Êñ∞
        function updateConnectionStatus(connected) {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                statusIcon.textContent = 'üü¢';
                statusText.textContent = 'FirebaseÊé•Á∂ö‰∏≠';
                status.className = 'connection-status status-online';
            } else {
                statusIcon.textContent = 'üî¥';
                statusText.textContent = 'Êé•Á∂ö„Ç®„É©„Éº';
                status.className = 'connection-status status-offline';
            }
        }

        // ÂàùÊúüÊé•Á∂öÁ¢∫Ë™ç
        setTimeout(() => updateConnectionStatus(true), 1000);

        // „Ç≤„Éº„É†„Ç≥„Éº„ÉâÁîüÊàê
        function generateGameCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // ÁîªÈù¢Âàá„ÇäÊõø„Åà
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // „Éõ„Çπ„Éà„Ç≤„Éº„É†ÈñãÂßã
        window.startHostGame = function() {
            currentGameCode = generateGameCode();
            isHost = true;
            document.getElementById('gameCodeDisplay').textContent = currentGameCode;
            showScreen('hostScreen');
        }

        // ÂèÇÂä†ÁîªÈù¢Ë°®Á§∫
        window.showJoinScreen = function() {
            showScreen('joinScreen');
        }

        // „É°„Éã„É•„ÉºÁîªÈù¢Ë°®Á§∫
        window.showMenuScreen = function() {
            if (unsubscribe) unsubscribe();
            showScreen('menuScreen');
        }

        // ÊÄßÂà•ÈÅ∏Êäû
        window.selectGender = function(type, gender) {
            selectedGender[type] = gender;
            const buttons = document.querySelectorAll(`#${type}Screen .gender-btn`);
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        // „Éõ„Çπ„ÉàÂèÇÂä†
        window.joinAsHost = async function() {
            const name = document.getElementById('hostName').value.trim();
            if (!name) {
                showError('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            myPlayerId = Date.now().toString();
            
            const initialGameData = {
                gameCode: currentGameCode,
                host: myPlayerId,
                phase: 'lobby',
                players: [{
                    id: myPlayerId,
                    name: name,
                    gender: selectedGender.host,
                    isHost: true,
                    joinedAt: Date.now()
                }],
                parent: null,
                currentVoter: 0,
                votes: [],
                keywordSet: [],
                revealedKeywords: [],
                revealIndex: 0,
                winner: null,
                createdAt: Date.now()
            };

            try {
                await setDoc(doc(db, 'games', currentGameCode), initialGameData);
                subscribeToGame();
                showScreen('lobbyScreen');
            } catch (error) {
                showError('„Ç≤„Éº„É†‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // „Ç≤„Éº„É†ÂèÇÂä†
        window.joinGame = async function() {
            const gameCode = document.getElementById('joinGameCode').value.trim().toUpperCase();
            const name = document.getElementById('joinName').value.trim();
            
            if (!gameCode || !name) {
                showError('„Ç≤„Éº„É†„Ç≥„Éº„Éâ„Å®ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            currentGameCode = gameCode;
            myPlayerId = Date.now().toString();

            const newPlayer = {
                id: myPlayerId,
                name: name,
                gender: selectedGender.join,
                isHost: false,
                joinedAt: Date.now()
            };

            try {
                await updateDoc(doc(db, 'games', currentGameCode), {
                    players: arrayUnion(newPlayer)
                });
                
                subscribeToGame();
                showScreen('lobbyScreen');
            } catch (error) {
                showError('„Ç≤„Éº„É†ÂèÇÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message);
            }
        }

        // FirebaseË≥ºË™≠ÈñãÂßã
        function subscribeToGame() {
            if (unsubscribe) unsubscribe();
            
            unsubscribe = onSnapshot(doc(db, 'games', currentGameCode), (doc) => {
                if (doc.exists()) {
                    gameData = doc.data();
                    updateUI();
                    updateConnectionStatus(true);
                } else {
                    showError('„Ç≤„Éº„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    updateConnectionStatus(false);
                }
            }, (error) => {
                showError('Êé•Á∂ö„Ç®„É©„Éº: ' + error.message);
                updateConnectionStatus(false);
            });
        }

        // UIÊõ¥Êñ∞
        function updateUI() {
            if (!gameData) return;

            const phase = gameData.phase;
            const players = gameData.players || [];
            const myPlayer = players.find(p => p.id === myPlayerId);
            
            if (!myPlayer) return;

            isHost = myPlayer.isHost;

            if (phase === 'lobby') {
                updateLobby();
            } else if (phase === 'voting') {
                showScreen('gameScreen');
                updateVoting();
            } else if (phase === 'reveal') {
                showScreen('gameScreen');
                updateReveal();
            } else if (phase === 'result') {
                showScreen('gameScreen');
                updateResult();
            } else if (phase === 'winner') {
                showScreen('gameScreen');
                updateWinner();
            }
        }

        // „É≠„Éì„ÉºÊõ¥Êñ∞
        function updateLobby() {
            const players = gameData.players || [];
            document.getElementById('playerCount').textContent = players.length;
            document.getElementById('lobbyGameCode').textContent = currentGameCode;
            
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = players.map(player => `
                <div class="player-card">
                    <h3>${player.name} ${player.isHost ? 'üëë' : ''}</h3>
                    <p>${player.gender === 'male' ? 'üë® Áî∑ÊÄß' : 'üë© Â•≥ÊÄß'}</p>
                </div>
            `).join('');

            // „Éõ„Çπ„Éà„ÅÆÂ†¥Âêà„ÄÅË¶™ÈÅ∏Êäû„ÇíË°®Á§∫
            if (isHost && players.length >= 3) {
                document.getElementById('parentSelection').style.display = 'block';
                document.getElementById('waitingForHost').style.display = 'none';
                
                const parentOptions = document.getElementById('parentOptions');
                parentOptions.innerHTML = players.map(player => `
                    <div class="player-card ${gameData.parent?.id === player.id ? 'parent' : ''}" onclick="selectParent('${player.id}')">
                        <h3>${player.name}</h3>
                        <p>${player.gender === 'male' ? 'üë® Áî∑ÊÄß' : 'üë© Â•≥ÊÄß'}</p>
                    </div>
                `).join('');

                document.getElementById('startGameBtn').disabled = !gameData.parent;
            } else if (!isHost) {
                document.getElementById('parentSelection').style.display = 'none';
                document.getElementById('waitingForHost').style.display = players.length >= 3 ? 'block' : 'none';
            }
        }

        // Ë¶™ÈÅ∏Êäû
        window.selectParent = async function(playerId) {
            const parent = gameData.players.find(p => p.id === playerId);
            try {
                await updateDoc(doc(db, 'games', currentGameCode), {
                    parent: parent
                });
            } catch (error) {
                showError('Ë¶™„ÅÆÈÅ∏Êäû„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        window.startGame = async function() {
            if (!gameData.parent) {
                showError('Ë¶™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const keywordList = keywords[gameData.parent.