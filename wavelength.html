<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
    <title>ã‚¦ã‚§ãƒ¼ãƒ–ãƒ¬ãƒ³ã‚°ã‚¹ ãƒãƒ¼ãƒ æˆ¦</title>
    <style>
        :root{
            --zone-4-color:#03A9F4;
            --zone-3-color:#FF9800;
            --zone-2-color:#FFC107;
            --needle-color:#F44336;
            --text-color:#333;
            --dial-frame-color:#3D4A5E;
            --red-team-color:#FF5252;
            --blue-team-color:#2196F3;
            --red-team-bg:#FFEBEE;
            --blue-team-bg:#E3F2FD;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:16px;
            color:var(--text-color);
            transition: background-color 0.5s ease;
        }
        
        /* ãƒãƒ¼ãƒ èƒŒæ™¯è‰² */
        .red-team-turn { background-color: var(--red-team-bg); }
        .blue-team-turn { background-color: var(--blue-team-bg); }
        .neutral-bg { background-color: #F0F2F5; }

        .game-container{
            width:100%;
            max-width:520px;
            background:#fff;
            border-radius:16px;
            padding:20px;
            box-shadow:0 10px 30px rgba(0,0,0,0.08);
        }
        
        .header{text-align:center;margin-bottom:14px;border-bottom:1px solid #eee;padding-bottom:12px;}
        .title{font-size:1.6rem;color:var(--dial-frame-color)}
        
        /* ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ */
        .scoreboard{
            display:flex;
            justify-content:space-between;
            margin-bottom:16px;
            padding:12px;
            background:#f8f9fa;
            border-radius:10px;
        }
        
        .team-score{
            text-align:center;
            padding:8px 16px;
            border-radius:8px;
            font-weight:700;
            font-size:1.1rem;
        }
        
        .red-team-score{
            background:var(--red-team-bg);
            color:var(--red-team-color);
            border:2px solid var(--red-team-color);
        }
        
        .blue-team-score{
            background:var(--blue-team-bg);
            color:var(--blue-team-color);
            border:2px solid var(--blue-team-color);
        }
        
        .current-team{
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
            transform:scale(1.05);
        }

        .topic-display{background:#f8f9fa;border-radius:10px;padding:12px;margin-bottom:16px}
        .topic-text{display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:1.1rem}
        .phase-content{text-align:center}
        .phase-description{color:#666;margin-bottom:10px}
        
        .team-indicator{
            font-size:1.3rem;
            font-weight:800;
            margin-bottom:12px;
            padding:8px 16px;
            border-radius:8px;
            display:inline-block;
        }
        
        .red-team-indicator{
            background:var(--red-team-color);
            color:white;
        }
        
        .blue-team-indicator{
            background:var(--blue-team-color);
            color:white;
        }

        .btn{width:100%;padding:12px;border:none;border-radius:40px;background:linear-gradient(45deg,#2196F3,#03A9F4);color:white;font-weight:700;cursor:pointer;margin:8px 0;}
        .btn-secondary{background:linear-gradient(45deg,#673AB7,#9C27B0)}
        .btn-red{background:linear-gradient(45deg,#F44336,#FF5252)}
        .btn-blue{background:linear-gradient(45deg,#1976D2,#2196F3)}
        
        .vote-buttons{
            display:flex;
            gap:12px;
            margin:16px 0;
        }
        
        .vote-btn{
            flex:1;
            padding:16px;
            border:none;
            border-radius:12px;
            font-weight:700;
            font-size:1.1rem;
            cursor:pointer;
            transition:transform 0.2s ease;
        }
        
        .vote-btn:hover{
            transform:translateY(-2px);
        }
        
        .vote-left{
            background:linear-gradient(45deg,#9C27B0,#E91E63);
            color:white;
        }
        
        .vote-right{
            background:linear-gradient(45deg,#2196F3,#00BCD4);
            color:white;
        }
        
        .hidden{display:none}

        /* åŠå††ãƒ€ã‚¤ãƒ¤ãƒ« */
        .wavelength-dial{
            position:relative;
            width:320px;
            max-width:100%;
            height:160px;
            margin:20px auto;
            border-top-left-radius:160px;
            border-top-right-radius:160px;
            background:#E0E5EC;
            border:8px solid var(--dial-frame-color);
            overflow:visible;
        }

        .wavelength-dial svg{
            position:absolute;
            left:0;
            top:0;
            width:100%;
            height:100%;
            overflow:visible;
        }

        /* é‡ */
        .needle{
            position:absolute;
            left:50%;
            bottom:0;
            width:4px;
            height:140px;
            background:var(--needle-color);
            transform-origin:50% 100%;
            transform:translateX(-50%) rotate(0deg);
            box-shadow:0 0 10px rgba(0,0,0,0.18);
            z-index:6;
            border-radius:2px;
        }

        /* ãƒãƒ–ï¼ˆèµ¤ã„ä¸¸ï¼‰ */
        .knob{
            position:absolute;
            width:32px;
            height:32px;
            border-radius:50%;
            background:var(--needle-color);
            border:4px solid #fff;
            box-shadow:0 6px 14px rgba(0,0,0,0.15);
            transform:translate(-50%,-50%);
            z-index:7;
            touch-action:none;
            cursor:grab;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        
        .knob:hover{
            transform:translate(-50%,-50%) scale(1.05);
            box-shadow:0 8px 18px rgba(0,0,0,0.2);
        }
        
        .knob:active, .knob.dragging{
            cursor:grabbing;
            transform:translate(-50%,-50%) scale(1.1);
            box-shadow:0 10px 20px rgba(0,0,0,0.3);
        }

        .gauge-value{
            font-weight:700;
            margin:10px 0;
            font-size:1.2rem;
            color:var(--dial-frame-color);
        }
        
        .score-display{
            font-size:1.8rem;
            font-weight:800;
            margin-top:16px;
        }
        
        .result-summary{
            background:#f8f9fa;
            padding:16px;
            border-radius:10px;
            margin:16px 0;
        }

        .zone-legend{
            display:flex;
            justify-content:center;
            gap:20px;
            margin:15px 0;
            flex-wrap:wrap;
        }
        
        .zone-item{
            display:flex;
            align-items:center;
            gap:5px;
            font-size:0.9rem;
            font-weight:600;
        }
        
        .zone-color{
            width:20px;
            height:20px;
            border-radius:4px;
        }
        
        .instructions{
            background:#f8f9fa;
            padding:12px;
            border-radius:8px;
            margin:10px 0;
            font-size:0.95rem;
            color:#666;
        }
        
        .winner-announcement{
            font-size:2rem;
            font-weight:800;
            margin:20px 0;
            padding:20px;
            border-radius:12px;
            text-align:center;
        }
        
        .red-winner{
            background:var(--red-team-bg);
            color:var(--red-team-color);
            border:3px solid var(--red-team-color);
        }
        
        .blue-winner{
            background:var(--blue-team-bg);
            color:var(--blue-team-color);
            border:3px solid var(--blue-team-color);
        }
    </style>
</head>
<body class="neutral-bg">
    <div class="game-container">
        <div class="header">
            <div class="title">ã‚¦ã‚§ãƒ¼ãƒ–ãƒ¬ãƒ³ã‚°ã‚¹ ãƒãƒ¼ãƒ æˆ¦</div>
        </div>

        <!-- ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
        <div class="scoreboard" id="scoreboard">
            <div class="team-score red-team-score" id="redTeamScore">
                <div>èµ¤ãƒãƒ¼ãƒ </div>
                <div>0ç‚¹</div>
            </div>
            <div class="team-score blue-team-score" id="blueTeamScore">
                <div>é’ãƒãƒ¼ãƒ </div>
                <div>0ç‚¹</div>
            </div>
        </div>

        <div class="topic-display">
            <div class="topic-text" id="topicText"><span>-</span><span>â‡”</span><span>-</span></div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º1: ã‚²ãƒ¼ãƒ é–‹å§‹ -->
        <div class="game-phase" id="phase-start">
            <div class="phase-content">
                <p class="phase-description">æ–°ã—ã„ãƒãƒ¼ãƒ æˆ¦ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>
                <div class="instructions">
                    11ç‚¹å…ˆå–ã§å‹åˆ©ï¼<br>
                    åŒç‚¹ã®å ´åˆã¯ã‚µãƒ‰ãƒ³ãƒ‡ã‚¹æˆ¦
                </div>
                <button class="btn" onclick="startNewGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º2: ãƒ©ã‚¦ãƒ³ãƒ‰é–‹å§‹ -->
        <div class="game-phase hidden" id="phase-round-start">
            <div class="phase-content">
                <div class="team-indicator" id="currentTeamIndicator">èµ¤ãƒãƒ¼ãƒ </div>
                <p class="phase-description">æ–°ã—ã„ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™</p>
                <button class="btn" id="roundStartBtn" onclick="startRound()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º3: ãŠé¡Œè¡¨ç¤º -->
        <div class="game-phase hidden" id="phase-topic">
            <div class="phase-content">
                <div class="team-indicator" id="topicTeamIndicator">èµ¤ãƒãƒ¼ãƒ </div>
                <p class="phase-description">ãŠé¡ŒãŒæ±ºã¾ã‚Šã¾ã—ãŸ</p>
                <button class="btn" onclick="goToHintPhase()">ãƒ’ãƒ³ãƒˆå½¹ã¸</button>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º4: ãƒ’ãƒ³ãƒˆå‡ºã—å½¹ç”¨ï¼ˆæ­£è§£ã‚¨ãƒªã‚¢è¡¨ç¤ºï¼‰-->
        <div class="game-phase hidden" id="phase-psychic">
            <div class="phase-content">
                <div class="team-indicator" id="psychicTeamIndicator">èµ¤ãƒãƒ¼ãƒ </div>
                <h3>ãƒ’ãƒ³ãƒˆå‡ºã—å½¹ã¸</h3>
                <p class="phase-description">ã“ã®æ­£è§£ã‚¨ãƒªã‚¢ã‚’è¦‹ã¦ã€å£é ­ã§ãƒ’ãƒ³ãƒˆã‚’å‡ºã—ã¦ãã ã•ã„</p>
                
                <div class="wavelength-dial" id="psychic-dial">
                    <svg id="psychic-svg" viewBox="0 0 320 160" preserveAspectRatio="none" aria-hidden="true"></svg>
                </div>
                
                <div class="zone-legend">
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-4-color)"></div>
                        <span>4ç‚¹</span>
                    </div>
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-3-color)"></div>
                        <span>3ç‚¹</span>
                    </div>
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-2-color)"></div>
                        <span>2ç‚¹</span>
                    </div>
                </div>
                
                <button class="btn" onclick="goToVotePhase()">æ¨æ¸¬ãƒ•ã‚§ãƒ¼ã‚ºã¸</button>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º5: æŠ•ç¥¨ -->
        <div class="game-phase hidden" id="phase-vote">
            <div class="phase-content">
                <div class="team-indicator" id="voteTeamIndicator">é’ãƒãƒ¼ãƒ </div>
                <h3>å³ã‹å·¦ã‹ã‚’æŠ•ç¥¨ã—ã¦ãã ã•ã„</h3>
                <p class="phase-description">ãƒ’ãƒ³ãƒˆã‚’èã„ã¦ã€ç­”ãˆãŒå³å¯„ã‚Šã‹å·¦å¯„ã‚Šã‹ã‚’äºˆæƒ³</p>
                
                <div class="vote-buttons">
                    <button class="vote-btn vote-left" onclick="submitVote('left')">
                        <div id="leftLabel">å·¦å¯„ã‚Š</div>
                    </button>
                    <button class="vote-btn vote-right" onclick="submitVote('right')">
                        <div id="rightLabel">å³å¯„ã‚Š</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º6: æ¨æ¸¬ï¼ˆå›ç­”è€…ï¼‰-->
        <div class="game-phase hidden" id="phase-guess">
            <div class="phase-content">
                <div class="team-indicator" id="guessTeamIndicator">èµ¤ãƒãƒ¼ãƒ </div>
                <h3>æ­£ç¢ºãªä½ç½®ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„</h3>
                <div class="instructions">
                    èµ¤ã„ä¸¸ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã€ãƒ’ãƒ³ãƒˆãŒç¤ºã™ä½ç½®ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„
                </div>

                <div class="wavelength-dial" id="guess-dial">
                    <svg id="guess-svg" viewBox="0 0 320 160" preserveAspectRatio="none" aria-hidden="true"></svg>
                    <div class="needle" id="needle"></div>
                    <div class="knob" id="knob" role="slider" aria-valuemin="0" aria-valuemax="100" tabindex="0"></div>
                </div>

                <div class="gauge-value">æ¨æ¸¬å€¤: <span id="gaugeValue">50</span>%</div>
                <button class="btn" onclick="submitGuess()">ã“ã‚Œã§æ±ºå®šï¼</button>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º7: çµæœ -->
        <div class="game-phase hidden" id="phase-result">
            <div class="phase-content">
                <h3>çµæœç™ºè¡¨ï¼</h3>

                <div class="wavelength-dial" id="result-dial">
                    <svg id="result-svg" viewBox="0 0 320 160" preserveAspectRatio="none" aria-hidden="true"></svg>
                    <div class="needle" id="result-needle"></div>
                </div>

                <div class="zone-legend">
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-4-color)"></div>
                        <span>4ç‚¹</span>
                    </div>
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-3-color)"></div>
                        <span>3ç‚¹</span>
                    </div>
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-2-color)"></div>
                        <span>2ç‚¹</span>
                    </div>
                </div>

                <div class="result-summary" id="resultSummary">
                    <div class="score-display" id="scoreDisplay">çµæœè¨ˆç®—ä¸­...</div>
                </div>
                
                <button class="btn btn-secondary" id="nextRoundBtn" onclick="nextRound()">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰</button>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ¼ã‚º8: å‹æ•—æ±ºå®š -->
        <div class="game-phase hidden" id="phase-game-over">
            <div class="phase-content">
                <div class="winner-announcement" id="winnerAnnouncement">
                    å‹æ•—æ±ºå®šï¼
                </div>
                
                <div class="result-summary">
                    <div id="finalScores"></div>
                </div>
                
                <button class="btn" onclick="startNewGame()">æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
    // --- DOM ---
    const topicTextEl = document.getElementById('topicText');
    const gaugeValueEl = document.getElementById('gaugeValue');
    const scoreDisplayEl = document.getElementById('scoreDisplay');
    const redTeamScoreEl = document.getElementById('redTeamScore');
    const blueTeamScoreEl = document.getElementById('blueTeamScore');
    const resultSummaryEl = document.getElementById('resultSummary');

    const guessDial = document.getElementById('guess-dial');
    const guessSvg = document.getElementById('guess-svg');
    const psychicSvg = document.getElementById('psychic-svg');
    const resultSvg = document.getElementById('result-svg');

    const needleEl = document.getElementById('needle');
    const knobEl = document.getElementById('knob');
    const resultNeedleEl = document.getElementById('result-needle');

    // --- çŠ¶æ…‹ ---
    const gameState = {
        currentTeam: 'red', // 'red' or 'blue'
        firstTeam: 'red',   // å…ˆè¡Œãƒãƒ¼ãƒ 
        redScore: 0,
        blueScore: 0,
        targetScore: 11,
        isSuddenDeath: false,
        roundCount: 0,
        
        topic: null,
        targetAngle: 0, // -90 .. +90
        guessAngle: 0,  // -90 .. +90
        vote: null,     // 'left' or 'right'
        roundScore: 0,
        voteScore: 0
    };

    const dialState = { isDragging: false };

    // å¾—ç‚¹ã‚¾ãƒ¼ãƒ³è¨­å®šï¼ˆå†…å´ã‹ã‚‰å¤–å´ã¸ï¼‰
    const scoreZones = [
        { points: 4, width: 8, color: '#03A9F4' }, // æ°´è‰²ï¼ˆæœ€ã‚‚ç‹­ã„ï¼‰
        { points: 3, width: 20, color: '#FF9800' }, // ã‚ªãƒ¬ãƒ³ã‚¸
        { points: 2, width: 32, color: '#FFC107' }  // é»„è‰²ï¼ˆæœ€ã‚‚åºƒã„ï¼‰
    ];

    const topics = [
        {left:"ä¸‹æ‰‹", right:"ä¸Šæ‰‹"}, {left:"ã‚¢ãƒŠãƒ­ã‚°", right:"ãƒ‡ã‚¸ã‚¿ãƒ«"},
        {left:"ç„¡å", right:"æœ‰å"}, {left:"æ‚ª", right:"å–„"},
        {left:"ãƒ€ã‚µã„", right:"ãŠã—ã‚ƒã‚Œ"}, {left:"å¿…é ˆ", right:"ä¸è¦"},
        {left:"å†·ãŸã„", right:"ç†±ã„"}, {left:"æ±šã„", right:"ãã‚Œã„"},
        {left:"æ™®é€š", right:"å¤‰ã‚ã£ã¦ã‚‹"}, {left:"è»½çŠ¯ç½ª", right:"é‡ç½ª"},
        {left:"å¤ã„", right:"æ–°ã—ã„"}, {left:"ç°¡å˜", right:"é›£ã—ã„"},
        {left:"å®‰ã„", right:"é«˜ã„"}, {left:"æš—ã„", right:"æ˜ã‚‹ã„"},
        {left:"é…ã„", right:"é€Ÿã„"}, {left:"å°ã•ã„", right:"å¤§ãã„"}
    ];

    // --- ãƒãƒ¼ãƒ ç®¡ç† ---
    function updateTeamDisplay() {
        const isRed = gameState.currentTeam === 'red';
        document.body.className = isRed ? 'red-team-turn' : 'blue-team-turn';
        
        // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰æ›´æ–°
        redTeamScoreEl.innerHTML = `<div>èµ¤ãƒãƒ¼ãƒ </div><div>${gameState.redScore}ç‚¹</div>`;
        blueTeamScoreEl.innerHTML = `<div>é’ãƒãƒ¼ãƒ </div><div>${gameState.blueScore}ç‚¹</div>`;
        
        // ç¾åœ¨ã®ãƒãƒ¼ãƒ ã‚’å¼·èª¿
        redTeamScoreEl.classList.toggle('current-team', isRed);
        blueTeamScoreEl.classList.toggle('current-team', !isRed);
        
        // ãƒãƒ¼ãƒ è¡¨ç¤ºæ›´æ–°
        const teamName = isRed ? 'èµ¤ãƒãƒ¼ãƒ ' : 'é’ãƒãƒ¼ãƒ ';
        document.querySelectorAll('.team-indicator').forEach(el => {
            el.textContent = teamName;
            el.className = isRed ? 'team-indicator red-team-indicator' : 'team-indicator blue-team-indicator';
        });
        
        // æŠ•ç¥¨ç›¸æ‰‹ãƒãƒ¼ãƒ è¡¨ç¤º
        const voteTeamName = isRed ? 'é’ãƒãƒ¼ãƒ ' : 'èµ¤ãƒãƒ¼ãƒ ';
        const voteIndicator = document.getElementById('voteTeamIndicator');
        if (voteIndicator) {
            voteIndicator.textContent = voteTeamName;
            voteIndicator.className = isRed ? 'team-indicator blue-team-indicator' : 'team-indicator red-team-indicator';
        }
        
        // æŠ•ç¥¨ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«æ›´æ–°
        if (gameState.topic) {
            document.getElementById('leftLabel').textContent = gameState.topic.left + 'å¯„ã‚Š';
            document.getElementById('rightLabel').textContent = gameState.topic.right + 'å¯„ã‚Š';
        }
    }

    function switchTeam() {
        gameState.currentTeam = gameState.currentTeam === 'red' ? 'blue' : 'red';
    }

    // --- ãƒ•ã‚§ãƒ¼ã‚ºæ“ä½œ ---
    function showPhase(phaseId){
        document.querySelectorAll('.game-phase').forEach(p => p.classList.add('hidden'));
        document.getElementById(phaseId).classList.remove('hidden');
    }

    function startNewGame(){
        // åˆæœŸåŒ–
        gameState.redScore = 0;
        gameState.blueScore = 0;
        gameState.roundCount = 0;
        gameState.isSuddenDeath = false;
        
        // å…ˆè¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ æ±ºå®š
        gameState.firstTeam = Math.random() < 0.5 ? 'red' : 'blue';
        gameState.currentTeam = gameState.firstTeam;
        
        updateTeamDisplay();
        document.body.className = 'neutral-bg';
        showPhase('phase-round-start');
    }

    function startRound(){
        // æ–°ã—ã„ãŠé¡Œç”Ÿæˆ
        gameState.topic = topics[Math.floor(Math.random()*topics.length)];
        // -90åº¦ã‹ã‚‰+90åº¦ã®ç¯„å›²ï¼ˆ0%ã€œ100%ã‚’ã‚«ãƒãƒ¼ï¼‰
        gameState.targetAngle = Math.random()*180 - 90;
        gameState.vote = null;
        gameState.roundScore = 0;
        gameState.voteScore = 0;

        topicTextEl.innerHTML = `<span>${gameState.topic.left}</span><span>â‡”</span><span>${gameState.topic.right}</span>`;
        
        updateTeamDisplay();
        showPhase('phase-topic');
    }

    function goToHintPhase(){
        // æç”»ï¼ˆå¿ƒç†å½¹ç”¨ï¼‰
        drawScoreZonesSVG(psychicSvg, gameState.targetAngle);
        updateTeamDisplay();
        showPhase('phase-psychic');
    }

    function goToVotePhase(){
        updateTeamDisplay();
        showPhase('phase-vote');
    }

    function submitVote(vote){
        gameState.vote = vote;
        goToGuessPhase();
    }

    function goToGuessPhase(){
        // Guessç”¨ãƒ€ã‚¤ãƒ¤ãƒ«ã¯èƒŒæ™¯ã®ã¿ï¼ˆã‚¾ãƒ¼ãƒ³éè¡¨ç¤ºï¼‰
        drawScoreZonesSVG(guessSvg, null);
        
        gameState.guessAngle = 0;
        updateNeedle(needleEl, 0);
        updateGaugeValue(0);
        positionKnobByAngle(knobEl, guessDial, 0);

        updateTeamDisplay();
        showPhase('phase-guess');
    }

    function submitGuess(){
        // å¾—ç‚¹è¨ˆç®—
        calculateScores();

        // è¡¨ç¤ºæ›´æ–°
        showResults();

        // çµæœãƒ€ã‚¤ãƒ¤ãƒ«ï¼ˆæ­£è§£ã‚¾ãƒ¼ãƒ³ã‚’è¡¨ç¤ºï¼‰
        drawScoreZonesSVG(resultSvg, gameState.targetAngle);
        updateNeedle(resultNeedleEl, gameState.guessAngle);

        showPhase('phase-result');
    }

    function calculateScores(){
        const diff = Math.abs(gameState.guessAngle - gameState.targetAngle);
        let mainScore = 0;
        
        // ãƒ¡ã‚¤ãƒ³ãƒãƒ¼ãƒ ã®å¾—ç‚¹è¨ˆç®—ï¼ˆæœ€ã‚‚ç‹­ã„ã‚¾ãƒ¼ãƒ³ã‹ã‚‰é †ã«ãƒã‚§ãƒƒã‚¯ï¼‰
        scoreZones.slice().sort((a,b)=>a.width - b.width).forEach(zone=>{
            if (diff <= zone.width/2){
                if (zone.points > mainScore) mainScore = zone.points;
            }
        });
        
        gameState.roundScore = mainScore;
        
        // æŠ•ç¥¨ãƒãƒ¼ãƒ ã®å¾—ç‚¹è¨ˆç®— - ä¿®æ­£ï¼šæ­£è§£ã‚¨ãƒªã‚¢ã®ä½ç½®ã§åˆ¤å®š
        let voteScore = 0;
        if (gameState.vote) {
            // æ­£è§£ã‚¨ãƒªã‚¢ï¼ˆtargetAngleï¼‰ãŒå³å¯„ã‚Šã‹å·¦å¯„ã‚Šã‹ã§åˆ¤å®š
            const isTargetRight = gameState.targetAngle > 0;
            const voteRight = gameState.vote === 'right';
            
            if ((isTargetRight && voteRight) || (!isTargetRight && !voteRight)) {
                voteScore = 1; // æŠ•ç¥¨ãŒå½“ãŸã£ãŸå ´åˆ
            }
        }
        
        gameState.voteScore = voteScore;
        
        // ã‚¹ã‚³ã‚¢åŠ ç®—
        if (gameState.currentTeam === 'red') {
            gameState.redScore += mainScore;
            gameState.blueScore += voteScore;
        } else {
            gameState.blueScore += mainScore;
            gameState.redScore += voteScore;
        }
    }

    function showResults(){
        const mainTeamName = gameState.currentTeam === 'red' ? 'èµ¤ãƒãƒ¼ãƒ ' : 'é’ãƒãƒ¼ãƒ ';
        const voteTeamName = gameState.currentTeam === 'red' ? 'é’ãƒãƒ¼ãƒ ' : 'èµ¤ãƒãƒ¼ãƒ ';
        
        const voteResult = gameState.voteScore > 0 ? 'æ­£è§£ï¼' : 'ä¸æ­£è§£';
        const voteText = gameState.vote === 'left' ? gameState.topic.left + 'å¯„ã‚Š' : gameState.topic.right + 'å¯„ã‚Š';
        
        // æ­£è§£ãŒå®Ÿéš›ã«ã©ã¡ã‚‰å¯„ã‚Šã ã£ãŸã‹ã‚’è¡¨ç¤º
        const actualSide = gameState.targetAngle > 0 ? gameState.topic.right + 'å¯„ã‚Š' : gameState.topic.left + 'å¯„ã‚Š';
        
        resultSummaryEl.innerHTML = `
            <div class="score-display">
                ${mainTeamName}: ${gameState.roundScore}ç‚¹ç²å¾—ï¼<br>
                ${voteTeamName}: ${voteText}ã«æŠ•ç¥¨<br>
                æ­£è§£ã¯${actualSide} â†’ ${voteResult} (+${gameState.voteScore}ç‚¹)
            </div>
        `;
        
        updateTeamDisplay();
        
        // æ¬¡ã®ãƒœã‚¿ãƒ³è¨­å®š
        const nextBtn = document.getElementById('nextRoundBtn');
        if (checkGameEnd()) {
            nextBtn.textContent = 'çµæœç™ºè¡¨';
            nextBtn.onclick = () => showGameOver();
        } else {
            nextBtn.textContent = 'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰';
            nextBtn.onclick = () => nextRound();
        }
    }

    function checkGameEnd(){
        const redWin = gameState.redScore >= gameState.targetScore;
        const blueWin = gameState.blueScore >= gameState.targetScore;
        
        if (gameState.isSuddenDeath) {
            // ã‚µãƒ‰ãƒ³ãƒ‡ã‚¹ä¸­ã¯ä¸¡ãƒãƒ¼ãƒ ãŒ1å›ãšã¤ãƒ—ãƒ¬ã‚¤ã—ãŸå¾Œã«åˆ¤å®š
            gameState.roundCount++;
            if (gameState.roundCount >= 2) {
                return gameState.redScore !== gameState.blueScore;
            }
        } else {
            if (redWin || blueWin) {
                if (gameState.redScore === gameState.blueScore) {
                    // åŒç‚¹ã®å ´åˆã¯ã‚µãƒ‰ãƒ³ãƒ‡ã‚¹
                    gameState.isSuddenDeath = true;
                    gameState.roundCount = 0;
                    return false;
                } else {
                    return true;
                }
            }
        }
        
        return false;
    }

    function nextRound(){
        if (gameState.isSuddenDeath && gameState.roundCount < 2) {
            // ã‚µãƒ‰ãƒ³ãƒ‡ã‚¹ä¸­ã¯ç›¸æ‰‹ãƒãƒ¼ãƒ ã®ç•ª
            switchTeam();
        } else {
            // é€šå¸¸ãƒ©ã‚¦ãƒ³ãƒ‰ï¼šå…ˆè¡Œå¾Œæ”»ã‚’å…¥ã‚Œæ›¿ãˆ
            switchTeam();
            gameState.firstTeam = gameState.currentTeam;
        }
        
        updateTeamDisplay();
        showPhase('phase-round-start');
    }

    function showGameOver(){
        const winner = gameState.redScore > gameState.blueScore ? 'red' : 'blue';
        const winnerName = winner === 'red' ? 'èµ¤ãƒãƒ¼ãƒ ' : 'é’ãƒãƒ¼ãƒ ';
        
        const winnerEl = document.getElementById('winnerAnnouncement');
        winnerEl.textContent = `ğŸ‰ ${winnerName} å‹åˆ©ï¼ ğŸ‰`;
        winnerEl.className = winner === 'red' ? 'winner-announcement red-winner' : 'winner-announcement blue-winner';
        
        document.getElementById('finalScores').innerHTML = `
            <div style="font-size:1.2rem; font-weight:700;">
                æœ€çµ‚ã‚¹ã‚³ã‚¢<br>
                èµ¤ãƒãƒ¼ãƒ : ${gameState.redScore}ç‚¹<br>
                é’ãƒãƒ¼ãƒ : ${gameState.blueScore}ç‚¹
            </div>
        `;
        
        document.body.className = winner === 'red' ? 'red-team-turn' : 'blue-team-turn';
        showPhase('phase-game-over');
    }

    // --- SVGæç”»ï¼ˆ3æ®µéšã®æ‰‡å½¢ã‚¾ãƒ¼ãƒ³ï¼‰ ---
    function drawScoreZonesSVG(svgEl, centerAngle){
        svgEl.innerHTML = '';
        if (centerAngle === null || centerAngle === undefined) {
            // èƒŒæ™¯ã®åŠå††ã®ã¿æç”»
            drawSemiCircleOutline(svgEl);
            return;
        }

        const W = 320, H = 160;
        const cx = W/2, cy = H;
        const r = W/2;

        // helper: åº¦->åº§æ¨™
        const degToPoint = (angleDeg) => {
            const rad = (angleDeg - 90) * Math.PI / 180;
            const x = cx + r * Math.cos(rad);
            const y = cy + r * Math.sin(rad);
            return {x,y};
        };

        // å¤–å´ã‹ã‚‰å†…å´ã¸æç”»ï¼ˆå¤§ãã„ã‚¾ãƒ¼ãƒ³ã‹ã‚‰å°ã•ã„ã‚¾ãƒ¼ãƒ³ã¸ï¼‰
        scoreZones.slice().sort((a,b)=>b.width - a.width).forEach(zone=>{
            const half = zone.width/2;
            let start = Math.max(-90, centerAngle - half);
            let end   = Math.min(90, centerAngle + half);
            if (end <= start) return;

            const p1 = degToPoint(start);
            const p2 = degToPoint(end);

            const largeArc = (Math.abs(end - start) > 180) ? 1 : 0;
            const sweep = 1;

            const d = `M ${cx} ${cy} L ${p1.x} ${p1.y} A ${r} ${r} 0 ${largeArc} ${sweep} ${p2.x} ${p2.y} Z`;

            const path = document.createElementNS('http://www.w3.org/2000/svg','path');
            path.setAttribute('d', d);
            path.setAttribute('fill', zone.color);
            path.setAttribute('opacity', 0.9);
            svgEl.appendChild(path);
        });

        drawSemiCircleOutline(svgEl);
    }

    function drawSemiCircleOutline(svgEl) {
        const W = 320, H = 160;
        const r = W/2;
        const cx = W/2, cy = H;
        
        const outline = document.createElementNS('http://www.w3.org/2000/svg','path');
        const left = {x: 0, y: H};
        const right = {x: W, y: H};
        outline.setAttribute('d', `M ${left.x} ${left.y} A ${r} ${r} 0 0 1 ${right.x} ${right.y}`);
        outline.setAttribute('stroke','rgba(61,74,94,0.9)');
        outline.setAttribute('stroke-width','4');
        outline.setAttribute('fill','none');
        svgEl.appendChild(outline);
    }

    // --- é‡ãƒ»ã‚²ãƒ¼ã‚¸æ›´æ–° ---
    function updateNeedle(el, angle){
        if(!el) return;
        el.style.transform = `translateX(-50%) rotate(${angle}deg)`;
    }
    
    function updateGaugeValue(angle){
        const val = Math.round(((angle + 90) / 180) * 100);
        if (gaugeValueEl) gaugeValueEl.textContent = val;
    }

    // --- ãƒãƒ–ã‚’å¼§ä¸Šã«ç§»å‹•ã•ã›ã‚‹ ---
    function positionKnobByAngle(knob, dialEl, angle){
        const W = 320, H = 160;
        const cx = W/2, cy = H, r = W/2;
        const rad = (angle - 90) * Math.PI / 180;
        const x = cx + r * Math.cos(rad);
        const y = cy + r * Math.sin(rad);
        
        const leftPct = (x / W) * 100;
        const topPct  = (y / H) * 100;
        knob.style.left = `${leftPct}%`;
        knob.style.top  = `${topPct}%`;
    }

    // --- æ”¹è‰¯ã•ã‚ŒãŸãƒ€ã‚¤ãƒ¤ãƒ«æ“ä½œ ---
    function handleDragStart(e){
        if (e.type === 'touchstart') e.preventDefault();
        dialState.isDragging = true;
        knobEl.classList.add('dragging');
    }

    function handleDragMove(e){
        if (!dialState.isDragging) return;
        if (e.type === 'touchmove') e.preventDefault();

        const dial = guessDial;
        const rect = dial.getBoundingClientRect();

        const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
        const clientY = (e.touches ? e.touches[0].clientY : e.clientY);

        // åŠå††ã®åº•è¾ºä¸­å¿ƒã‚’åŸºç‚¹
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height;

        const dx = clientX - centerX;
        const dy = centerY - clientY;

        // è§’åº¦è¨ˆç®— - dyã¨dxã‚’å…¥ã‚Œæ›¿ãˆã¦æ­£ã—ã„å‘ãã«
        let angle = Math.atan2(dx, dy) * 180 / Math.PI;
        // -90..+90ã«åˆ¶é™
        angle = Math.max(-90, Math.min(90, angle));

        gameState.guessAngle = angle;
        updateNeedle(needleEl, angle);
        updateGaugeValue(angle);
        positionKnobByAngle(knobEl, dial, angle);
    }

    function handleDragEnd(e){
        dialState.isDragging = false;
        knobEl.classList.remove('dragging');
    }

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼‰
    knobEl.addEventListener('keydown', (e)=>{
        let delta = 0;
        if (e.key === 'ArrowLeft' || e.key === 'ArrowDown'){
            delta = -5;
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp'){
            delta = 5;
        } else return;
        
        gameState.guessAngle = Math.max(-90, Math.min(90, gameState.guessAngle + delta));
        updateNeedle(needleEl, gameState.guessAngle);
        updateGaugeValue(gameState.guessAngle);
        positionKnobByAngle(knobEl, guessDial, gameState.guessAngle);
        e.preventDefault();
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
    knobEl.addEventListener('mousedown', handleDragStart);
    knobEl.addEventListener('touchstart', handleDragStart, {passive:false});
    window.addEventListener('mousemove', handleDragMove);
    window.addEventListener('touchmove', handleDragMove, {passive:false});
    window.addEventListener('mouseup', handleDragEnd);
    window.addEventListener('touchend', handleDragEnd);

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã«ãƒãƒ–ã‚’å†é…ç½®
    window.addEventListener('resize', ()=>{
        positionKnobByAngle(knobEl, guessDial, gameState.guessAngle);
    });

    // åˆæœŸè¡¨ç¤º
    showPhase('phase-start');
    </script>
</body>
</html>