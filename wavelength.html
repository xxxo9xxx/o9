<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
    <title>ウェーブレングス チーム戦</title>
    <style>
        :root{
            --zone-4-color:#03A9F4;
            --zone-3-color:#FF9800;
            --zone-2-color:#FFC107;
            --needle-color:#F44336;
            --text-color:#333;
            --dial-frame-color:#3D4A5E;
            --red-team-color:#FF5252;
            --blue-team-color:#2196F3;
            --red-team-bg:#FFEBEE;
            --blue-team-bg:#E3F2FD;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:16px;
            color:var(--text-color);
            transition: background-color 0.5s ease;
        }
        
        /* チーム背景色 */
        .red-team-turn { background-color: var(--red-team-bg); }
        .blue-team-turn { background-color: var(--blue-team-bg); }
        .neutral-bg { background-color: #F0F2F5; }

        .game-container{
            width:100%;
            max-width:520px;
            background:#fff;
            border-radius:16px;
            padding:20px;
            box-shadow:0 10px 30px rgba(0,0,0,0.08);
        }
        
        .header{text-align:center;margin-bottom:14px;border-bottom:1px solid #eee;padding-bottom:12px;}
        .title{font-size:1.6rem;color:var(--dial-frame-color)}
        
        /* スコアボード */
        .scoreboard{
            display:flex;
            justify-content:space-between;
            margin-bottom:16px;
            padding:12px;
            background:#f8f9fa;
            border-radius:10px;
        }
        
        .team-score{
            text-align:center;
            padding:8px 16px;
            border-radius:8px;
            font-weight:700;
            font-size:1.1rem;
        }
        
        .red-team-score{
            background:var(--red-team-bg);
            color:var(--red-team-color);
            border:2px solid var(--red-team-color);
        }
        
        .blue-team-score{
            background:var(--blue-team-bg);
            color:var(--blue-team-color);
            border:2px solid var(--blue-team-color);
        }
        
        .current-team{
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
            transform:scale(1.05);
        }

        .topic-display{background:#f8f9fa;border-radius:10px;padding:12px;margin-bottom:16px}
        .topic-text{display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:1.1rem}
        .phase-content{text-align:center}
        .phase-description{color:#666;margin-bottom:10px}
        
        .team-indicator{
            font-size:1.3rem;
            font-weight:800;
            margin-bottom:12px;
            padding:8px 16px;
            border-radius:8px;
            display:inline-block;
        }
        
        .red-team-indicator{
            background:var(--red-team-color);
            color:white;
        }
        
        .blue-team-indicator{
            background:var(--blue-team-color);
            color:white;
        }

        .btn{width:100%;padding:12px;border:none;border-radius:40px;background:linear-gradient(45deg,#2196F3,#03A9F4);color:white;font-weight:700;cursor:pointer;margin:8px 0;}
        .btn-secondary{background:linear-gradient(45deg,#673AB7,#9C27B0)}
        .btn-red{background:linear-gradient(45deg,#F44336,#FF5252)}
        .btn-blue{background:linear-gradient(45deg,#1976D2,#2196F3)}
        
        .vote-buttons{
            display:flex;
            gap:12px;
            margin:16px 0;
        }
        
        .vote-btn{
            flex:1;
            padding:16px;
            border:none;
            border-radius:12px;
            font-weight:700;
            font-size:1.1rem;
            cursor:pointer;
            transition:transform 0.2s ease;
        }
        
        .vote-btn:hover{
            transform:translateY(-2px);
        }
        
        .vote-left{
            background:linear-gradient(45deg,#9C27B0,#E91E63);
            color:white;
        }
        
        .vote-right{
            background:linear-gradient(45deg,#2196F3,#00BCD4);
            color:white;
        }
        
        .hidden{display:none}

        /* 半円ダイヤル */
        .wavelength-dial{
            position:relative;
            width:320px;
            max-width:100%;
            height:160px;
            margin:20px auto;
            border-top-left-radius:160px;
            border-top-right-radius:160px;
            background:#E0E5EC;
            border:8px solid var(--dial-frame-color);
            overflow:visible;
        }

        .wavelength-dial svg{
            position:absolute;
            left:0;
            top:0;
            width:100%;
            height:100%;
            overflow:visible;
        }

        /* 針 */
        .needle{
            position:absolute;
            left:50%;
            bottom:0;
            width:4px;
            height:140px;
            background:var(--needle-color);
            transform-origin:50% 100%;
            transform:translateX(-50%) rotate(0deg);
            box-shadow:0 0 10px rgba(0,0,0,0.18);
            z-index:6;
            border-radius:2px;
        }

        /* ノブ（赤い丸） */
        .knob{
            position:absolute;
            width:32px;
            height:32px;
            border-radius:50%;
            background:var(--needle-color);
            border:4px solid #fff;
            box-shadow:0 6px 14px rgba(0,0,0,0.15);
            transform:translate(-50%,-50%);
            z-index:7;
            touch-action:none;
            cursor:grab;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }
        
        .knob:hover{
            transform:translate(-50%,-50%) scale(1.05);
            box-shadow:0 8px 18px rgba(0,0,0,0.2);
        }
        
        .knob:active, .knob.dragging{
            cursor:grabbing;
            transform:translate(-50%,-50%) scale(1.1);
            box-shadow:0 10px 20px rgba(0,0,0,0.3);
        }

        .gauge-value{
            font-weight:700;
            margin:10px 0;
            font-size:1.2rem;
            color:var(--dial-frame-color);
        }
        
        .score-display{
            font-size:1.8rem;
            font-weight:800;
            margin-top:16px;
        }
        
        .result-summary{
            background:#f8f9fa;
            padding:16px;
            border-radius:10px;
            margin:16px 0;
        }

        .zone-legend{
            display:flex;
            justify-content:center;
            gap:20px;
            margin:15px 0;
            flex-wrap:wrap;
        }
        
        .zone-item{
            display:flex;
            align-items:center;
            gap:5px;
            font-size:0.9rem;
            font-weight:600;
        }
        
        .zone-color{
            width:20px;
            height:20px;
            border-radius:4px;
        }
        
        .instructions{
            background:#f8f9fa;
            padding:12px;
            border-radius:8px;
            margin:10px 0;
            font-size:0.95rem;
            color:#666;
        }
        
        .winner-announcement{
            font-size:2rem;
            font-weight:800;
            margin:20px 0;
            padding:20px;
            border-radius:12px;
            text-align:center;
        }
        
        .red-winner{
            background:var(--red-team-bg);
            color:var(--red-team-color);
            border:3px solid var(--red-team-color);
        }
        
        .blue-winner{
            background:var(--blue-team-bg);
            color:var(--blue-team-color);
            border:3px solid var(--blue-team-color);
        }
    </style>
</head>
<body class="neutral-bg">
    <div class="game-container">
        <div class="header">
            <div class="title">ウェーブレングス チーム戦</div>
        </div>

        <!-- スコアボード -->
        <div class="scoreboard" id="scoreboard">
            <div class="team-score red-team-score" id="redTeamScore">
                <div>赤チーム</div>
                <div>0点</div>
            </div>
            <div class="team-score blue-team-score" id="blueTeamScore">
                <div>青チーム</div>
                <div>0点</div>
            </div>
        </div>

        <div class="topic-display">
            <div class="topic-text" id="topicText"><span>-</span><span>⇔</span><span>-</span></div>
        </div>

        <!-- フェーズ1: ゲーム開始 -->
        <div class="game-phase" id="phase-start">
            <div class="phase-content">
                <p class="phase-description">新しいチーム戦を始めましょう</p>
                <div class="instructions">
                    11点先取で勝利！<br>
                    同点の場合はサドンデス戦
                </div>
                <button class="btn" onclick="startNewGame()">ゲーム開始</button>
            </div>
        </div>

        <!-- フェーズ2: ラウンド開始 -->
        <div class="game-phase hidden" id="phase-round-start">
            <div class="phase-content">
                <div class="team-indicator" id="currentTeamIndicator">赤チーム</div>
                <p class="phase-description">新しいラウンドを開始します</p>
                <button class="btn" id="roundStartBtn" onclick="startRound()">スタート</button>
            </div>
        </div>

        <!-- フェーズ3: お題表示 -->
        <div class="game-phase hidden" id="phase-topic">
            <div class="phase-content">
                <div class="team-indicator" id="topicTeamIndicator">赤チーム</div>
                <p class="phase-description">お題が決まりました</p>
                <button class="btn" onclick="goToHintPhase()">ヒント役へ</button>
            </div>
        </div>

        <!-- フェーズ4: ヒント出し役用（正解エリア表示）-->
        <div class="game-phase hidden" id="phase-psychic">
            <div class="phase-content">
                <div class="team-indicator" id="psychicTeamIndicator">赤チーム</div>
                <h3>ヒント出し役へ</h3>
                <p class="phase-description">この正解エリアを見て、口頭でヒントを出してください</p>
                
                <div class="wavelength-dial" id="psychic-dial">
                    <svg id="psychic-svg" viewBox="0 0 320 160" preserveAspectRatio="none" aria-hidden="true"></svg>
                </div>
                
                <div class="zone-legend">
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-4-color)"></div>
                        <span>4点</span>
                    </div>
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-3-color)"></div>
                        <span>3点</span>
                    </div>
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-2-color)"></div>
                        <span>2点</span>
                    </div>
                </div>
                
                <button class="btn" onclick="goToVotePhase()">推測フェーズへ</button>
            </div>
        </div>

        <!-- フェーズ5: 投票 -->
        <div class="game-phase hidden" id="phase-vote">
            <div class="phase-content">
                <div class="team-indicator" id="voteTeamIndicator">青チーム</div>
                <h3>右か左かを投票してください</h3>
                <p class="phase-description">ヒントを聞いて、答えが右寄りか左寄りかを予想</p>
                
                <div class="vote-buttons">
                    <button class="vote-btn vote-left" onclick="submitVote('left')">
                        <div id="leftLabel">左寄り</div>
                    </button>
                    <button class="vote-btn vote-right" onclick="submitVote('right')">
                        <div id="rightLabel">右寄り</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- フェーズ6: 推測（回答者）-->
        <div class="game-phase hidden" id="phase-guess">
            <div class="phase-content">
                <div class="team-indicator" id="guessTeamIndicator">赤チーム</div>
                <h3>正確な位置を推測してください</h3>
                <div class="instructions">
                    赤い丸をドラッグして、ヒントが示す位置を推測してください
                </div>

                <div class="wavelength-dial" id="guess-dial">
                    <svg id="guess-svg" viewBox="0 0 320 160" preserveAspectRatio="none" aria-hidden="true"></svg>
                    <div class="needle" id="needle"></div>
                    <div class="knob" id="knob" role="slider" aria-valuemin="0" aria-valuemax="100" tabindex="0"></div>
                </div>

                <div class="gauge-value">推測値: <span id="gaugeValue">50</span>%</div>
                <button class="btn" onclick="submitGuess()">これで決定！</button>
            </div>
        </div>

        <!-- フェーズ7: 結果 -->
        <div class="game-phase hidden" id="phase-result">
            <div class="phase-content">
                <h3>結果発表！</h3>

                <div class="wavelength-dial" id="result-dial">
                    <svg id="result-svg" viewBox="0 0 320 160" preserveAspectRatio="none" aria-hidden="true"></svg>
                    <div class="needle" id="result-needle"></div>
                </div>

                <div class="zone-legend">
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-4-color)"></div>
                        <span>4点</span>
                    </div>
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-3-color)"></div>
                        <span>3点</span>
                    </div>
                    <div class="zone-item">
                        <div class="zone-color" style="background-color:var(--zone-2-color)"></div>
                        <span>2点</span>
                    </div>
                </div>

                <div class="result-summary" id="resultSummary">
                    <div class="score-display" id="scoreDisplay">結果計算中...</div>
                </div>
                
                <button class="btn btn-secondary" id="nextRoundBtn" onclick="nextRound()">次のラウンド</button>
            </div>
        </div>

        <!-- フェーズ8: 勝敗決定 -->
        <div class="game-phase hidden" id="phase-game-over">
            <div class="phase-content">
                <div class="winner-announcement" id="winnerAnnouncement">
                    勝敗決定！
                </div>
                
                <div class="result-summary">
                    <div id="finalScores"></div>
                </div>
                
                <button class="btn" onclick="startNewGame()">新しいゲームを始める</button>
            </div>
        </div>
    </div>

    <script>
    // --- DOM ---
    const topicTextEl = document.getElementById('topicText');
    const gaugeValueEl = document.getElementById('gaugeValue');
    const scoreDisplayEl = document.getElementById('scoreDisplay');
    const redTeamScoreEl = document.getElementById('redTeamScore');
    const blueTeamScoreEl = document.getElementById('blueTeamScore');
    const resultSummaryEl = document.getElementById('resultSummary');

    const guessDial = document.getElementById('guess-dial');
    const guessSvg = document.getElementById('guess-svg');
    const psychicSvg = document.getElementById('psychic-svg');
    const resultSvg = document.getElementById('result-svg');

    const needleEl = document.getElementById('needle');
    const knobEl = document.getElementById('knob');
    const resultNeedleEl = document.getElementById('result-needle');

    // --- 状態 ---
    const gameState = {
        currentTeam: 'red', // 'red' or 'blue'
        firstTeam: 'red',   // 先行チーム
        redScore: 0,
        blueScore: 0,
        targetScore: 11,
        isSuddenDeath: false,
        roundCount: 0,
        
        topic: null,
        targetAngle: 0, // -90 .. +90
        guessAngle: 0,  // -90 .. +90
        vote: null,     // 'left' or 'right'
        roundScore: 0,
        voteScore: 0
    };

    const dialState = { isDragging: false };

    // 得点ゾーン設定（内側から外側へ）
    const scoreZones = [
        { points: 4, width: 8, color: '#03A9F4' }, // 水色（最も狭い）
        { points: 3, width: 20, color: '#FF9800' }, // オレンジ
        { points: 2, width: 32, color: '#FFC107' }  // 黄色（最も広い）
    ];

    const topics = [
        {left:"下手", right:"上手"}, {left:"アナログ", right:"デジタル"},
        {left:"無名", right:"有名"}, {left:"悪", right:"善"},
        {left:"ダサい", right:"おしゃれ"}, {left:"必須", right:"不要"},
        {left:"冷たい", right:"熱い"}, {left:"汚い", right:"きれい"},
        {left:"普通", right:"変わってる"}, {left:"軽犯罪", right:"重罪"},
        {left:"古い", right:"新しい"}, {left:"簡単", right:"難しい"},
        {left:"安い", right:"高い"}, {left:"暗い", right:"明るい"},
        {left:"遅い", right:"速い"}, {left:"小さい", right:"大きい"}
    ];

    // --- チーム管理 ---
    function updateTeamDisplay() {
        const isRed = gameState.currentTeam === 'red';
        document.body.className = isRed ? 'red-team-turn' : 'blue-team-turn';
        
        // スコアボード更新
        redTeamScoreEl.innerHTML = `<div>赤チーム</div><div>${gameState.redScore}点</div>`;
        blueTeamScoreEl.innerHTML = `<div>青チーム</div><div>${gameState.blueScore}点</div>`;
        
        // 現在のチームを強調
        redTeamScoreEl.classList.toggle('current-team', isRed);
        blueTeamScoreEl.classList.toggle('current-team', !isRed);
        
        // チーム表示更新
        const teamName = isRed ? '赤チーム' : '青チーム';
        document.querySelectorAll('.team-indicator').forEach(el => {
            el.textContent = teamName;
            el.className = isRed ? 'team-indicator red-team-indicator' : 'team-indicator blue-team-indicator';
        });
        
        // 投票相手チーム表示
        const voteTeamName = isRed ? '青チーム' : '赤チーム';
        const voteIndicator = document.getElementById('voteTeamIndicator');
        if (voteIndicator) {
            voteIndicator.textContent = voteTeamName;
            voteIndicator.className = isRed ? 'team-indicator blue-team-indicator' : 'team-indicator red-team-indicator';
        }
        
        // 投票ボタンのラベル更新
        if (gameState.topic) {
            document.getElementById('leftLabel').textContent = gameState.topic.left + '寄り';
            document.getElementById('rightLabel').textContent = gameState.topic.right + '寄り';
        }
    }

    function switchTeam() {
        gameState.currentTeam = gameState.currentTeam === 'red' ? 'blue' : 'red';
    }

    // --- フェーズ操作 ---
    function showPhase(phaseId){
        document.querySelectorAll('.game-phase').forEach(p => p.classList.add('hidden'));
        document.getElementById(phaseId).classList.remove('hidden');
    }

    function startNewGame(){
        // 初期化
        gameState.redScore = 0;
        gameState.blueScore = 0;
        gameState.roundCount = 0;
        gameState.isSuddenDeath = false;
        
        // 先行をランダム決定
        gameState.firstTeam = Math.random() < 0.5 ? 'red' : 'blue';
        gameState.currentTeam = gameState.firstTeam;
        
        updateTeamDisplay();
        document.body.className = 'neutral-bg';
        showPhase('phase-round-start');
    }

    function startRound(){
        // 新しいお題生成
        gameState.topic = topics[Math.floor(Math.random()*topics.length)];
        // -90度から+90度の範囲（0%〜100%をカバー）
        gameState.targetAngle = Math.random()*180 - 90;
        gameState.vote = null;
        gameState.roundScore = 0;
        gameState.voteScore = 0;

        topicTextEl.innerHTML = `<span>${gameState.topic.left}</span><span>⇔</span><span>${gameState.topic.right}</span>`;
        
        updateTeamDisplay();
        showPhase('phase-topic');
    }

    function goToHintPhase(){
        // 描画（心理役用）
        drawScoreZonesSVG(psychicSvg, gameState.targetAngle);
        updateTeamDisplay();
        showPhase('phase-psychic');
    }

    function goToVotePhase(){
        updateTeamDisplay();
        showPhase('phase-vote');
    }

    function submitVote(vote){
        gameState.vote = vote;
        goToGuessPhase();
    }

    function goToGuessPhase(){
        // Guess用ダイヤルは背景のみ（ゾーン非表示）
        drawScoreZonesSVG(guessSvg, null);
        
        gameState.guessAngle = 0;
        updateNeedle(needleEl, 0);
        updateGaugeValue(0);
        positionKnobByAngle(knobEl, guessDial, 0);

        updateTeamDisplay();
        showPhase('phase-guess');
    }

    function submitGuess(){
        // 得点計算
        calculateScores();

        // 表示更新
        showResults();

        // 結果ダイヤル（正解ゾーンを表示）
        drawScoreZonesSVG(resultSvg, gameState.targetAngle);
        updateNeedle(resultNeedleEl, gameState.guessAngle);

        showPhase('phase-result');
    }

    function calculateScores(){
        const diff = Math.abs(gameState.guessAngle - gameState.targetAngle);
        let mainScore = 0;
        
        // メインチームの得点計算（最も狭いゾーンから順にチェック）
        scoreZones.slice().sort((a,b)=>a.width - b.width).forEach(zone=>{
            if (diff <= zone.width/2){
                if (zone.points > mainScore) mainScore = zone.points;
            }
        });
        
        gameState.roundScore = mainScore;
        
        // 投票チームの得点計算 - 修正：正解エリアの位置で判定
        let voteScore = 0;
        if (gameState.vote) {
            // 正解エリア（targetAngle）が右寄りか左寄りかで判定
            const isTargetRight = gameState.targetAngle > 0;
            const voteRight = gameState.vote === 'right';
            
            if ((isTargetRight && voteRight) || (!isTargetRight && !voteRight)) {
                voteScore = 1; // 投票が当たった場合
            }
        }
        
        gameState.voteScore = voteScore;
        
        // スコア加算
        if (gameState.currentTeam === 'red') {
            gameState.redScore += mainScore;
            gameState.blueScore += voteScore;
        } else {
            gameState.blueScore += mainScore;
            gameState.redScore += voteScore;
        }
    }

    function showResults(){
        const mainTeamName = gameState.currentTeam === 'red' ? '赤チーム' : '青チーム';
        const voteTeamName = gameState.currentTeam === 'red' ? '青チーム' : '赤チーム';
        
        const voteResult = gameState.voteScore > 0 ? '正解！' : '不正解';
        const voteText = gameState.vote === 'left' ? gameState.topic.left + '寄り' : gameState.topic.right + '寄り';
        
        // 正解が実際にどちら寄りだったかを表示
        const actualSide = gameState.targetAngle > 0 ? gameState.topic.right + '寄り' : gameState.topic.left + '寄り';
        
        resultSummaryEl.innerHTML = `
            <div class="score-display">
                ${mainTeamName}: ${gameState.roundScore}点獲得！<br>
                ${voteTeamName}: ${voteText}に投票<br>
                正解は${actualSide} → ${voteResult} (+${gameState.voteScore}点)
            </div>
        `;
        
        updateTeamDisplay();
        
        // 次のボタン設定
        const nextBtn = document.getElementById('nextRoundBtn');
        if (checkGameEnd()) {
            nextBtn.textContent = '結果発表';
            nextBtn.onclick = () => showGameOver();
        } else {
            nextBtn.textContent = '次のラウンド';
            nextBtn.onclick = () => nextRound();
        }
    }

    function checkGameEnd(){
        const redWin = gameState.redScore >= gameState.targetScore;
        const blueWin = gameState.blueScore >= gameState.targetScore;
        
        if (gameState.isSuddenDeath) {
            // サドンデス中は両チームが1回ずつプレイした後に判定
            gameState.roundCount++;
            if (gameState.roundCount >= 2) {
                return gameState.redScore !== gameState.blueScore;
            }
        } else {
            if (redWin || blueWin) {
                if (gameState.redScore === gameState.blueScore) {
                    // 同点の場合はサドンデス
                    gameState.isSuddenDeath = true;
                    gameState.roundCount = 0;
                    return false;
                } else {
                    return true;
                }
            }
        }
        
        return false;
    }

    function nextRound(){
        if (gameState.isSuddenDeath && gameState.roundCount < 2) {
            // サドンデス中は相手チームの番
            switchTeam();
        } else {
            // 通常ラウンド：先行後攻を入れ替え
            switchTeam();
            gameState.firstTeam = gameState.currentTeam;
        }
        
        updateTeamDisplay();
        showPhase('phase-round-start');
    }

    function showGameOver(){
        const winner = gameState.redScore > gameState.blueScore ? 'red' : 'blue';
        const winnerName = winner === 'red' ? '赤チーム' : '青チーム';
        
        const winnerEl = document.getElementById('winnerAnnouncement');
        winnerEl.textContent = `🎉 ${winnerName} 勝利！ 🎉`;
        winnerEl.className = winner === 'red' ? 'winner-announcement red-winner' : 'winner-announcement blue-winner';
        
        document.getElementById('finalScores').innerHTML = `
            <div style="font-size:1.2rem; font-weight:700;">
                最終スコア<br>
                赤チーム: ${gameState.redScore}点<br>
                青チーム: ${gameState.blueScore}点
            </div>
        `;
        
        document.body.className = winner === 'red' ? 'red-team-turn' : 'blue-team-turn';
        showPhase('phase-game-over');
    }

    // --- SVG描画（3段階の扇形ゾーン） ---
    function drawScoreZonesSVG(svgEl, centerAngle){
        svgEl.innerHTML = '';
        if (centerAngle === null || centerAngle === undefined) {
            // 背景の半円のみ描画
            drawSemiCircleOutline(svgEl);
            return;
        }

        const W = 320, H = 160;
        const cx = W/2, cy = H;
        const r = W/2;

        // helper: 度->座標
        const degToPoint = (angleDeg) => {
            const rad = (angleDeg - 90) * Math.PI / 180;
            const x = cx + r * Math.cos(rad);
            const y = cy + r * Math.sin(rad);
            return {x,y};
        };

        // 外側から内側へ描画（大きいゾーンから小さいゾーンへ）
        scoreZones.slice().sort((a,b)=>b.width - a.width).forEach(zone=>{
            const half = zone.width/2;
            let start = Math.max(-90, centerAngle - half);
            let end   = Math.min(90, centerAngle + half);
            if (end <= start) return;

            const p1 = degToPoint(start);
            const p2 = degToPoint(end);

            const largeArc = (Math.abs(end - start) > 180) ? 1 : 0;
            const sweep = 1;

            const d = `M ${cx} ${cy} L ${p1.x} ${p1.y} A ${r} ${r} 0 ${largeArc} ${sweep} ${p2.x} ${p2.y} Z`;

            const path = document.createElementNS('http://www.w3.org/2000/svg','path');
            path.setAttribute('d', d);
            path.setAttribute('fill', zone.color);
            path.setAttribute('opacity', 0.9);
            svgEl.appendChild(path);
        });

        drawSemiCircleOutline(svgEl);
    }

    function drawSemiCircleOutline(svgEl) {
        const W = 320, H = 160;
        const r = W/2;
        const cx = W/2, cy = H;
        
        const outline = document.createElementNS('http://www.w3.org/2000/svg','path');
        const left = {x: 0, y: H};
        const right = {x: W, y: H};
        outline.setAttribute('d', `M ${left.x} ${left.y} A ${r} ${r} 0 0 1 ${right.x} ${right.y}`);
        outline.setAttribute('stroke','rgba(61,74,94,0.9)');
        outline.setAttribute('stroke-width','4');
        outline.setAttribute('fill','none');
        svgEl.appendChild(outline);
    }

    // --- 針・ゲージ更新 ---
    function updateNeedle(el, angle){
        if(!el) return;
        el.style.transform = `translateX(-50%) rotate(${angle}deg)`;
    }
    
    function updateGaugeValue(angle){
        const val = Math.round(((angle + 90) / 180) * 100);
        if (gaugeValueEl) gaugeValueEl.textContent = val;
    }

    // --- ノブを弧上に移動させる ---
    function positionKnobByAngle(knob, dialEl, angle){
        const W = 320, H = 160;
        const cx = W/2, cy = H, r = W/2;
        const rad = (angle - 90) * Math.PI / 180;
        const x = cx + r * Math.cos(rad);
        const y = cy + r * Math.sin(rad);
        
        const leftPct = (x / W) * 100;
        const topPct  = (y / H) * 100;
        knob.style.left = `${leftPct}%`;
        knob.style.top  = `${topPct}%`;
    }

    // --- 改良されたダイヤル操作 ---
    function handleDragStart(e){
        if (e.type === 'touchstart') e.preventDefault();
        dialState.isDragging = true;
        knobEl.classList.add('dragging');
    }

    function handleDragMove(e){
        if (!dialState.isDragging) return;
        if (e.type === 'touchmove') e.preventDefault();

        const dial = guessDial;
        const rect = dial.getBoundingClientRect();

        const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
        const clientY = (e.touches ? e.touches[0].clientY : e.clientY);

        // 半円の底辺中心を基点
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height;

        const dx = clientX - centerX;
        const dy = centerY - clientY;

        // 角度計算 - dyとdxを入れ替えて正しい向きに
        let angle = Math.atan2(dx, dy) * 180 / Math.PI;
        // -90..+90に制限
        angle = Math.max(-90, Math.min(90, angle));

        gameState.guessAngle = angle;
        updateNeedle(needleEl, angle);
        updateGaugeValue(angle);
        positionKnobByAngle(knobEl, dial, angle);
    }

    function handleDragEnd(e){
        dialState.isDragging = false;
        knobEl.classList.remove('dragging');
    }

    // キーボード操作（アクセシビリティ）
    knobEl.addEventListener('keydown', (e)=>{
        let delta = 0;
        if (e.key === 'ArrowLeft' || e.key === 'ArrowDown'){
            delta = -5;
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp'){
            delta = 5;
        } else return;
        
        gameState.guessAngle = Math.max(-90, Math.min(90, gameState.guessAngle + delta));
        updateNeedle(needleEl, gameState.guessAngle);
        updateGaugeValue(gameState.guessAngle);
        positionKnobByAngle(knobEl, guessDial, gameState.guessAngle);
        e.preventDefault();
    });

    // イベント登録
    knobEl.addEventListener('mousedown', handleDragStart);
    knobEl.addEventListener('touchstart', handleDragStart, {passive:false});
    window.addEventListener('mousemove', handleDragMove);
    window.addEventListener('touchmove', handleDragMove, {passive:false});
    window.addEventListener('mouseup', handleDragEnd);
    window.addEventListener('touchend', handleDragEnd);

    // ウィンドウリサイズ時にノブを再配置
    window.addEventListener('resize', ()=>{
        positionKnobByAngle(knobEl, guessDial, gameState.guessAngle);
    });

    // 初期表示
    showPhase('phase-start');
    </script>
</body>
</html>