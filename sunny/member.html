<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メンバートイロ・リアルタイム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap');
        body { font-family: 'Zen Maru Gothic', sans-serif; overflow-x: hidden; touch-action: manipulation; }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-active:active { transform: translateY(2px); border-bottom-width: 0; }
    </style>
</head>
<body class="bg-orange-50 min-h-screen p-4 text-slate-800">

    <div id="app" class="max-w-md mx-auto">
        <header class="text-center mb-8 pt-4">
            <h1 class="text-4xl font-black text-orange-600 italic tracking-tighter">メンバートイロ</h1>
            <p id="room-display" class="text-[10px] font-bold text-orange-400 uppercase tracking-widest mt-1"></p>
        </header>
        <div id="game-content"></div>
    </div>

    <script>
        // --- 1. Firebase初期設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBmzPmehSaV--mn0Hd0S-fd97nf5RX4Dvg",
            authDomain: "membertoiro.firebaseapp.com",
            databaseURL: "https://membertoiro-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "membertoiro",
            storageBucket: "membertoiro.firebasestorage.app",
            messagingSenderId: "858132874746",
            appId: "1:858132874746:web:9d6e1156a350dd396b9043"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ルームIDの取得（URLの ?room=xxx を読み取る）
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room') || 'default-room';
        const roomRef = db.ref("rooms/" + roomId);
        document.getElementById('room-display').innerText = "ID: " + roomId;

        // --- 2. お題データ (200個) ---
        const QUESTIONS = [
            {text: "一番、浮気しそうな人は？"}, {text: "一番、長生きしそうな人は？"}, {text: "一番、腹黒そうな人は？"}, {text: "一番、涙もろそうな人は？"}, {text: "一番、寂しがり屋な人は？"},
            {text: "一番、負けず嫌いな人は？"}, {text: "一番、天然ボケな人は？"}, {text: "一番、頑固そうな人は？"}, {text: "一番、ロマンチストな人は？"}, {text: "一番、ナルシストな人は？"},
            {text: "一番、隠し事が下手な人は？"}, {text: "一番、怒ったら怖そうな人は？"}, {text: "一番、聞き上手な人は？"}, {text: "一番、口が上手そうな人は？"}, {text: "一番、お人好しな人は？"},
            {text: "一番、毒舌そうな人は？"}, {text: "一番、慎重派な人は？"}, {text: "一番、楽観的な人は？"}, {text: "一番、プライドが高そうな人は？"}, {text: "一番、平和主義な人は？"},
            {text: "一番、こだわりが強そうな人は？"}, {text: "一番、マイペースな人は？"}, {text: "一番、ギャップが激しい人は？"}, {text: "一番、愛されキャラな人は？"}, {text: "一番、ミステリアスな人は？"},
            {text: "一番、嘘が下手そうな人は？"}, {text: "一番、実はお調子者な人は？"}, {text: "一番、度胸がありそうな人は？"}, {text: "一番、実はナイーブな人は？"}, {text: "一番、正義感が強そうな人は？"},
            {text: "一番、お喋りが止まらない人は？"}, {text: "一番、実は野心家な人は？"}, {text: "一番、包容力がありそうな人は？"}, {text: "一番、感受性が豊かな人は？"}, {text: "一番、ストイックそうな人は？"},
            {text: "一番、甘えん坊そうな人は？"}, {text: "一番、自由奔放そうな人は？"}, {text: "一番、客観的な視点を持つ人は？"}, {text: "一番、実は照れ屋な人は？"}, {text: "一番、裏表がなさそうな人は？"},
            {text: "一番、家が汚そうな人は？"}, {text: "一番、貯金が多そうな人は？"}, {text: "一番、料理が上手そうな人は？"}, {text: "一番、朝に弱そうな人は？"}, {text: "一番、返信が遅そうな人は？"},
            {text: "一番、お酒で失敗しそうな人は？"}, {text: "一番、ギャンブルにハマりそうな人は？"}, {text: "一番、無駄遣いが多そうな人は？"}, {text: "一番、方向音痴そうな人は？"}, {text: "一番、忘れ物が多そうな人は？"},
            {text: "一番、SNSに依存してそうな人は？"}, {text: "一番、寝坊が多そうな人は？"}, {text: "一番、ダイエットが続かなそうな人は？"}, {text: "一番、都会暮らしが似合う人は？"}, {text: "一番、田舎暮らしが似合う人は？"},
            {text: "一番、健康オタクそうな人は？"}, {text: "一番、多趣味そうな人は？"}, {text: "一番、流行に敏感な人は？"}, {text: "一番、占いにはまりそうな人は？"}, {text: "一番、字が綺麗そうな人は？"},
            {text: "一番、夜更かししてそうな人は？"}, {text: "一番、美意識が高そうな人は？"}, {text: "一番、コンビニ飯が多そうな人は？"}, {text: "一番、買い物で迷いそうな人は？"}, {text: "一番、整理整頓が苦手な人は？"},
            {text: "一番、家電に詳しそうな人は？"}, {text: "一番、私服がオシャレな人は？"}, {text: "一番、一人の時間が大事な人は？"}, {text: "一番、スマホの画面が割れてそうな人は？"}, {text: "一番、衝動買いをしそうな人は？"},
            {text: "一番、常に何かを食べてそうな人は？"}, {text: "一番、筋トレを始めてすぐ辞める人は？"}, {text: "一番、実はケチそうな人は？"}, {text: "一番、高級品が似合う人は？"}, {text: "一番、早寝早起きそうな人は？"},
            {text: "一番、鞄の中がグチャグチャな人は？"}, {text: "一番、歩くのが速そうな人は？"}, {text: "一番、傘をすぐ失くす人は？"}, {text: "一番、サウナにはまってそうな人は？"}, {text: "一番、自炊に凝ってそうな人は？"},
            {text: "一番、大物になりそうな人は？"}, {text: "一番、無人島で生き残りそうな人は？"}, {text: "一番、総理大臣に向いている人は？"}, {text: "一番、ハリウッドに居そうな人は？"}, {text: "一番、詐欺師に勝てそうな人は？"},
            {text: "一番、ゾンビ映画で生き残る人は？"}, {text: "一番、宝くじが当たりそうな人は？"}, {text: "一番、探偵に向いてそうな人は？"}, {text: "一番、悪役が似合いそうな人は？"}, {text: "一番、宇宙人と友達になれる人は？"},
            {text: "一番、IQが高そうな人は？"}, {text: "一番、前世が王様そうな人は？"}, {text: "一番、前世が猛獣そうな人は？"}, {text: "一番、ヒーローが似合う人は？"}, {text: "一番、交渉が上手そうな人は？"},
            {text: "一番、社長に向いてそうな人は？"}, {text: "一番、運だけで生きてそうな人は？"}, {text: "一番、革命を起こしそうな人は？"}, {text: "一番、天才肌な感じがする人は？"}, {text: "一番、直感で動いて成功する人は？"},
            {text: "一番、マルチタスクが得意そうな人は？"}, {text: "一番、プレゼンが上手そうな人は？"}, {text: "一番、暗記力が凄そうな人は？"}, {text: "一番、職人魂を持ってそうな人は？"}, {text: "一番、どこでも寝られる才能がある人は？"},
            {text: "一番、人の顔を覚えるのが早い人は？"}, {text: "一番、流行を作る側になりそうな人は？"}, {text: "一番、勝負強そうな人は？"}, {text: "一番、ピンチをチャンスに変える人は？"}, {text: "一番、一生現役で働きそうな人は？"},
            {text: "一番、別の国でも生きていけそうな人は？"}, {text: "一番、多言語を操りそうな人は？"}, {text: "一番、発明家に向いてそうな人は？"}, {text: "一番、カリスマ性がある人は？"}, {text: "一番、歴史に名を残しそうな人は？"},
            {text: "一番、裏方で世界を操ってそうな人は？"}, {text: "一番、先生に向いてそうな人は？"}, {text: "一番、芸術センスが爆発してそうな人は？"}, {text: "一番、コメンテーターに向いてそうな人は？"}, {text: "一番、どんな職業でも出世しそうな人は？"},
            {text: "一番、恋人に尽くしそうな人は？"}, {text: "一番、恋人の前でキャラが違う人は？"}, {text: "一番、告白のセリフがクサそうな人は？"}, {text: "一番、ダメ男・ダメ女にハマる人は？"}, {text: "一番、一目惚れしそうな人は？"},
            {text: "一番、嫉妬深そうな人は？"}, {text: "一番、モテ期が永遠に続く人は？"}, {text: "一番、婚期が早そうな人は？"}, {text: "一番、略奪愛しそうな人は？"}, {text: "一番、過去の恋を引きずる人は？"},
            {text: "一番、サプライズに失敗しそうな人は？"}, {text: "一番、子供に好かれそうな人は？"}, {text: "一番、合コンで無双しそうな人は？"}, {text: "一番、甘え上手そうな人は？"}, {text: "一番、実はMそうな人は？"},
            {text: "一番、実はSそうな人は？"}, {text: "一番、初対面で好印象を与える人は？"}, {text: "一番、誰とでも友達になれる人は？"}, {text: "一番、聞き上手でモテそうな人は？"}, {text: "一番、束縛しそうな人は？"},
            {text: "一番、デートプランが完璧そうな人は？"}, {text: "一番、恋に盲目になりそうな人は？"}, {text: "一番、友情を恋より優先する人は？"}, {text: "一番、マッチングアプリの達人そうな人は？"}, {text: "一番、復縁を迫られそうな人は？"},
            {text: "一番、結婚相手として100点な人は？"}, {text: "一番、義理堅そうな人は？"}, {text: "一番、親に紹介して安心な人は？"}, {text: "一番、亭主関白・かかあ天下そうな人は？"}, {text: "一番、別れても友達でいられそうな人は？"},
            {text: "一番、年上に可愛がられそうな人は？"}, {text: "一番、年下に慕われそうな人は？"}, {text: "一番、浮気がすぐバレそうな人は？"}, {text: "一番、愛妻家・愛夫家になりそうな人は？"}, {text: "一番、記念日を絶対忘れない人は？"},
            {text: "一番、駆け引きが上手そうな人は？"}, {text: "一番、自分から告白できない人は？"}, {text: "一番、失恋しても立ち直りが早い人は？"}, {text: "一番、運命を信じてそうな人は？"}, {text: "一番、恋の悩み相談を受けまくる人は？"},
            {text: "一番、酔うと語りそうな人は？"}, {text: "一番、酔うと泣きそうな人は？"}, {text: "一番、酔うと寝そうな人は？"}, {text: "一番、酔うと脱ぎそうな人は？"}, {text: "一番、マイクを離さなそうな人は？"},
            {text: "一番、奢ってくれそうな人は？"}, {text: "一番、幹事が上手そうな人は？"}, {text: "一番、明日仕事なのに飲む人は？"}, {text: "一番、飲み会に絶対居てほしい人は？"}, {text: "一番、酔っても顔に出ない人は？"},
            {text: "一番、カラオケの選曲が渋い人は？"}, {text: "一番、手品ができそうな人は？"}, {text: "一番、リアクションが一番大きい人は？"}, {text: "一番、二次会に絶対来る人は？"}, {text: "一番、最後まで正気な人は？"},
            {text: "一番、おつまみのチョイスが良い人は？"}, {text: "一番、盛り上げ隊長な人は？"}, {text: "一番、ダンスがキレキレそうな人は？"}, {text: "一番、実は下ネタに強い人は？"}, {text: "一番、強運の持ち主は？"},
            {text: "一番、都市伝説を信じてそうな人は？"}, {text: "一番、宝島を見つけそうな人は？"}, {text: "一番、猫と会話してそうな人は？"}, {text: "一番、実は霊感がありそうな人は？"}, {text: "一番、宇宙人でも驚かない人は？"},
            {text: "一番、無人島でもWi-Fiを探してそうな人は？"}, {text: "一番、タイムスリップしても馴染みそうな人は？"}, {text: "一番、実は一番腕っ節が強そうな人は？"}, {text: "一番、魔法少女・少年になれそうな人は？"}, {text: "一番、どんな服でも着こなしそうな人は？"},
            {text: "一番、謎が多い人は？"}, {text: "一番、実は一番のしっかり者は？"}, {text: "一番、実はお祭り男・お祭り女なのは？"}, {text: "一番、1人キャンプを楽しんでそうなのは？"}, {text: "一番、どんな動物とも仲良くなれそうなのは？"},
            {text: "一番、実は筋肉がありそうなのは？"}, {text: "一番、生涯幸せになりそうなのは？"}, {text: "一番、このゲームを一番楽しんでいる人は？"}, {text: "一番、この中で最も「トイロ」な人は？"}, {text: "一番、最後までみんなを笑わせる人は？"}
        ];

        // --- 3. 状態管理 ---
        let myName = localStorage.getItem("toiro-name") || "";
        let gameState = null;

        // DB監視
        roomRef.on("value", (snapshot) => {
            gameState = snapshot.val();
            render();
        });

        // --- 4. ゲームロジック ---
        function joinGame() {
            const input = document.getElementById('name-input');
            const name = input.value.trim();
            if (!name) return;

            roomRef.once('value').then(snapshot => {
                let data = snapshot.val() || { phase: 'setup', members: [], host: name };
                if (!data.members) data.members = [];
                if (!data.members.includes(name)) data.members.push(name);
                if (!data.host) data.host = name;

                roomRef.set(data).then(() => {
                    myName = name;
                    localStorage.setItem("toiro-name", name);
                    render();
                });
            });
        }

        function startGame() {
            if (!gameState || gameState.host !== myName) return;
            const selectedQs = [...QUESTIONS].sort(() => 0.5 - Math.random()).slice(0, gameState.members.length);
            roomRef.update({ 
                phase: 'playing', 
                questions: selectedQs, 
                currentQIdx: 0, 
                answers: {} 
            });
        }

        function submitAnswer(selection) {
            roomRef.child(`answers/${gameState.currentQIdx}/${myName}`).set(selection);
        }

        function nextStep() {
            if (gameState.host !== myName) return;
            if (gameState.revealQIdx < gameState.questions.length - 1) {
                roomRef.update({ phase: 'playing', currentQIdx: gameState.revealQIdx + 1 });
            } else {
                roomRef.update({ phase: 'result' });
            }
        }

        // --- 5. 描画処理 ---
        function render() {
            const container = document.getElementById('game-content');

            // ログイン画面
            if (!myName) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-3xl shadow-xl border-2 border-orange-100">
                        <p class="text-sm font-bold text-orange-400 mb-2">名前を入力してください</p>
                        <input id="name-input" type="text" class="w-full mb-4 border-2 border-orange-100 rounded-xl px-4 py-3 outline-none font-bold text-lg focus:border-orange-400">
                        <button onclick="joinGame()" class="w-full bg-orange-500 text-white h-14 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-all">参加する</button>
                    </div>`;
                return;
            }

            // データ待ち・再参加ボタン
            if (!gameState) {
                container.innerHTML = `
                    <div class="text-center p-10 bg-white rounded-3xl shadow-xl border-2 border-orange-100">
                        <p class="text-orange-500 font-bold mb-4">部屋を探しています...</p>
                        <button onclick="joinGame()" class="bg-orange-100 text-orange-600 px-6 py-2 rounded-full text-sm font-bold">この名前で入室する</button>
                    </div>`;
                return;
            }

            // 待機フェーズ
            if (gameState.phase === 'setup') {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-3xl shadow-xl mb-6">
                        <p class="text-center font-bold text-orange-600 mb-4 animate-pulse uppercase text-xs">Waiting for Members...</p>
                        <div class="card-grid">
                            ${(gameState.members || []).map(m => `<div class="bg-orange-50 p-3 rounded-xl text-center font-bold text-sm text-orange-700 border border-orange-100">${m} ${m === myName ? '✨' : ''}</div>`).join('')}
                        </div>
                    </div>
                    ${gameState.host === myName 
                        ? `<button onclick="startGame()" class="w-full bg-orange-600 text-white h-20 rounded-2xl text-xl font-black shadow-lg hover:bg-orange-700 active:scale-95 transition-all">ゲームを開始！</button>` 
                        : `<div class="p-6 bg-white rounded-2xl text-center border-2 border-dashed border-orange-200 text-slate-400">ホスト(${gameState.host})が開始するのを待っています...</div>`}
                    <button onclick="localStorage.clear(); location.reload();" class="w-full mt-8 text-[10px] text-slate-400 underline uppercase tracking-widest">別の名前で入り直す</button>
                `;
            } 
            
            // プレイフェーズ
            else if (gameState.phase === 'playing') {
                if (!gameState.questions || !gameState.questions[gameState.currentQIdx]) return;
                const q = gameState.questions[gameState.currentQIdx];
                const currentAns = (gameState.answers && gameState.answers[gameState.currentQIdx]) || {};
                const myAns = currentAns[myName];
                const count = Object.keys(currentAns).length;

                container.innerHTML = `
                    <div class="text-center mb-8 px-2">
                        <span class="bg-orange-200 text-orange-700 px-3 py-1 rounded-full text-[10px] font-bold">QUESTION ${gameState.currentQIdx + 1}</span>
                        <h2 class="text-2xl font-black mt-4 text-slate-800 leading-tight">${q.text}</h2>
                    </div>
                    ${myAns ? `
                        <div class="bg-white p-12 rounded-[2.5rem] text-center shadow-inner border-2 border-orange-50">
                            <p class="text-orange-500 font-black text-xl mb-2">回答送信済み！</p>
                            <p class="text-slate-400 text-xs font-bold">待機中 (${count} / ${gameState.members.length})</p>
                        </div>` : `
                        <div class="card-grid">
                            ${gameState.members.map(m => `<button onclick="submitAnswer('${m}')" class="h-20 rounded-2xl font-black text-lg bg-white border-b-4 border-orange-200 text-orange-600 active:border-b-0 active:translate-y-1 transition-all shadow-sm">${m}</button>`).join('')}
                        </div>`}
                `;
                if (gameState.host === myName && count === gameState.members.length) {
                    setTimeout(() => roomRef.update({ phase: 'revealing', revealQIdx: gameState.currentQIdx }), 1200);
                }
            } 
            
            // 発表フェーズ
            else if (gameState.phase === 'revealing') {
                const q = gameState.questions[gameState.revealQIdx];
                const ans = gameState.answers[gameState.revealQIdx];
                const counts = {};
                gameState.members.forEach(m => counts[m] = 0);
                Object.values(ans).forEach(v => counts[v]++);
                const max = Math.max(...Object.values(counts));
                const winners = Object.keys(counts).filter(m => counts[m] === max);

                container.innerHTML = `
                    <div class="text-center animate-bounce-short">
                        <p class="text-orange-400 font-bold text-xs mb-2">RESULT</p>
                        <h2 class="text-xl font-bold mb-6 text-slate-600">${q.text}</h2>
                        <div class="bg-white p-10 rounded-[3rem] shadow-2xl border-4 border-orange-500 mb-10">
                            <p class="text-xs font-bold text-slate-400 mb-2 uppercase">Most Voted</p>
                            <p class="text-5xl font-black text-orange-600">${winners.join(' & ')}</p>
                        </div>
                        ${gameState.host === myName 
                            ? `<button onclick="nextStep()" class="w-full bg-orange-600 text-white h-16 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-all">次へ進む ➔</button>` 
                            : `<p class="text-orange-300 font-bold animate-pulse italic">ホストの操作を待っています...</p>`}
                    </div>`;
            } 
            
            // 終了フェーズ
            else if (gameState.phase === 'result') {
                container.innerHTML = `
                    <div class="text-center py-10">
                        <h2 class="text-5xl font-black text-orange-600 mb-4 tracking-tighter italic">FINISH!</h2>
                        <p class="text-slate-500 font-bold mb-10">お疲れ様でした！</p>
                        ${gameState.host === myName 
                            ? `<button onclick="roomRef.remove(); localStorage.clear(); location.reload();" class="w-full bg-slate-800 text-white h-16 rounded-2xl font-bold shadow-xl">部屋を解散してTOPへ</button>` 
                            : `<div class="p-6 bg-white rounded-2xl text-slate-400 italic">ホストが部屋を解散するのを待っています...</div>`}
                    </div>`;
            }
        }
        render();
    </script>
</body>
</html>
