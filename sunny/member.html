<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ¡ãƒ¼ã‚¸ç›¸é–¢å›³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap');
        body { font-family: 'Zen Maru Gothic', sans-serif; touch-action: manipulation; }
        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .san { font-size: 0.55em; font-weight: normal; margin-left: 2px; color: #fb923c; vertical-align: baseline; }
    </style>
</head>
<body class="bg-orange-50 min-h-screen p-4 text-slate-800">

    <div id="app" class="max-w-md mx-auto text-center">
        <header class="mb-8 pt-4">
            <h1 class="text-3xl font-black text-orange-600 italic tracking-tighter leading-none">ã‚¤ãƒ¡ãƒ¼ã‚¸ç›¸é–¢å›³</h1>
            <p class="text-[9px] font-bold text-orange-400 mt-1 uppercase tracking-[0.2em]">ã€œã£ã½ã„äººãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã€œ</p>
            <p id="room-display" class="text-[8px] font-bold text-slate-300 mt-2 uppercase tracking-widest"></p>
        </header>
        
        <div id="game-content"></div>

        <div class="mt-20">
            <button onclick="leaveAndReset()" class="text-[10px] text-slate-300 underline uppercase tracking-widest">
                é€€å‡ºã—ã¦ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBmzPmehSaV--mn0Hd0S-fd97nf5RX4Dvg",
            authDomain: "membertoiro.firebaseapp.com",
            databaseURL: "https://membertoiro-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "membertoiro",
            storageBucket: "membertoiro.firebasestorage.app",
            messagingSenderId: "858132874746",
            appId: "1:858132874746:web:9d6e1156a350dd396b9043"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room') || 'party-room';
        const roomRef = db.ref("rooms/" + roomId);
        document.getElementById('room-display').innerText = "ROOM: " + roomId;

        const QUESTIONS = [
            {text: "ä¸€ç•ªã€æµ®æ°—ã—ãã†ãªé›°å›²æ°—ãŒã‚ã‚‹äºº"}, {text: "å®Ÿã¯ä¸€ç•ªã€è…¹é»’ãã†ãªã¨ã“ã‚ãŒã‚ã‚‹äºº"}, {text: "ä¸€ç•ªã€é•·ç”Ÿãã—ãã†ãªã‚¿ã‚¤ãƒ—ã®äºº"}, {text: "ä¸€ç•ªã€æ¶™ã‚‚ã‚ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€å¯‚ã—ãŒã‚Šå±‹ã£ã½ã„é›°å›²æ°—ã®äºº"},
            {text: "ä¸€ç•ªã€è² ã‘ãšå«Œã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å¤©ç„¶ãƒœã‚±ã£ã½ã„ä¸€é¢ãŒã‚ã‚‹äºº"}, {text: "ä¸€ç•ªã€é ‘å›ºãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€ãƒ­ãƒãƒ³ãƒã‚¹ãƒˆã£ã½ã„ã¨ã“ã‚ãŒã‚ã‚‹äºº"}, {text: "ä¸€ç•ªã€ãƒŠãƒ«ã‚·ã‚¹ãƒˆãªä¸€é¢ãŒã‚ã‚Šãã†ãªäºº"},
            {text: "ä¸€ç•ªã€ç§ç”Ÿæ´»ãŒè¬ã«åŒ…ã¾ã‚Œã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€è²¯é‡‘ãŒå¾—æ„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã«ãƒãƒã‚Šãã†ãªã‚¿ã‚¤ãƒ—ã®äºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯ãƒ¢ãƒ†ãã†ãªé›°å›²æ°—ã®äºº"}, {text: "ä¸€ç•ªã€æ€’ã‚‹ã¨æ€–ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"},
            {text: "ä¸€ç•ªã€ãŠé…’ã‚’é£²ã‚€ã¨å¤‰ã‚ã‚Šãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ–™ç†ãŒä¸Šæ‰‹ãã†ãªé›°å›²æ°—ã®äºº"}, {text: "ä¸€ç•ªã€ç‰‡ä»˜ã‘ãŒè‹¦æ‰‹ãã†ãªäºº"}, {text: "ä¸€ç•ªã€é‹ãŒè‰¯ã•ãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ—©èµ·ããŒè‹¦æ‰‹ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€æµè¡Œã«è©³ã—ãã†ãªäºº"}, {text: "ä¸€ç•ªã€é‹å‹•ç¥çµŒãŒè‰¯ã•ãã†ãªäºº"}, {text: "ä¸€ç•ªã€èª­æ›¸ã‚’ã—ã¦ã„ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€ã‚ãŒã¾ã¾ã‚’è¨€ã„ãã†ãªã‚¿ã‚¤ãƒ—ã®äºº"}, {text: "ä¸€ç•ªã€å„ªæŸ”ä¸æ–­ãã†ãªã¨ã“ã‚ãŒã‚ã‚‹äºº"},
            {text: "ä¸€ç•ªã€å®Ÿã¯ç”˜ãˆã‚“åŠãã†ãªäºº"}, {text: "ä¸€ç•ªã€å˜˜ã‚’ã¤ãã®ãŒä¸‹æ‰‹ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å°†æ¥å¤§ç‰©ã«ãªã‚Šãã†ãªé›°å›²æ°—ã®äºº"}, {text: "ä¸€ç•ªã€å­ä¾›ã£ã½ã•ãŒæ®‹ã£ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å†·é™æ²ˆç€ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€é ¼ã‚Šã«ãªã‚Šãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€ãŠåŒ–ã‘å±‹æ•·ãŒè‹¦æ‰‹ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ä¸€åº¦å¯ãŸã‚‰èµ·ããªã•ãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ­ŒãŒä¸Šæ‰‹ãã†ãªé›°å›²æ°—ã®äºº"}, {text: "ä¸€ç•ªã€å¿˜ã‚Œç‰©ãŒå¤šãã†ãªã‚¿ã‚¤ãƒ—ã®äºº"},
            {text: "ä¸€ç•ªã€å®Ÿã¯ãƒ­ãƒãƒ³ãƒãƒƒã‚¯ãªå¤¢ã‚’è¦‹ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ã‚µãƒ—ãƒ©ã‚¤ã‚ºã‚’ä¼ç”»ã—ã¦ãã‚Œãã†ãªäºº"}, {text: "ä¸€ç•ªã€é‡‘é£ã„ãŒè’ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€è‡ªåˆ†ã«å³ã—ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ä»–äººã«å„ªã—ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€æœã®æº–å‚™ã«æ™‚é–“ãŒã‹ã‹ã‚Šãã†ãªäºº"}, {text: "ä¸€ç•ªã€ã‚¹ãƒãƒ›ã‚’ãšã£ã¨è§¦ã£ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯ã‚ªã‚¿ã‚¯æ°—è³ªãŒã‚ã‚Šãã†ãªäºº"}, {text: "ä¸€ç•ªã€å‹•ç‰©ã«å¥½ã‹ã‚Œãã†ãªé›°å›²æ°—ã®äºº"}, {text: "ä¸€ç•ªã€æ–¹å‘éŸ³ç—´ã£ã½ã„ã¨ã“ã‚ãŒã‚ã‚‹äºº"},
            {text: "ä¸€ç•ªã€SNSã®è¿”ä¿¡ãŒæ—©ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ã“ã ã‚ã‚ŠãŒå¼·ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€ã„ã¤ã‚‚ãŠè…¹ãŒç©ºã„ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯æ­Œã£ã¦è¸Šã‚Œãã†ãªäºº"}, {text: "ä¸€ç•ªã€ä¸€äººæ—…ãŒå¥½ããã†ãªäºº"},
            {text: "ä¸€ç•ªã€ç§˜å¯†ã‚’å®ˆã£ã¦ãã‚Œãã†ãªäºº"}, {text: "ä¸€ç•ªã€åˆå¯¾é¢ã§ç·Šå¼µã—ã¦ãã†ãªäºº"}, {text: "ä¸€ç•ªã€æœã®ã‚»ãƒ³ã‚¹ãŒç‹¬ç‰¹ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ç¬‘ã„ã®ãƒ„ãƒœãŒæµ…ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯æ¶™ã‚’éš ã—ã¦ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€æƒé™¤ãŒå¥½ããã†ãªã‚¿ã‚¤ãƒ—ã®äºº"}, {text: "ä¸€ç•ªã€è‡ªåˆ†ã‚’ã—ã£ã‹ã‚ŠæŒã£ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€èãä¸Šæ‰‹ãã†ãªäºº"}, {text: "ä¸€ç•ªã€è©±ã—ä¸Šæ‰‹ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯æ€–ãŒã‚Šãã†ãªä¸€é¢ãŒã‚ã‚‹äºº"},
            {text: "ä¸€ç•ªã€è¨˜æ†¶åŠ›ãŒè‰¯ã•ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å¥åº·ã«æ°—ã‚’ä½¿ã£ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ˜ ç”»ã§æ³£ã„ã¦ã„ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€æ–™ç†ã‚’ã“ã ã‚ã‚Šãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ©Ÿæ¢°ã«è©³ã—ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€å­—ãŒç¶ºéº—ãã†ãªäºº"}, {text: "ä¸€ç•ªã€éƒ¨å±‹ãŒãŠæ´’è½ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ä¸€ç›®æƒšã‚Œã—ãã†ãªã‚¿ã‚¤ãƒ—ã®äºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯å¯‚ã—ã•ã«å¼±ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ãƒ¡ãƒ³ã‚¿ãƒ«ãŒå¼·ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€é›†ä¸­åŠ›ãŒå‡„ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€ãŠè“å­ã‚’å¸¸ã«æŒã£ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ç„¡äººå³¶ã§ã‚‚ç”Ÿãæ®‹ã‚Œãã†ãªäºº"}, {text: "ä¸€ç•ªã€ä»•äº‹ãŒæ—©ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å¯è¨€ã‚’è¨€ã£ã¦ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€ç¾å®¹ã«è©³ã—ãã†ãªé›°å›²æ°—ã®äºº"}, {text: "ä¸€ç•ªã€ãŠç¥­ã‚Šé¨’ããŒå¥½ããã†ãªäºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯å«‰å¦¬æ·±ãã†ãªä¸€é¢ãŒã‚ã‚‹äºº"}, {text: "ä¸€ç•ªã€ã„ã¤ã‚‚å†·é™ãªåˆ¤æ–­ã‚’ã—ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ„›ã•ã‚Œã‚­ãƒ£ãƒ©ã£ã½ã„äºº"},
            {text: "ä¸€ç•ªã€ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ãªé›°å›²æ°—ãŒã‚ã‚‹äºº"}, {text: "ä¸€ç•ªã€é¢å€’è¦‹ãŒè‰¯ã•ãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ•™ãˆæ–¹ãŒä¸Šæ‰‹ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å†—è«‡ãŒé€šã˜ãªã•ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€å¤šè¶£å‘³ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€ãšã£ã¨å–‹ã£ã¦ã„ãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€ã‚µãƒ—ãƒ©ã‚¤ã‚ºã«å¼±ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ãŠä¸–è¾ãŒä¸‹æ‰‹ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯åŠªåŠ›å®¶ãã†ãªäºº"}, {text: "ä¸€ç•ªã€ä½•äº‹ã‚‚åŠ¹ç‡é‡è¦–ã—ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€æµè¡Œã«æµã•ã‚Œãªã•ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å¤é¢¨ãªè€ƒãˆã‚’æŒã£ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å¤¢ã‚’è¿½ã„ç¶šã‘ã¦ã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€èª°ã¨ã§ã‚‚ä»²è‰¯ããªã‚Œãã†ãªäºº"}, {text: "ä¸€ç•ªã€ç¬¬ä¸€å°è±¡ãŒè‰¯ã•ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€æ„å¤–ãªã‚®ãƒ£ãƒƒãƒ—ãŒã‚ã‚Šãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ­£ç¾©æ„ŸãŒå¼·ãã†ãªäºº"}, {text: "ä¸€ç•ªã€æ…é‡æ´¾ã£ã½ã„ã‚¿ã‚¤ãƒ—ã®äºº"}, {text: "ä¸€ç•ªã€è¡Œå‹•åŠ›ãŒã‚ã‚Šãã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€æ„Ÿæ€§ãŒè±Šã‹ãã†ãªäºº"},
            {text: "ä¸€ç•ªã€ã„ã„è¦ªã«ãªã‚Šãã†ãªé›°å›²æ°—ã®äºº"}, {text: "ä¸€ç•ªã€ãšã£ã¨è‹¥ã€…ã—ãã„ãã†ãªäºº"}, {text: "ä¸€ç•ªã€å®Ÿã¯ä¸å™¨ç”¨ãã†ãªã¨ã“ã‚ãŒã‚ã‚‹äºº"}, {text: "ä¸€ç•ªã€å¹³å’Œä¸»ç¾©ã£ã½ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®äºº"}, {text: "ä¸€ç•ªã€èŠ¯ãŒå¼·ãã†ãªäºº"}
            // ãŠé¡Œã¯ã“ã“ã«è¿½åŠ å¯èƒ½ã§ã™
        ];

        let myName = localStorage.getItem("toiro-name") || "";
        let myRole = localStorage.getItem("toiro-role") || ""; 
        let gameState = null;

        roomRef.on("value", (snapshot) => {
            gameState = snapshot.val();
            render();
        });

        function leaveAndReset() {
            if (myName && gameState && gameState.members) {
                const newMembers = gameState.members.filter(m => m !== myName);
                if (newMembers.length === 0) roomRef.remove();
                else {
                    let updateData = { members: newMembers };
                    if (myRole === 'host') updateData.host = "";
                    roomRef.update(updateData);
                }
            }
            localStorage.clear();
            location.reload();
        }

        function joinGame(role) {
            const name = document.getElementById('name-input')?.value.trim();
            if (!name) return;
            myName = name;
            myRole = role;
            localStorage.setItem("toiro-name", name);
            localStorage.setItem("toiro-role", role);
            roomRef.transaction((currentData) => {
                if (currentData === null) {
                    return { phase: 'setup', members: [name], host: (role === 'host' ? name : "") };
                } else {
                    if (role === 'host' && currentData.host) return;
                    if (!currentData.members) currentData.members = [];
                    if (!currentData.members.includes(name)) currentData.members.push(name);
                    if (role === 'host') currentData.host = name;
                    return currentData;
                }
            });
        }

        function startGame() {
            const shuffled = [...QUESTIONS].sort(() => 0.5 - Math.random());
            roomRef.set({
                phase: 'playing',
                members: gameState.members,
                host: gameState.host,
                questions: shuffled.slice(0, gameState.members.length),
                currentQIdx: 0,
                answers: {},
                revealIdx: 0
            });
        }

        function submitAnswer(selection) {
            const targetQIdx = gameState.currentQIdx;
            roomRef.child(`answers/${targetQIdx}/${myName}`).set(selection).then(() => {
                roomRef.transaction((currentData) => {
                    if (!currentData) return currentData;
                    const answersForThisQ = (currentData.answers && currentData.answers[targetQIdx]) || {};
                    const isAllAnswered = Object.keys(answersForThisQ).length === currentData.members.length;
                    if (currentData.phase === 'playing' && currentData.currentQIdx === targetQIdx && isAllAnswered) {
                        if (targetQIdx < currentData.questions.length - 1) {
                            currentData.currentQIdx = targetQIdx + 1;
                        } else {
                            currentData.phase = 'pre-reveal';
                        }
                    }
                    return currentData;
                });
            });
        }

        function startReveal() { roomRef.update({ phase: 'revealing', revealIdx: 0 }); }
        function nextReveal() {
            if (gameState.revealIdx < gameState.questions.length - 1) {
                roomRef.update({ revealIdx: gameState.revealIdx + 1 });
            } else { roomRef.update({ phase: 'result' }); }
        }

        const getGroupRankInfo = (rate) => {
            if (rate === 100) return { title: "å¥‡è·¡ã®ãƒãƒ¼ãƒ ", desc: "100%ä¸€è‡´ï¼ã‚‚ã¯ã‚„è¨€è‘‰ã¯ä¸è¦ã€‚ä¸€ã¤ã®ç”Ÿå‘½ä½“ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚" };
            if (rate >= 80) return { title: "ã‹ãªã‚Šã®ä»²è‰¯ã—ã‚°ãƒ«ãƒ¼ãƒ—", desc: "äº’ã„ã®å€‹æ€§ã‚’å®Œç’§ã«æŠŠæ¡ã—ã¦ã„ã‚‹ã€æœ€é«˜ã®ä»²é–“ãŸã¡ã€‚" };
            if (rate >= 60) return { title: "ä»¥å¿ƒä¼å¿ƒã‚°ãƒ«ãƒ¼ãƒ—", desc: "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯æŠœç¾¤ï¼å®‰å®šã—ãŸä¿¡é ¼é–¢ä¿‚ãŒè¦‹ãˆã¾ã™ã€‚" };
            if (rate >= 40) return { title: "ã“ã‚Œã‹ã‚‰ä»²è‰¯ããªã‚Œãã†ãªé–¢ä¿‚", desc: "ãŠäº’ã„ã®æ„å¤–ãªä¸€é¢ãŒè¦‹ãˆã¦ããŸã€ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹æ®µéšï¼" };
            if (rate >= 20) return { title: "ä¼¸ã³ã—ã‚ã‚ã‚Šã‚ã‚Šé›†å›£", desc: "å€‹æ€§ãŒå¤§çˆ†ç™ºä¸­ï¼ã“ã‚Œã‹ã‚‰ã‚‚ã£ã¨æ·±ãçŸ¥ã£ã¦ã„ã‘ãã†ã€‚" };
            return { title: "å­¤é«˜ã®å€‹äººä¸»ç¾©ãƒãƒ¼ãƒ ", desc: "å…¨å“¡ãŒå”¯ä¸€ç„¡äºŒã€‚äºˆæ¸¬ä¸èƒ½ãªé¢ç™½ã•ã‚’æŒã¤é›†å›£ã§ã™ï¼" };
        };

        function render() {
            const container = document.getElementById('game-content');
            if (!myName) {
                const hostTaken = !!(gameState && gameState.host);
                container.innerHTML = `<div class="bg-white p-6 rounded-3xl shadow-xl fade-in"><input id="name-input" type="text" placeholder="åå‰ã‚’å…¥åŠ›" class="w-full mb-6 border-2 p-3 rounded-xl font-bold text-center outline-none focus:border-orange-500"><div class="flex flex-col gap-3"><button onclick="joinGame('host')" ${hostTaken ? 'disabled' : ''} class="w-full ${hostTaken ? 'bg-gray-200 text-gray-400' : 'bg-orange-600 text-white'} h-14 rounded-xl font-bold">${hostTaken ? 'ãƒ›ã‚¹ãƒˆ (æº€å“¡)' : 'ãƒ›ã‚¹ãƒˆã¨ã—ã¦å‚åŠ '}</button><button onclick="joinGame('guest')" class="w-full bg-white border-2 border-orange-500 text-orange-600 h-14 rounded-xl font-bold">ã‚²ã‚¹ãƒˆã¨ã—ã¦å‚åŠ </button></div></div>`;
                return;
            }

            if (!gameState || gameState.phase === 'setup') {
                const members = (gameState && gameState.members) || [myName];
                container.innerHTML = `<div class="bg-white p-6 rounded-3xl shadow-xl mb-6 fade-in text-center"><div class="mb-4"><span class="text-orange-600 font-black text-xl">${myName}<small class="san">ã•ã‚“</small>ã¨ã—ã¦å¾…æ©Ÿä¸­...</span><br><span class="text-[10px] bg-orange-100 text-orange-500 px-3 py-1 rounded-full font-bold uppercase mt-2 inline-block">å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ (${members.length}å)</span></div><div class="card-grid">${members.map(m => `<div class="bg-orange-50 p-3 rounded-xl font-bold text-orange-700 text-sm">ğŸ‘¤ ${m}<small class="san">ã•ã‚“</small></div>`).join('')}</div></div>${myRole === 'host' ? `<button onclick="startGame()" class="w-full bg-orange-600 text-white h-16 rounded-2xl text-xl font-bold shadow-lg">ã‚²ãƒ¼ãƒ é–‹å§‹</button>` : `<div class="p-6 text-orange-300 italic font-bold animate-pulse text-sm text-center font-bold">ãƒ›ã‚¹ãƒˆãŒé–‹å§‹ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>`}`;
                return;
            }

            if (gameState.phase === 'playing') {
                const q = gameState.questions[gameState.currentQIdx];
                const currentAns = (gameState.answers && gameState.answers[gameState.currentQIdx]) || {};
                const myExcludes = [];
                for (let i = 0; i < gameState.currentQIdx; i++) { if (gameState.answers[i] && gameState.answers[i][myName]) myExcludes.push(gameState.answers[i][myName]); }
                container.innerHTML = `<div class="mb-6 fade-in"><span class="text-[10px] bg-orange-200 text-orange-700 px-2 py-1 rounded font-bold uppercase tracking-widest">Question ${gameState.currentQIdx + 1}</span><h2 class="text-2xl font-black text-slate-800 mt-2">${q.text}</h2></div>${currentAns[myName] ? `<div class="p-10 text-orange-500 font-bold animate-pulse">å›ç­”å®Œäº†ï¼å¾…æ©Ÿä¸­...<br><span class="text-xs text-slate-400">(${Object.keys(currentAns).length}/${gameState.members.length}äººãŒå®Œäº†)</span></div>` : `<div class="card-grid fade-in">${gameState.members.map(m => { const isUsed = myExcludes.includes(m); return `<button onclick="submitAnswer('${m}')" ${isUsed ? 'disabled' : ''} class="h-16 rounded-2xl font-black border-b-4 transition-all ${isUsed ? 'bg-gray-100 text-gray-300 border-gray-200 cursor-not-allowed' : 'bg-white border-orange-200 text-orange-600 shadow-sm'}">${m}<small class="san">ã•ã‚“</small></button>`; }).join('')}</div>`}`;
            }

            else if (gameState.phase === 'pre-reveal') {
                container.innerHTML = `<div class="bg-white p-8 rounded-3xl shadow-xl fade-in text-center"><h2 class="text-xl font-bold text-slate-700 mb-2">ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°å®Œäº†ï¼</h2><p class="text-sm text-slate-400 mb-8 font-bold text-center w-full uppercase tracking-tighter">ã¿ã‚“ãªã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒæƒã„ã¾ã—ãŸã€‚<br>çµæœã‚’ç™ºè¡¨ã—ã¾ã™ã‹ï¼Ÿ</p>${myRole === 'host' ? `<button onclick="startReveal()" class="w-full bg-orange-600 text-white h-16 rounded-2xl text-xl font-bold shadow-lg">çµæœã‚’è¦‹ã‚‹</button>` : `<p class="text-orange-300 font-bold animate-pulse text-sm text-center w-full font-bold">ãƒ›ã‚¹ãƒˆãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>`}</div>`;
            }

            else if (gameState.phase === 'revealing') {
                const q = gameState.questions[gameState.revealIdx];
                const ans = (gameState.answers && gameState.answers[gameState.revealIdx]) || {};
                const counts = {};
                gameState.members.forEach(m => counts[m] = 0);
                Object.values(ans).forEach(v => counts[v]++);
                const sortedCounts = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                const max = Math.max(...Object.values(counts));
                const winners = Object.keys(counts).filter(m => counts[m] === max);
                container.innerHTML = `<div class="fade-in"><p class="text-orange-400 font-bold text-[10px] mb-2 uppercase tracking-widest">Image Result ${gameState.revealIdx + 1}</p><h2 class="text-xl font-bold mb-6 text-slate-600 px-4">${q.text}</h2><div class="bg-white p-10 rounded-[3rem] shadow-xl border-4 border-orange-500 mb-6"><p class="text-3xl font-black text-orange-600">${winners.map(w => w + '<small class="san">ã•ã‚“</small>').join(' & ')}</p><p class="text-[10px] text-orange-300 font-bold mt-2 uppercase tracking-widest">â€” Most Voted (${max} votes) â€”</p></div><div class="bg-white/60 rounded-2xl p-4 mb-8 text-left"><p class="text-[9px] font-bold text-orange-400 mb-2 text-center uppercase tracking-widest">Vote Ranking</p>${sortedCounts.map(([name, count]) => `<div class="flex justify-between items-center py-1 border-b border-orange-100 last:border-0"><span class="text-xs font-bold text-slate-600">${name}<small class="san">ã•ã‚“</small></span><span class="text-xs font-black text-orange-500">${count}ç¥¨</span></div>`).join('')}</div>${myRole === 'host' ? `<button onclick="nextReveal()" class="w-full bg-orange-600 text-white h-16 rounded-2xl font-bold shadow-lg">æ¬¡ã¸</button>` : `<p class="text-orange-300 font-bold animate-pulse text-sm text-center w-full font-bold">ãƒ›ã‚¹ãƒˆã®æ“ä½œå¾…ã¡...</p>`}</div>`;
            }

            else if (gameState.phase === 'result') {
                const members = gameState.members;
                const history = gameState.answers || {};
                const pairScores = {};
                let totalMatches = 0;
                const numQ = gameState.questions.length;
                const possiblePairs = (members.length * (members.length - 1)) / 2;
                for(let i=0; i<members.length; i++) {
                    for(let j=i+1; j<members.length; j++) {
                        const p = `${members[i]}<small class="san">ã•ã‚“</small> & ${members[j]}<small class="san">ã•ã‚“</small>`;
                        pairScores[p] = 0;
                        Object.values(history).forEach(ans => { if (ans[members[i]] === ans[members[j]]) { pairScores[p]++; totalMatches++; } });
                    }
                }
                const syncRate = Math.round((totalMatches / (possiblePairs * numQ)) * 100) || 0;
                const maxScore = Math.max(...Object.values(pairScores)) || 0;
                const bestPairs = Object.entries(pairScores).filter(([_, s]) => s === maxScore).map(([p]) => p);
                const rank = getGroupRankInfo(syncRate);
                container.innerHTML = `<div class="fade-in text-center px-2"><div class="mb-4"><h2 class="text-2xl font-black text-orange-600">${myName}<small class="san text-lg">ã•ã‚“</small></h2></div><p class="text-[10px] font-bold text-orange-400 uppercase mb-1">Group Sync Rate</p><h2 class="text-7xl font-black text-orange-600 italic mb-2">${syncRate}<small class="text-3xl">%</small></h2><div class="mb-10 bg-white p-6 rounded-[2.5rem] shadow-sm border border-orange-100"><div class="inline-block bg-orange-600 text-white px-6 py-1 rounded-full font-black text-lg mb-2 shadow-md">${rank.title}</div><p class="text-xs text-slate-500 italic px-4 leading-relaxed">${rank.desc}</p></div><div class="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-[2.5rem] shadow-xl text-center mb-8 text-white relative overflow-hidden"><p class="text-[10px] font-bold mb-3 uppercase tracking-widest opacity-90 border-b border-orange-300 inline-block pb-1">Best Partner</p><h3 class="text-xl font-black mb-1 leading-tight">${bestPairs.join('<br>')}</h3><p class="text-orange-100 text-[10px] font-bold">ä¸€è‡´æ•°: ${maxScore}å›</p></div><div class="flex flex-col gap-3 pb-10">${myRole === 'host' ? `<button onclick="startGame()" class="w-full bg-slate-800 text-white h-16 rounded-2xl font-bold shadow-xl">åŒã˜ãƒ¡ãƒ³ãƒãƒ¼ã§ãƒªãƒˆãƒ©ã‚¤</button>` : `<p class="text-orange-300 font-bold animate-pulse italic text-sm text-center">ãƒ›ã‚¹ãƒˆã®ãƒªãƒˆãƒ©ã‚¤ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>`}<button onclick="leaveAndReset()" class="w-full bg-white text-slate-400 border-2 border-slate-200 h-14 rounded-2xl font-bold">é€€å‡ºã™ã‚‹</button></div></div>`;
            }
        }
        render();
    </script>
</body>
</html>
